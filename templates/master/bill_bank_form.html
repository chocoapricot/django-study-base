{% extends 'common/_base.html' %}
{% load static %}
{% load help_tags %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header">{{ title }}</div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row mb-3 align-items-center">
                <label for="{{ form.name.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">銀行名</label>
                <div class="col-sm-4">
                    {{ form.name }}
                    {% if form.name.errors %}
                        <div class="text-danger small">{{ form.name.errors.0 }}</div>
                    {% endif %}
                </div>
                <label for="{{ form.bank_code.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">
                    銀行コード
                    {% my_help_preset "bank_code" %}
                </label>
                <div class="col-sm-4">
                    {{ form.bank_code }}
                    {% if form.bank_code.errors %}
                        <div class="text-danger small">{{ form.bank_code.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.branch_name.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">支店名</label>
                <div class="col-sm-4">
                    {{ form.branch_name }}
                    {% if form.branch_name.errors %}
                        <div class="text-danger small">{{ form.branch_name.errors.0 }}</div>
                    {% endif %}
                </div>
                <label for="{{ form.branch_code.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">
                    支店コード
                    {% my_help_preset "branch_code" %}
                </label>
                <div class="col-sm-4">
                    {{ form.branch_code }}
                    {% if form.branch_code.errors %}
                        <div class="text-danger small">{{ form.branch_code.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.account_type.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">口座種別</label>
                <div class="col-sm-3">
                    {{ form.account_type }}
                    {% if form.account_type.errors %}
                        <div class="text-danger small">{{ form.account_type.errors.0 }}</div>
                    {% endif %}
                </div>
                <label for="{{ form.account_number.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">
                    口座番号
                    {% my_help_preset "account_number" %}
                </label>
                <div class="col-sm-5">
                    {{ form.account_number }}
                    {% if form.account_number.errors %}
                        <div class="text-danger small">{{ form.account_number.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.account_holder.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">口座名義</label>
                <div class="col-sm-10">
                    {{ form.account_holder }}
                    {% if form.account_holder.errors %}
                        <div class="text-danger small">{{ form.account_holder.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.account_holder_kana.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">口座名義（カナ）</label>
                <div class="col-sm-10">
                    {{ form.account_holder_kana }}
                    {% if form.account_holder_kana.errors %}
                        <div class="text-danger small">{{ form.account_holder_kana.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.display_order.id_for_label }}" class="col-sm-2 col-form-label text-start text-md-end">表示順</label>
                <div class="col-sm-3">
                    {{ form.display_order }}
                    {% if form.display_order.errors %}
                        <div class="text-danger small">{{ form.display_order.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <div class="col-sm-2"></div>
                <div class="col-sm-10">
                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            有効
                        </label>
                        {% if form.is_active.errors %}
                            <div class="text-danger small">{{ form.is_active.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col text-left">
                    <button type="submit" class="btn btn-sm btn-primary me-2">保存</button>
                    <a href="{% url 'master:bill_bank_list' %}" class="btn btn-sm btn-secondary">戻る</a>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
    }
    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }
    .autocomplete-items div:hover {
        background-color: #e9e9e9;
    }
    .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ツールチップを有効化
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const bankNameInput = document.getElementById('{{ form.name.id_for_label }}');
    const bankCodeInput = document.getElementById('{{ form.bank_code.id_for_label }}');
    const branchNameInput = document.getElementById('{{ form.branch_name.id_for_label }}');
    const branchCodeInput = document.getElementById('{{ form.branch_code.id_for_label }}');

    function setupAutocomplete(input, url_callback, on_select) {
        let currentFocus;
        input.addEventListener("input", function(e) {
            let a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false; }
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);

            const url = url_callback();
            if (!url) return;

            fetch(`${url}?q=${val}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        b = document.createElement("DIV");
                        b.innerHTML = `<strong>${item.name}</strong> (${item.bank_code || item.branch_code})`;
                        b.addEventListener("click", function(e) {
                            on_select(item);
                            closeAllLists();
                        });
                        a.appendChild(b);
                    });
                });
        });

        function closeAllLists(elmnt) {
            var x = document.getElementsByClassName("autocomplete-items");
            for (var i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != input) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    setupAutocomplete(
        bankNameInput,
        () => '/api/search_banks/',
        (item) => {
            bankNameInput.value = item.name;
            bankCodeInput.value = item.bank_code;
        }
    );

    setupAutocomplete(
        branchNameInput,
        () => {
            const bankCode = bankCodeInput.value;
            if (bankCode) {
                return `/api/search_bank_branches/?bank_code=${bankCode}`;
            }
            return null;
        },
        (item) => {
            branchNameInput.value = item.name;
            branchCodeInput.value = item.branch_code;
        }
    );

    bankCodeInput.addEventListener('change', function() {
        const code = this.value;
        if (code.length === 4) {
            fetch(`/api/search_banks/?q=${code}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        bankNameInput.value = data[0].name;
                    }
                });
        }
    });

    branchCodeInput.addEventListener('change', function() {
        const bankCode = bankCodeInput.value;
        const branchCode = this.value;
        if (bankCode.length === 4 && branchCode.length === 3) {
            fetch(`/api/search_bank_branches/?bank_code=${bankCode}&q=${branchCode}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        branchNameInput.value = data[0].name;
                    }
                });
        }
    });
});
</script>
{% endblock %}