{% extends 'common/_base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .step-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background-color: var(--bs-primary);
        color: white;
        border-radius: 50%;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header">
        {{ title }}
    </div>
    <div class="card-body">

        <!-- Step 1 -->
        <div class="mb-4">
            <h5 class="fw-bold mb-3 d-flex align-items-center">
                <span class="step-badge">1</span>現在有効な等級一覧のダウンロード
            </h5>
            <div class="ps-4">
                <p class="small text-muted mb-2">
                    現在登録されている有効な等級データをCSV形式でダウンロードします。
                </p>
                <a href="{% url 'master:grade_export' %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download me-1"></i>等級データをダウンロード
                </a>
            </div>
        </div>

        <hr class="my-4 text-muted opacity-25">

        <!-- Step 2 -->
        <div class="mb-4">
            <h5 class="fw-bold mb-3 d-flex align-items-center">
                <span class="step-badge">2</span>CSVデータの修正
            </h5>
            <div class="ps-4">
                <p class="small text-muted mb-2">
                    ダウンロードしたCSVファイル、または新規作成したCSVファイルを修正してください。<br>
                    文字コードは <strong>シフトJIS</strong> を使用してください。
                </p>
                <div class="card bg-white border-dark mb-3">
                    <div class="card-header py-2">
                        CSVフォーマット
                    </div>
                    <div class="card-body py-2">
                        <ul class="small mb-2">
                            <li><strong>1列目:</strong> 有効期間開始日 (必須, YYYY/MM/DD)</li>
                            <li><strong>2列目:</strong> コード (必須)</li>
                            <li><strong>3列目:</strong> 名称 (必須)</li>
                            <li><strong>4列目:</strong> 給与種別 (必須, 「時給」「日給」「月給」のいずれか)</li>
                            <li><strong>5列目:</strong> 金額 (必須, 半角数字)</li>
                        </ul>
                        <p class="small text-danger mb-0">※同じコードが登録済みで、開始日時点で有効なデータがある場合は、期間が重ならないように既存データの終了日を開始日の前日に設定してから取り込みをします。</p>
                    </div>
                </div>
                <p class="small text-muted mb-1"><strong>サンプル:</strong></p>
                <pre class="small bg-white p-2 border mb-0"><code>2024/01/01,G01,一般スタッフA,時給,1200
2024/04/01,G02,一般スタッフB,時給,1300
2024/01/01,M01,管理職A,月給,300000</code></pre>
            </div>
        </div>

        <hr class="my-4 text-muted opacity-25">

        <!-- Step 3 -->
        <div class="mb-4">
            <h5 class="fw-bold mb-3 d-flex align-items-center">
                <span class="step-badge">3</span>CSVファイルの取り込み
            </h5>
            <div class="ps-4">
                <form id="import-form" method="post" enctype="multipart/form-data" class="form-horizontal">
                    {% csrf_token %}

                    <div class="mb-3 row">
                        <label for="{{ form.csv_file.id_for_label }}" class="col-sm-2 col-form-label">{{ form.csv_file.label }}</label>
                        <div class="col-sm-9">
                            {{ form.csv_file }}
                            <div class="form-text">{{ form.csv_file.help_text }}</div>
                            {% if form.csv_file.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.csv_file.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn btn-sm btn-primary">取込を実行</button>
                        <a href="{% url 'master:grade_list' %}" class="btn btn-sm btn-secondary">戻る</a>
                    </div>
                </form>

                <div id="progress-container" class="mt-4" style="display: none;">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div id="progress-text" class="mt-1 small"></div>
                        <div id="elapsed-time" class="mt-1 small"></div>
                        <div id="estimated-time" class="mt-1 small"></div>
                    </div>
                </div>

                <div id="result-container" class="mt-4"></div>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('import-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const fileInput = form.querySelector('input[type="file"]');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const elapsedTimeEl = document.getElementById('elapsed-time');
        const estimatedTimeEl = document.getElementById('estimated-time');
        const resultContainer = document.getElementById('result-container');

        if (!fileInput.files || fileInput.files.length === 0) {
            resultContainer.innerHTML = '<div class="alert alert-danger">ファイルを選択してください。</div>';
            return;
        }

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        progressText.textContent = '';
        elapsedTimeEl.textContent = '';
        estimatedTimeEl.textContent = '';
        resultContainer.innerHTML = '';

        let taskId;

        // 1. ファイルをアップロード
        fetch("{% url 'master:grade_import_upload' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            taskId = data.task_id;
            progressText.textContent = 'アップロード完了。処理を開始します...';

            // 2. 処理を開始
            fetch(`/master/grade/import/process/${taskId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            // 3. 進捗のポーリングを開始
            const interval = setInterval(() => {
                fetch(`/master/grade/import/progress/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    function formatTime(seconds) {
                        if (typeof seconds !== 'number' || seconds < 0) {
                            return '00:00:00';
                        }
                        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                        const s = Math.floor(seconds % 60).toString().padStart(2, '0');
                        return `${h}:${m}:${s}`;
                    }

                    if (data.total > 0) {
                        const percentage = Math.round((data.progress / data.total) * 100);
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', percentage);
                        progressText.textContent = `進捗: ${data.progress.toLocaleString()} / ${data.total.toLocaleString()}件 (${percentage}%)`;
                    }

                    elapsedTimeEl.textContent = `経過時間: ${formatTime(data.elapsed_time_seconds)}`;
                    estimatedTimeEl.textContent = `予想残り時間: ${formatTime(data.estimated_time_remaining_seconds)}`;

                    if (data.status === 'completed' || data.status === 'failed') {
                        clearInterval(interval);
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            let resultMessage = '';
                            if (data.status === 'completed') {
                                resultMessage = `<div class="alert alert-success">インポートが完了しました。${data.imported_count}件のデータが処理されました。</div>`;
                            } else {
                                resultMessage = `<div class="alert alert-danger">インポート中にエラーが発生しました。</div>`;
                            }

                            if (data.errors && data.errors.length > 0) {
                                resultMessage += '<h5>エラー詳細:</h5><ul>';
                                data.errors.forEach(error => {
                                    const li = document.createElement('li');
                                    li.textContent = error;
                                    resultMessage += li.outerHTML;
                                });
                                resultMessage += '</ul>';
                            }
                            resultContainer.innerHTML = resultMessage;
                        }, 500);
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    progressContainer.style.display = 'none';
                    resultContainer.innerHTML = `<div class="alert alert-danger">進捗の取得中にエラーが発生しました: ${error.message}</div>`;
                });
            }, 2000);
        })
        .catch(error => {
            progressContainer.style.display = 'none';
            resultContainer.innerHTML = `<div class="alert alert-danger">エラーが発生しました: ${error.message}</div>`;
        });
    });
});
</script>
{% endblock %}
