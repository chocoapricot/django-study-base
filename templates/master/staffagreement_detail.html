{% extends 'common/_base.html' %}
{% load static %}

{% block title %}スタッフ同意文言詳細{% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        スタッフ同意文言詳細
    </div>
    <div class="card-body mb-0">
        <div class="row">
            <label class="col-sm-2 col-form-label text-start text-md-end"><strong>名称</strong></label>
            <div class="col-sm-10">
                <p class="form-control-plaintext">{{ agreement.name }}</p>
            </div>
        </div>

        <div class="row">
            <label class="col-sm-2 col-form-label text-start text-md-end"><strong>文言</strong></label>
            <div class="col-sm-10">
                <p class="form-control-plaintext" style="white-space: pre-wrap;">{{ agreement.agreement_text }}</p>
            </div>
        </div>

        <div class="row">
            <label class="col-sm-2 col-form-label text-start text-md-end"><strong>状態</strong></label>
            <div class="col-sm-10">
                <p class="form-control-plaintext">
                    {% if agreement.is_active %}
                        <span class="badge bg-success">有効</span>
                    {% else %}
                        <span class="badge bg-secondary">無効</span>
                    {% endif %}
                </p>
            </div>
        </div>
        <a href="{% url 'master:staff_agreement_update' agreement.pk %}" class="btn btn-sm btn-primary">編集</a>
        <a href="{% url 'master:staff_agreement_delete' agreement.pk %}" class="btn btn-sm btn-dark">削除</a>
        <a href="{% url 'master:staff_agreement_list' %}" class="btn btn-sm btn-secondary">戻る</a>

    </div>
</div>

<!-- 同意済みスタッフ一覧 -->
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">同意済みスタッフ一覧</h5>
    </div>
    <div class="card-body">
        <form method="get" action="" class="form-inline d-flex flex-wrap mb-3">
            <div class="input-group me-2 mb-2" style="width: 25em;">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm" placeholder="氏名、メールアドレスで検索">
                <span class="input-group-text" style="cursor: pointer;" onclick="document.querySelector('input[name=q]').value = '';">
                    <i class="bi bi-x"></i>
                </span>
            </div>
            <div class="btn-group me-2 mb-2" role="group">
                <button class="btn btn-primary btn-sm" type="submit">検索</button>
                <button type="button" class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportData('csv')"><i class="bi bi-filetype-csv"></i> CSV出力</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportData('excel')"><i class="bi bi-file-earmark-excel"></i> Excel出力</a></li>
                </ul>
            </div>
            <button class="btn btn-secondary btn-sm mb-2" type="button" onclick="resetForm()">リセット</button>
        </form>

        <script>
            function resetForm() {
                window.location.href = "{% url 'master:staff_agreement_detail' agreement.pk %}";
            }

            function exportData(format) {
                const message = format === 'csv' ? 'CSV形式でデータを出力しますか？' : 'Excel形式でデータを出力しますか？';
                if (confirm(message)) {
                    const params = new URLSearchParams(window.location.search);
                    params.set('format', format);
                    const exportUrl = "{% url 'master:agreed_staff_export' agreement.pk %}" + '?' + params.toString();
                    window.location.href = exportUrl;
                }
            }
        </script>

        <div class="table-responsive mt-3">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>
                            <a href="?sort=staff__name&dir={% if sort_by == 'staff__name' %}{{ opposite_dir }}{% else %}asc{% endif %}&q={{ query }}" class="no-link-style">
                                氏名
                                {% if sort_by == 'staff__name' %}<i class="bi bi-arrow-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=staff__email&dir={% if sort_by == 'staff__email' %}{{ opposite_dir }}{% else %}asc{% endif %}&q={{ query }}" class="no-link-style">
                                メールアドレス
                                {% if sort_by == 'staff__email' %}<i class="bi bi-arrow-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                        <th>
                            <a href="?sort=agreed_at&dir={% if sort_by == 'agreed_at' %}{{ opposite_dir }}{% else %}asc{% endif %}&q={{ query }}" class="no-link-style">
                                同意日時
                                {% if sort_by == 'agreed_at' %}<i class="bi bi-arrow-{% if sort_dir == 'asc' %}up{% else %}down{% endif %}"></i>{% endif %}
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for agreed_staff in agreed_staff_list %}
                    <tr>
                        <td>{{ agreed_staff.staff.name }}</td>
                        <td><a href="{% url 'staff:staff_detail' agreed_staff.staff.pk %}">{{ agreed_staff.staff.email }}</a></td>
                        <td>{{ agreed_staff.agreed_at|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center">同意したスタッフはいません。</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 変更履歴一覧 -->
{% if history_url_name %}
{% url history_url_name as history_url %}
{% with change_logs=change_logs change_logs_count=change_logs_count history_url=history_url show_full_content=False %}
    {% include 'common/_change_history_list.html' %}
{% endwith %}
{% endif %}

<style>
    .no-link-style {
        color: inherit;
        text-decoration: none;
    }
    .no-link-style:hover {
        color: inherit;
        text-decoration: underline;
    }
</style>
{% endblock %}