{% extends 'common/_base.html' %}
{% load static %}
{% load humanize %}
{% load dropdowns %}
{% load badge_tags %}
{% load parameters %}
{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .cropper-container-wrapper {
        width: 100%;
        max-height: 400px;
        min-height: 200px;
        background-color: #f7f7f7;
        margin-top: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }
</style>
{% endblock %}
{% block content %}

<div class="row" style="max-width: 100%;">

    <!-- 左上 -->
    <div class="col-8">
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                スタッフ基本情報
                <ul class="nav nav-pills">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="padding-top: 0.25em; padding-bottom: 0.25em;" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">その他情報</a>
                        <div class="dropdown-menu">
                            <a href="{% url 'staff:staff_mynumber_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-credit-card"></i>　マイナンバー
                            </a>
                            <a href="{% url 'staff:staff_contact_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-person-rolodex"></i>　その他連絡先
                            </a>
                            <a href="{% url 'staff:staff_bank_detail' staff_id=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-bank"></i>　銀行情報
                            </a>
                            <a href="{% url 'staff:staff_international_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-send"></i>　外国籍情報
                            </a>
                            <a href="{% url 'staff:staff_disability_detail' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-heart"></i>　障害者情報
                            </a>
                            {% if has_payroll %}
                            <a href="{% url 'staff:staff_payroll_detail' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-cash-stack"></i>　給与関連
                            </a>
                            {% else %}
                            <a href="{% url 'staff:staff_payroll_create' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-cash-stack"></i>　給与関連
                            </a>
                            {% endif %}
                            <div class="dropdown-divider"></div>
                            <a href="{% url 'staff:staff_tag_edit' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-tags"></i>　タグ編集
                            </a>
                            <a href="{% url 'staff:staff_flag_list' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-flag"></i>　フラッグ編集
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="padding-top: 0.25em; padding-bottom: 0.25em;" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">印刷</a>
                        <div class="dropdown-menu">
                            <a href="{% url 'staff:staff_rirekisho' staff.pk %}" class="dropdown-item"><i class="bi bi-file-excel"></i>　履歴書　(Excel)</a>
                            <a href="{% url 'staff:staff_kyushoku' staff.pk %}" class="dropdown-item"><i class="bi bi-file-excel"></i>　求職申込書　(Excel)</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                    {% csrf_token %}
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 d-flex justify-content-center align-items-center">
                            <div class="face-photo-container {% if staff.has_face_photo %}{% if staff_face_photo_style == 'round' %}rounded-circle{% elif staff_face_photo_style == 'rounded-square' %}rounded{% elif staff_face_photo_style == 'square' %}rounded-0{% endif %}{% else %}rounded-circle{% endif %}" {% if staff.has_face_photo %}data-bs-toggle="modal" data-bs-target="#viewFaceModal" style="cursor: pointer;"{% endif %}>
                                {% if staff.has_face_photo %}
                                    <img src="{% url 'staff:staff_face' staff.pk %}?v={% now "U" %}" class="img-fluid {% if staff_face_photo_style == 'round' %}rounded-circle{% elif staff_face_photo_style == 'rounded-square' %}rounded{% elif staff_face_photo_style == 'square' %}rounded-0{% endif %}" width="100" height="100" >
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center text-white rounded-circle"
                                         style="width:100px;height:100px;background-color:{{ staff.avatar_color }};font-size:36px;">
                                        {{ staff.initials }}
                                    </div>
                                {% endif %}
                                <div class="face-photo-overlay d-flex gap-1">
                                    {% if perms.staff.change_staff %}
                                    <a href="#" onclick="event.stopPropagation();" data-bs-toggle="modal" data-bs-target="#uploadFaceModal" class="btn btn-sm btn-primary" title="登録/変更"><i class="bi bi-upload"></i></a>
                                    {% if staff.has_face_photo %}
                                    <a href="#" onclick="event.stopPropagation();" data-bs-toggle="modal" data-bs-target="#deleteFaceModal" class="btn btn-sm btn-dark" title="削除"><i class="bi bi-trash"></i></a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-sm">
                            <div class="col-sm mb-2 d-flex align-items-center">
                                {% if staff.regist_status %}
                                    <span class="badge bg-primary" style="font-size:12px">{{ staff.regist_status.name }}</span>
                                {% endif %}
                                {% if staff.employment_type %}
                                    <span class="badge {{ staff.employment_type.display_order|badge_class }} ms-2" style="font-size:15px">{{ staff.employment_type.name }}</span>
                                {% endif %}
                                　
                                {% if staff.get_employment_status == "在職中" %}
                                    <span class="badge bg-success">{{ staff.get_employment_status }}</span>　{{ staff.hire_date|date:"Y/m/d" }}入社
                                {% elif staff.get_employment_status == "退職済み" %}
                                    <span class="badge bg-secondary">{{ staff.get_employment_status }}</span>　{{ staff.resignation_date|date:"Y/m/d" }}退職
                                {% elif staff.get_employment_status == "入社前" %}
                                    <span class="badge bg-warning">{{ staff.get_employment_status }}</span>　{{ staff.hire_date|date:"Y/m/d" }}入社
                                {% else %}
                                    <span class="badge bg-light text-dark">{{ staff.get_employment_status }}</span>
                                {% endif %}

                            </div>
                            <h4>
                                <ruby>
                                    {{ staff.name_last }}<rt>{{ staff.name_kana_last }}</rt>
                                </ruby>
                                <ruby>
                                    {{ staff.name_first }}<rt>{{ staff.name_kana_first }}</rt>
                                </ruby>
                                {% if staff.sex == 1 %}
                                    <span class="badge bg-info" style="font-size:12px">{% my_name 'sex' staff.sex%}</span>
                                {% else %}
                                    <span class="badge bg-primary" style="font-size:12px">{% my_name 'sex' staff.sex%}</span>
                                {% endif %}
                                {% if staff.employee_no %}
                                    <span style="font-size:18px">　No.
                                        <span class="copy-target" style="font-size:18px">{{ staff.employee_no }}</span>
                                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                                        <span class="copy-message">コピーしました!</span>
                                    </span>
                                {% endif %}
                                {% if staff.has_mynumber %}
                                <a href="{% url 'staff:staff_mynumber_detail' staff.pk %}" class="btn btn-sm btn-primary ms-2" title="マイナンバー">
                                    <i class="bi bi-credit-card"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_bank %}
                                <a href="{% url 'staff:staff_bank_detail' staff_id=staff.pk %}" class="btn btn-sm btn-info ms-1" title="銀行情報">
                                    <i class="bi bi-bank"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_contact %}
                                <a href="{% url 'staff:staff_contact_detail' staff.pk %}" class="btn btn-sm btn-warning ms-1" title="その他連絡先">
                                    <i class="bi bi-person-rolodex"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_international %}
                                <a href="{% url 'staff:staff_international_detail' staff.pk %}" class="btn btn-sm btn-info ms-1" title="外国籍情報">
                                    <i class="bi bi-send"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_disability %}
                                <a href="{% url 'staff:staff_disability_detail' staff_pk=staff.pk %}" class="btn btn-sm btn-warning ms-1" title="障害者情報">
                                    <i class="bi bi-heart"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_payroll %}
                                <a href="{% url 'staff:staff_payroll_detail' staff_pk=staff.pk %}" class="btn btn-sm btn-success ms-1" title="給与関連">
                                    <i class="bi bi-cash-stack"></i>
                                </a>
                                {% endif %}
                            </h4>
                            <div class="mt-1 mb-2">
                                {% for tag in staff.tags.all %}
                                    <span class="badge rounded-pill {{ tag.display_order|badge_class }} me-1">
                                        <i class="bi bi-tag-fill me-1"></i>{{ tag.name }}
                                    </span>
                                {% endfor %}
                                {% for flag in staff.flags.all %}
                                    <span class="badge rounded-pill {{ flag.flag_status.display_order|badge_class }} me-1">
                                        <i class="bi bi-flag-fill me-1"></i>{{ flag.flag_status.name }}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>生年月日</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.birth_date }}（<span id="age-display">{{ staff.age }}</span>歳）
                        </div>
                    </div>
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>所属部署</strong>
                        </div>
                        <div class="col-sm">
                            {% if staff.department_code %}
                                {{ staff.get_current_department_name }}
                                <span class="text-muted">({{ staff.department_code }})</span>
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3 align-items-top">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>住所</strong>
                        </div>
                        <div class="col-sm">
                            〒 {{ staff.postal_code }}<br/>
                            {{ staff.address1 }}
                            {{ staff.address2 }}<br/>
                            {{ staff.address3 }}
                            {% parameter 'GOOGLE_MAPS_URL_BASE' as map_url_base %}
                            {% if staff.full_address and map_url_base %}
                            <a href="{{ map_url_base }}{{ staff.full_address|urlencode }}" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;" aria-label="Googleマップで開く">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>電話</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.phone }}
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>Email</strong>
                        </div>
                        <div class="col-sm">
                            <span class="copy-target">{{ staff.email }}</span>
                            {% if connect_request and connect_request.is_approved %}
                                <a href="{% url 'staff:staff_inquiry_create_for_staff' staff.pk %}" class="btn btn-sm btn-outline-primary ms-2" title="メッセージ連絡">
                                    <i class="bi bi-chat-left-text"></i>
                                </a>
                            {% endif %}
                            {% if staff.email %}
                                <a href="{% url 'staff:staff_mail_send' staff.pk %}" class="btn btn-sm btn-outline-primary ms-2" title="メール送信">
                                    <i class="bi bi-envelope"></i>
                                </a>
                            {% endif %}
                            <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                            <span class="copy-message">コピーしました!</span>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>メモ</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.memo|default:"-" }}
                        </div>
                    </div>

                    <div class="row mb-2 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>資格</strong>
                        </div>
                        <div class="col-sm">
                            {% if qualifications %}
                                {% for q in qualifications %}
                                    <span class="badge bg-info">{{ q.qualification.name }}{% if q.score %} {{ q.score }}{% endif %}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_qualification_list' staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="row mb-2 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>技能</strong>
                        </div>
                        <div class="col-sm">
                            {% if skills %}
                                {% for s in skills %}
                                    <span class="badge bg-success">{{ s.skill.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_skill_list' staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-sm-end">
                            <strong>ファイル</strong>
                        </div>
                        <div class="col-sm">
                            {% if files %}
                                {% for f in files %}
                                    <span class="badge bg-warning">
                                        {% if f.is_image %}
                                            <i class="bi bi-image"></i>
                                        {% elif f.is_document %}
                                            <i class="bi bi-file-text"></i>
                                        {% else %}
                                            <i class="bi bi-file"></i>
                                        {% endif %}
                                        <a href="{% url 'staff:staff_file_download' pk=f.pk %}" class="text-white text-decoration-none">{{ f.original_filename|truncatechars:20 }}</a>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_file_list' staff_pk=staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="d-flex justify-content-start">
                        {% if perms.staff.change_staff %}
                        <a href="{% url 'staff:staff_update' staff.pk %}" class="btn btn-sm btn-primary me-2">編集</a>
                        {% endif %}
                        {% if perms.staff.delete_staff %}
                        <a href="{% url 'staff:staff_delete' staff.pk %}" class="btn btn-sm btn-dark me-2">削除</a>
                        {% endif %}
                        <a href="{% url 'staff:staff_list' %}" class="btn btn-sm btn-secondary me-2">戻る</a>
                    </div>
            </div>
        </div>
    </div>
    <!-- 左上 -->

    <div class="col">
        <!--右上1-->
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                状況
            </div>
            <div class="card-body">
                {% if staff.email %}
                <form method="post">
                    {% csrf_token %}
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="connectRequestSwitch"
                                       {% if connect_request %}checked{% endif %}
                                       onchange="this.form.submit()">
                                <input type="hidden" name="toggle_connect_request" value="1">
                                <label class="form-check-label" for="connectRequestSwitch">
                                    <i class="bi bi-link" style="font-size: 20px;color:#17a2b8;"></i>
                                    スタッフに接続依頼
                                    {% if connect_request %}
                                        <span class="text-muted small">（{{ connect_request.created_at|date:"Y/m/d H:i:s" }}）</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="row mb-3 align-items-center">
                    <div class="col-sm-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="connectApprovalSwitch"
                                   {% if connect_request and connect_request.is_approved %}checked{% endif %} disabled>
                            <label class="form-check-label" for="connectApprovalSwitch">
                                {% if mynumber_request or profile_request or international_request %}
                                    <i class="bi bi-arrow-down-circle" style="font-size: 20px; color:#17a2b8;" title="申請あり"></i>
                                {% else %}
                                    <i class="bi bi-link" style="font-size: 20px;color:#17a2b8;"></i>
                                {% endif %}
                                スタッフが接続承認
                                {% if connect_request and connect_request.is_approved %}
                                    <span class="text-muted small">（{{ connect_request.approved_at|date:"Y/m/d H:i:s" }}）</span>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                </div>

                {% if connect_request and connect_request.is_approved and last_login %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-clock-history" style="font-size: 20px; color: #17a2b8;"></i>
                        最終ログイン:{{ last_login|timesince }}前
                        <span class="text-muted small">（{{ last_login|date:"Y/m/d H:i:s" }}）</span>
                    </div>
                </div>
                {% endif %}

                {% if profile_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-person-circle" style="font-size: 20px; color: #17a2b8;"></i>
                        プロフィールの変更があります。
                        <a href="{% url 'staff:staff_profile_request_detail' staff.pk profile_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if mynumber_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-credit-card" style="font-size: 20px; color: #17a2b8;"></i>
                        マイナンバーの変更があります。
                        <a href="{% url 'staff:staff_mynumber_request_detail' staff.pk mynumber_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if bank_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-bank" style="font-size: 20px; color: #17a2b8;"></i>
                        銀行口座の変更があります
                        <a href="{% url 'staff:staff_bank_request_detail' staff_pk=staff.pk pk=bank_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if contact_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-person-rolodex" style="font-size: 20px; color: #17a2b8;"></i>
                        連絡先情報の変更があります。
                        <a href="{% url 'staff:staff_contact_request_detail' staff.pk contact_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if international_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-send" style="font-size: 20px; color: #17a2b8;"></i>
                        外国籍情報の変更があります。
                        <a href="{% url 'staff:staff_international_request_detail' staff.pk international_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if disability_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-heart" style="font-size: 20px; color: #17a2b8;"></i>
                        障害者情報の変更があります。
                        <a href="{% url 'staff:staff_disability_request_detail' staff.pk disability_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% else %}
                <div class="text-muted">メールアドレスが登録されていないため、接続機能は利用できません。</div>
                {% endif %}
            </div>
        </div>
        <!--右上1-->

        <!--右上2-->
        <!--右上2-->
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                評価
                {% if perms.staff.add_staffevaluation %}
                <a href="{% url 'staff:staff_evaluation_create' staff.pk %}" class="btn btn-sm btn-primary">評価登録</a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col col-sm-5 text-center d-flex flex-column justify-content-center">
                        <div>総合評価</div>
                        <h1><strong>{{ avg_rating|default:"-" }}</strong></h1>
                        <div>相対スコア</div>
                        <h1><strong>{{ relative_score|default:"-" }}</strong></h1>
                    </div>
                    <div class="col col-sm">
                        {% for dist in rating_distribution %}
                        <div class="d-flex align-items-center">
                            <span>{{ dist.rating }}　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: {{ dist.percentage }}%;" aria-valuenow="{{ dist.percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        {% endfor %}
                        <div>全{{ total_evaluations }}件の評価</div>
                        <div class="mt-2">
                             <a href="{% url 'staff:staff_evaluation_list' staff.pk %}">詳細を見る</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--右上2-->
        <!--右上2-->
    </div>


</div><!-- row -->





<script>
// ページロジック情報を設定
document.addEventListener('DOMContentLoaded', function() {
    // このページにロジック情報があることを通知
    document.body.setAttribute('data-has-logic', 'true');

    const logicContent = document.getElementById('logic-info-content');
    if (logicContent) {
        logicContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>スタッフ詳細画面のロジック情報</h6>
            </div>

            <!-- 単項目チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-shield-check text-primary me-2"></i>単項目チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-0">• メールアドレス: 接続機能を利用するには必須</div>
                </div>
            </div>

            <!-- 相関チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>相関チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 接続依頼: 既存の接続依頼がある場合はスイッチOFFで削除</div>
                    <div class="mb-0">• 接続承認: スタッフ側での承認が必要（管理者は制御不可）</div>
                </div>
            </div>

            <!-- 自動処理 -->
            <div class="card" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-gear text-secondary me-2"></i>自動処理</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 接続依頼作成: 会社の法人番号とスタッフのメールアドレスで接続レコード作成</div>
                    <div class="mb-2">• メール送信: 接続依頼・解除時に自動でメール送信</div>
                    <div class="mb-2">• 権限付与: 既存ユーザーがいる場合は接続権限を自動付与</div>
                    <div class="mb-2">• 変更履歴記録: 接続依頼の作成・削除をAppLogに自動記録</div>
                    <div class="mb-2">• 申請状況表示: 承認済みの場合、各種変更申請の有無を自動表示</div>
                    <div class="mb-0">• 最終ログイン表示: 承認済みユーザーの最終ログイン日時を自動取得・表示</div>
                </div>
            </div>
        `;
    }

    // ロジック情報設定完了を通知
    document.dispatchEvent(new Event('logicInfoSet'));
});
</script>


<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        連絡履歴 / 予定
        <div class="btn-group">
            <a href="{% url 'staff:staff_contacted_create' staff.pk %}" class="btn btn-sm btn-primary">
                連絡履歴
            </a>
            <button type="button" class="btn btn-sm btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="visually-hidden">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'staff:staff_contact_schedule_create' staff.pk %}"><i class="bi bi-alarm"></i> 連絡予定</a></li>
            </ul>
        </div>
    </div>
    <div class="card-body mb-0">
        <table class="table table-hover me-2 mt-2 mb-0" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>連絡種別</th>
                    <th>対応内容</th>
                    <th>対応者</th>
                    <th>日時 / 予定日</th>
                </tr>
            </thead>
            <tbody>
                {% for c in contacted_combined_list %}
                <tr {% if c.is_schedule %}class="table-warning" title="連絡予定"{% endif %}>
                    <td>
                        {% if c.contact_type %}
                            <span class="badge {{ c.contact_type.display_order|badge_class }}">{{ c.contact_type.name }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if c.is_schedule %}
                            <a href="{% url 'staff:staff_contact_schedule_detail' c.pk %}">{{ c.content|truncatechars:20 }}</a>
                        {% else %}
                            <a href="{% url 'staff:staff_contacted_detail' c.pk %}">{{ c.content|truncatechars:20 }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if c.created_by.last_name or c.created_by.first_name %}
                            {{ c.created_by.last_name }} {{ c.created_by.first_name }}
                        {% else %}
                            {{ c.created_by.username }}
                        {% endif %}
                    </td>
                    <td>
                        {% if c.is_schedule %}
                            {{ c.display_date|date:'Y/m/d' }} <i class="bi bi-alarm text-primary" title="予定"></i>
                        {% else %}
                            {{ c.at|date:'Y/m/d H:i:s' }}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="4">履歴・予定がありません</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-center align-items-center gap-3">
        {% if staff.contacted_histories.count > 0 %}
        <a href="{% url 'staff:staff_contacted_list' staff.pk %}">履歴一覧 (全{{ staff.contacted_histories.count }}件)</a>
        {% endif %}
        {% if staff.contact_schedules.count > 0 %}
        <a href="{% url 'staff:staff_contact_schedule_list' staff.pk %}">予定一覧 (全{{ staff.contact_schedules.count }}件)</a>
        {% endif %}
    </div>
</div>

{% if staff_contracts_count > 0 %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        スタッフ契約
    </div>
    <div class="card-body mb-0">
        <table class="table table-hover me-2 mt-2 mb-0" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>契約名</th>
                    <th>契約種別</th>
                    <th>契約期間</th>
                    <th>単価</th>
                    <th>状況</th>
                    <th>作成者</th>
                </tr>
            </thead>
            <tbody>
                {% for contract in staff_contracts %}
                <tr>
                    <td>
                        <a href="{% url 'contract:staff_contract_detail' contract.pk %}?staff={{ staff.pk }}" class="text-decoration-none">
                            {{ contract.contract_name|truncatechars:30 }}
                        </a>
                    </td>
                    <td>
                        {% if contract.employment_type %}
                            <span class="badge {{ contract.employment_type.display_order|badge_class }}">{{ contract.employment_type.name }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ contract.start_date|date:'Y/m/d' }}
                        {% if contract.end_date %}
                            ～ {{ contract.end_date|date:'Y/m/d' }}
                        {% else %}
                            ～ 無期限
                        {% endif %}
                    </td>
                    <td>
                        {% if contract.contract_amount %}
                            {% if contract.pay_unit %}{% my_name 'pay_unit' contract.pay_unit %}&nbsp;{% endif %}{{ contract.contract_amount|floatformat:0|intcomma }}円
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge {{ contract.contract_status|badge_class }}">
                            {% my_name 'contract_status' contract.contract_status %}
                        </span>
                    </td>
                    <td>
                        {% if contract.created_by.last_name or contract.created_by.first_name %}
                            {{ contract.created_by.last_name }} {{ contract.created_by.first_name }}
                        {% else %}
                            {{ contract.created_by.username }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-center align-items-center">
        <a href="{% url 'contract:staff_contract_list' %}?staff={{ staff.pk }}">全て表示 (全{{ staff_contracts_count }}件)</a>
    </div>
</div>
{% endif %}

<!-- 変更履歴（共通テンプレート使用） -->
{% url 'staff:staff_change_history_list' staff.pk as staff_history_url %}
{% with change_logs=change_logs change_logs_count=change_logs_count history_url=staff_history_url show_full_content=False %}
    {% include 'common/_change_history_list.html' %}
{% endwith %}

<!-- Face Upload Modal -->
<div class="modal fade" id="uploadFaceModal" tabindex="-1" aria-labelledby="uploadFaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFaceModalLabel">顔写真の登録/変更</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'staff:staff_face_upload' staff.pk %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="id_face_image" class="form-label">画像ファイル</label>
                        <input type="file" name="face_image" class="form-control" id="id_face_image" accept="image/jpeg,image/png" required>
                        <div class="form-text">2MB以下のJPEGまたはPNG画像を選択してください。</div>
                    </div>
                    <div id="cropperWrapper" class="cropper-container-wrapper" style="display: none;">
                        <img id="imagePreview" src="#" alt="プレビュー" style="max-width: 100%; display: block;">
                    </div>
                    <!-- クロップ座標保持用 -->
                    <input type="hidden" name="crop_x" id="id_crop_x">
                    <input type="hidden" name="crop_y" id="id_crop_y">
                    <input type="hidden" name="crop_width" id="id_crop_width">
                    <input type="hidden" name="crop_height" id="id_crop_height">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="uploadSubmitButton" disabled>アップロード</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Face Delete Modal -->
<div class="modal fade" id="deleteFaceModal" tabindex="-1" aria-labelledby="deleteFaceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFaceModalLabel">顔写真の削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>本当に顔写真を削除しますか？</p>
            </div>
            <div class="modal-footer">
                <form action="{% url 'staff:staff_face_delete' staff.pk %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-dark">削除</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Face View Modal -->
{% if staff.has_face_photo %}
<div class="modal fade" id="viewFaceModal" tabindex="-1" aria-labelledby="viewFaceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewFaceModalLabel">顔写真表示</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0 overflow-hidden">
                <img src="{% url 'staff:staff_face' staff.pk %}?v={% now "U" %}" class="img-fluid w-100" >
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.face-photo-container {
    position: relative;
    width: 100px;
    height: 100px;
}
.face-photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: flex-end; /* 下部に配置 */
    padding-bottom: 5px; /* 会社印影と統一 */
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: {% if staff.has_face_photo %}{% if staff_face_photo_style == 'round' %}50%{% elif staff_face_photo_style == 'rounded-square' %}0.375rem{% elif staff_face_photo_style == 'square' %}0{% endif %}{% else %}50%{% endif %};
}
.face-photo-container:hover .face-photo-overlay {
    opacity: 1;
}
</style>

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('id_face_image');
    const imagePreview = document.getElementById('imagePreview');
    const cropperWrapper = document.getElementById('cropperWrapper');
    const uploadSubmitButton = document.getElementById('uploadSubmitButton');

    // クロップ座標用
    const cropX = document.getElementById('id_crop_x');
    const cropY = document.getElementById('id_crop_y');
    const cropWidth = document.getElementById('id_crop_width');
    const cropHeight = document.getElementById('id_crop_height');

    let cropper = null;

    imageInput.addEventListener('change', function(event) {
        if (event.target.files && event.target.files[0]) {
            const file = event.target.files[0];
            // ファイルタイプのチェック
            if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
                alert('JPEGまたはPNG形式の画像を選択してください。');
                resetPreview();
                return;
            }
            // ファイルサイズのチェック (2MB)
            if (file.size > 2 * 1024 * 1024) {
                alert('ファイルサイズは2MB以下にしてください。');
                resetPreview();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // 既存のCropperがあれば破棄
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }

                imagePreview.src = e.target.result;
                cropperWrapper.style.display = 'block';

                // Cropperの初期化
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 1, // 正方形固定
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    crop(event) {
                        // クロップ情報を隠しフィールドにセット
                        const data = event.detail;
                        cropX.value = data.x;
                        cropY.value = data.y;
                        cropWidth.value = data.width;
                        cropHeight.value = data.height;
                    },
                });

                uploadSubmitButton.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            resetPreview();
        }
    });

    function resetPreview() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        imageInput.value = ''; // ファイル選択をリセット
        imagePreview.src = '#';
        cropperWrapper.style.display = 'none';
        uploadSubmitButton.disabled = true;

        cropX.value = '';
        cropY.value = '';
        cropWidth.value = '';
        cropHeight.value = '';
    }

    // モーダルが閉じられたときにプレビューをリセット
    const uploadModal = document.getElementById('uploadFaceModal');
    uploadModal.addEventListener('hidden.bs.modal', function () {
        resetPreview();
    });
});
</script>
{% endblock %}
{% endblock %}
