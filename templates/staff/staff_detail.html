{% extends 'common/_base.html' %}
{% load static %}
{% load humanize %}
{% load dropdowns %}
{% load badge_tags %}
{% block content %}

<div class="row" style="max-width: 100%;">

    <!-- 左上 -->
    <div class="col-8">
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                スタッフ基本情報
                <ul class="nav nav-pills">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="padding-top: 0.25em; padding-bottom: 0.25em;" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">その他情報</a>
                        <div class="dropdown-menu">
                            <a href="{% url 'staff:staff_mynumber_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-credit-card"></i>　マイナンバー
                            </a>
                            <a href="{% url 'staff:staff_contact_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-person-rolodex"></i>　その他連絡先
                            </a>
                            <a href="{% url 'staff:staff_bank_detail' staff_id=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-bank"></i>　銀行情報
                            </a>
                            <a href="{% url 'staff:staff_international_detail' staff.pk %}" class="dropdown-item">
                                <i class="bi bi-send"></i>　外国籍情報
                            </a>
                            <a href="{% url 'staff:staff_disability_detail' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-heart"></i>　障害者情報
                            </a>
                            {% if has_payroll %}
                            <a href="{% url 'staff:staff_payroll_detail' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-cash-stack"></i>　給与関連
                            </a>
                            {% else %}
                            <a href="{% url 'staff:staff_payroll_create' staff_pk=staff.pk %}" class="dropdown-item">
                                <i class="bi bi-cash-stack"></i>　給与関連
                            </a>
                            {% endif %}
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" style="padding-top: 0.25em; padding-bottom: 0.25em;" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">印刷</a>
                        <div class="dropdown-menu">
                            <a href="{% url 'staff:staff_rirekisho' staff.pk %}" class="dropdown-item"><i class="bi bi-file-excel"></i>　履歴書　(Excel)</a>
                            <a href="{% url 'staff:staff_kyushoku' staff.pk %}" class="dropdown-item"><i class="bi bi-file-excel"></i>　求職申込書　(Excel)</a>
                            <a href="{% url 'staff:staff_fuyokojo' staff.pk %}" class="dropdown-item"><i class="bi bi-filetype-pdf"></i>　扶養控除申告書　(PDF)</a>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                    {% csrf_token %}
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 d-flex justify-content-center">
                            <img src="{% url 'staff:staff_face' staff.pk %}" class="rounded-circle img-fluid" width="100" height="100" style="border-radius: 15%;">
        <!--                   <img src="{% url 'staff:staff_face' staff.pk %}" class="img-fluid" width="100" height="100" style="border-radius: 15%;">-->
                        </div>
                        
                        <div class="col-sm">
                            <div class="col-sm mb-2 d-flex align-items-center">
                                {% if staff.regist_status %}
                                    <span class="badge bg-primary" style="font-size:12px">{{ staff.regist_status.name }}</span>
                                {% endif %}
                                {% if staff.employment_type %}
                                    <span class="badge {{ staff.employment_type.display_order|badge_class }} ms-2" style="font-size:15px">{{ staff.employment_type.name }}</span>
                                {% endif %}
                                　
                                {% if staff.get_employment_status == "在職中" %}
                                    <span class="badge bg-success">{{ staff.get_employment_status }}</span>　{{ staff.hire_date|date:"Y/m/d" }}入社
                                {% elif staff.get_employment_status == "退職済み" %}
                                    <span class="badge bg-secondary">{{ staff.get_employment_status }}</span>　{{ staff.resignation_date|date:"Y/m/d" }}退職
                                {% elif staff.get_employment_status == "入社前" %}
                                    <span class="badge bg-warning">{{ staff.get_employment_status }}</span>　{{ staff.hire_date|date:"Y/m/d" }}入社
                                {% else %}
                                    <span class="badge bg-light text-dark">{{ staff.get_employment_status }}</span>
                                {% endif %}

                            </div>
                            <h4>
                                <ruby>
                                    {{ staff.name_last }}<rt>{{ staff.name_kana_last }}</rt>
                                </ruby>
                                <ruby>
                                    {{ staff.name_first }}<rt>{{ staff.name_kana_first }}</rt>
                                </ruby>
                                {% if staff.sex == 1 %}
                                    <span class="badge bg-info" style="font-size:12px">{% my_name 'sex' staff.sex%}</span>
                                {% else %}
                                    <span class="badge bg-primary" style="font-size:12px">{% my_name 'sex' staff.sex%}</span>
                                {% endif %}
                                {% if staff.employee_no %}
                                    <span style="font-size:18px">　No.
                                        <span class="copy-target" style="font-size:18px">{{ staff.employee_no }}</span>
                                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                                        <span class="copy-message">コピーしました!</span>
                                    </span>
                                {% endif %}
                                {% if staff.has_mynumber %}
                                <a href="{% url 'staff:staff_mynumber_detail' staff.pk %}" class="btn btn-sm btn-primary ms-2" title="マイナンバー">
                                    <i class="bi bi-credit-card"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_bank %}
                                <a href="{% url 'staff:staff_bank_detail' staff_id=staff.pk %}" class="btn btn-sm btn-info ms-1" title="銀行情報">
                                    <i class="bi bi-bank"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_contact %}
                                <a href="{% url 'staff:staff_contact_detail' staff.pk %}" class="btn btn-sm btn-warning ms-1" title="その他連絡先">
                                    <i class="bi bi-person-rolodex"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_international %}
                                <a href="{% url 'staff:staff_international_detail' staff.pk %}" class="btn btn-sm btn-info ms-1" title="外国籍情報">
                                    <i class="bi bi-send"></i>
                                </a>
                                {% endif %}
                                {% if staff.has_disability %}
                                <a href="{% url 'staff:staff_disability_detail' staff_pk=staff.pk %}" class="btn btn-sm btn-warning ms-1" title="障害者情報">
                                    <i class="bi bi-heart"></i>
                                </a>
                                {% endif %}
                            </h4>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>生年月日</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.birth_date }}（<span id="age-display">{{ staff.age }}</span>歳）
                        </div>
                    </div>
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>所属部署</strong>
                        </div>
                        <div class="col-sm">
                            {% if staff.department_code %}
                                {{ staff.get_current_department_name }}
                                <span class="text-muted">({{ staff.department_code }})</span>
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3 align-items-top">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>住所</strong>
                        </div>
                        <div class="col-sm">
                            〒 {{ staff.postal_code }}<br/>
                            {{ staff.address1 }} 
                            {{ staff.address2 }}<br/>
                            {{ staff.address3 }}
                            {% if staff.full_address %}
                            <a href="https://www.google.com/maps/search/?api=1&query={{ staff.full_address | urlencode }}" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;" aria-label="Googleマップで開く">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
            
                    <div class="row align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>電話</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.phone }}
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>Email</strong>
                        </div>
                        <div class="col-sm">
                            <span class="copy-target">{{ staff.email }}</span>
                            {% if staff.email %}
                                <a href="{% url 'staff:staff_mail_send' staff.pk %}" class="btn btn-sm btn-outline-primary ms-2" title="メール送信">
                                    <i class="bi bi-envelope"></i>
                                </a>
                            {% endif %}
                            <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                            <span class="copy-message">コピーしました!</span>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>メモ</strong>
                        </div>
                        <div class="col-sm">
                            {{ staff.memo|default:"-" }}
                        </div>
                    </div>

                    <div class="row mb-2 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>資格</strong>
                        </div>
                        <div class="col-sm">
                            {% if qualifications %}
                                {% for q in qualifications %}
                                    <span class="badge bg-info">{{ q.qualification.name }}{% if q.score %} {{ q.score }}{% endif %}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_qualification_list' staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="row mb-2 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>技能</strong>
                        </div>
                        <div class="col-sm">
                            {% if skills %}
                                {% for s in skills %}
                                    <span class="badge bg-success">{{ s.skill.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_skill_list' staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-4 text-start text-md-end">
                            <strong>ファイル</strong>
                        </div>
                        <div class="col-sm">
                            {% if files %}
                                {% for f in files %}
                                    <span class="badge bg-warning">
                                        {% if f.is_image %}
                                            <i class="bi bi-image"></i>
                                        {% elif f.is_document %}
                                            <i class="bi bi-file-text"></i>
                                        {% else %}
                                            <i class="bi bi-file"></i>
                                        {% endif %}
                                        <a href="{% url 'staff:staff_file_download' pk=f.pk %}" class="text-white text-decoration-none">{{ f.original_filename|truncatechars:20 }}</a>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">無し</span>
                            {% endif %}
                            <a href="{% url 'staff:staff_file_list' staff_pk=staff.pk %}" class="btn btn-sm btn-secondary ms-2">一覧</a>
                        </div>
                    </div>

                    <div class="d-flex justify-content-start">
                        {% if perms.staff.change_staff %}
                        <a href="{% url 'staff:staff_update' staff.pk %}" class="btn btn-sm btn-primary me-2">編集</a>
                        {% endif %}
                        {% if perms.staff.delete_staff %}
                        <a href="{% url 'staff:staff_delete' staff.pk %}" class="btn btn-sm btn-dark me-2">削除</a>
                        {% endif %}
                        <a href="{% url 'staff:staff_list' %}" class="btn btn-sm btn-secondary me-2">戻る</a>
                    </div>
            </div>
        </div>
    </div>
    <!-- 左上 -->

    <div class="col">
        <!--右上1-->
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                状況
            </div>
            <div class="card-body">
                {% if staff.email %}
                <form method="post">
                    {% csrf_token %}
                    <div class="row mb-3 align-items-center">
                        <div class="col-sm-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="connectRequestSwitch" 
                                       {% if connect_request %}checked{% endif %}
                                       onchange="this.form.submit()">
                                <input type="hidden" name="toggle_connect_request" value="1">
                                <label class="form-check-label" for="connectRequestSwitch">
                                    <i class="bi bi-link" style="font-size: 20px;color:#17a2b8;"></i>
                                    スタッフに接続依頼
                                    {% if connect_request %}
                                        <span class="text-muted small">（{{ connect_request.created_at|date:"Y/m/d H:i:s" }}）</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
                
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="connectApprovalSwitch" 
                                   {% if connect_request and connect_request.is_approved %}checked{% endif %} disabled>
                            <label class="form-check-label" for="connectApprovalSwitch">
                                {% if mynumber_request or profile_request or international_request %}
                                    <i class="bi bi-arrow-down-circle" style="font-size: 20px; color:#17a2b8;" title="申請あり"></i>
                                {% else %}
                                    <i class="bi bi-link" style="font-size: 20px;color:#17a2b8;"></i>
                                {% endif %}
                                スタッフが接続承認
                                {% if connect_request and connect_request.is_approved %}
                                    <span class="text-muted small">（{{ connect_request.approved_at|date:"Y/m/d H:i:s" }}）</span>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                </div>

                {% if connect_request and connect_request.is_approved and last_login %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-clock-history" style="font-size: 20px; color: #17a2b8;"></i>
                        最終ログイン:{{ last_login|timesince }}前
                        <span class="text-muted small">（{{ last_login|date:"Y/m/d H:i:s" }}）</span>
                    </div>
                </div>
                {% endif %}

                {% if profile_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-person-circle" style="font-size: 20px; color: #17a2b8;"></i>
                        プロフィールの変更があります。
                        <a href="{% url 'staff:staff_profile_request_detail' staff.pk profile_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if mynumber_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-credit-card" style="font-size: 20px; color: #17a2b8;"></i>
                        マイナンバーの変更があります。
                        <a href="{% url 'staff:staff_mynumber_request_detail' staff.pk mynumber_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if bank_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-bank" style="font-size: 20px; color: #17a2b8;"></i>
                        銀行口座の変更があります
                        <a href="{% url 'staff:staff_bank_request_detail' staff_pk=staff.pk pk=bank_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}
                
                {% if contact_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-person-rolodex" style="font-size: 20px; color: #17a2b8;"></i>
                        連絡先情報の変更があります。
                        <a href="{% url 'staff:staff_contact_request_detail' staff.pk contact_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if international_request %}
                <div class="row mb-3 mt-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-send" style="font-size: 20px; color: #17a2b8;"></i>
                        外国籍情報の変更があります。
                        <a href="{% url 'staff:staff_international_request_detail' staff.pk international_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% if disability_request %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-1">
                    </div>
                    <div class="col-sm-11">
                        <i class="bi bi-heart" style="font-size: 20px; color: #17a2b8;"></i>
                        障害者情報の変更があります。
                        <a href="{% url 'staff:staff_disability_request_detail' staff.pk disability_request.pk %}" class="btn btn-sm btn-primary">
                            確認
                        </a>
                    </div>
                </div>
                {% endif %}

                {% else %}
                <div class="text-muted">メールアドレスが登録されていないため、接続機能は利用できません。</div>
                {% endif %}
            </div>
        </div>
        <!--右上1-->

        <!--右上2-->
        <div class="content-box card bg-light mt-2 mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                評価（※未実装のサンプルです）
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col col-sm-5">
                        <div>総合評価</div>
                        <h1><strong>4.4</strong></h1>
                        <div>相対スコア</div>
                        <h1><strong>67</strong></h1>
                    </div>
                    <div class="col col-sm">
                        <div class="d-flex align-items-center">
                            <span>5　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span>4　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="80"></div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span>3　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="60"></div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span>2　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="60"></div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span>1　</span>
                            <div class="progress mb-1" style="width:150px">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="60"></div>
                            </div>
                        </div>
                        <div>全12件の評価</div>
                    </div>
                </div>
            </div>
        </div>
        <!--右上2-->
    </div>

        
</div><!-- row -->



<style>
    .copy-message {
        display: none;
        color: green;
        font-size: 0.8em;
        margin-left: 5px;
    }
    .copy-icon {
        color: green;
        font-size: 0.8em;
        cursor: pointer;
        margin-left: 5px;
    }
</style>
<script src="{% static 'js/copy-to-clipboard.js' %}"></script>

<script>
// ページロジック情報を設定
document.addEventListener('DOMContentLoaded', function() {
    // このページにロジック情報があることを通知
    document.body.setAttribute('data-has-logic', 'true');
    
    const logicContent = document.getElementById('logic-info-content');
    if (logicContent) {
        logicContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>スタッフ詳細画面のロジック情報</h6>
            </div>
            
            <!-- 単項目チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-shield-check text-primary me-2"></i>単項目チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-0">• メールアドレス: 接続機能を利用するには必須</div>
                </div>
            </div>

            <!-- 相関チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>相関チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 接続依頼: 既存の接続依頼がある場合はスイッチOFFで削除</div>
                    <div class="mb-0">• 接続承認: スタッフ側での承認が必要（管理者は制御不可）</div>
                </div>
            </div>

            <!-- 自動処理 -->
            <div class="card" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-gear text-secondary me-2"></i>自動処理</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 接続依頼作成: 会社の法人番号とスタッフのメールアドレスで接続レコード作成</div>
                    <div class="mb-2">• メール送信: 接続依頼・解除時に自動でメール送信</div>
                    <div class="mb-2">• 権限付与: 既存ユーザーがいる場合は接続権限を自動付与</div>
                    <div class="mb-2">• 変更履歴記録: 接続依頼の作成・削除をAppLogに自動記録</div>
                    <div class="mb-2">• 申請状況表示: 承認済みの場合、各種変更申請の有無を自動表示</div>
                    <div class="mb-0">• 最終ログイン表示: 承認済みユーザーの最終ログイン日時を自動取得・表示</div>
                </div>
            </div>
        `;
    }
    
    // ロジック情報設定完了を通知
    document.dispatchEvent(new Event('logicInfoSet'));
});
</script>


<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        連絡履歴
        {% if perms.staff.add_staffcontacted %}
        <a href="{% url 'staff:staff_contacted_create' staff.pk %}" class="btn btn-sm btn-primary me-2">連絡登録</a>
        {% endif %}
    </div>
    <div class="card-body mb-0">
        <table class="table table-hover me-2 mt-2 mb-0" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>連絡種別</th>
                    <th>対応内容</th>
                    <th>対応者</th>
                    <th>日時</th>
                </tr>
            </thead>
            <tbody>
                {% for c in contacted_list %}
                <tr>
                    <td>
                        {% if c.contact_type %}
                            <span class="badge {{ c.contact_type|badge_class }}">{% my_name 'contact_type' c.contact_type %}</span>
                        {% endif %}
                    </td>
                    <td><a href="{% url 'staff:staff_contacted_detail' c.pk %}">{{ c.content|truncatechars:20 }}</a></td>
                    <td>
                        {% if c.created_by.last_name or c.created_by.first_name %}
                            {{ c.created_by.last_name }} {{ c.created_by.first_name }}
                        {% else %}
                            {{ c.created_by.username }}
                        {% endif %}
                    </td>
                    <td>{{ c.contacted_at|date:'Y/m/d H:i:s' }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="4">履歴がありません</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if staff.contacted_histories.count > 5 %}
    <div class="card-footer d-flex justify-content-center align-items-center">
        <a href="{% url 'staff:staff_contacted_list' staff.pk %}">全て表示 (全{{ staff.contacted_histories.count }}件)</a>
    </div>
    {% endif %}
</div>

{% if staff_contracts_count > 0 %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        スタッフ契約
    </div>
    <div class="card-body mb-0">
        <table class="table table-hover me-2 mt-2 mb-0" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>契約名</th>
                    <th>契約種別</th>
                    <th>契約期間</th>
                    <th>単価</th>
                    <th>状況</th>
                    <th>作成者</th>
                </tr>
            </thead>
            <tbody>
                {% for contract in staff_contracts %}
                <tr>
                    <td>
                        <a href="{% url 'contract:staff_contract_detail' contract.pk %}?staff={{ staff.pk }}" class="text-decoration-none">
                            {{ contract.contract_name|truncatechars:30 }}
                        </a>
                    </td>
                    <td>
                        {% if contract.employment_type %}
                            <span class="badge {{ contract.employment_type.display_order|badge_class }}">{{ contract.employment_type.name }}</span>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ contract.start_date|date:'Y/m/d' }}
                        {% if contract.end_date %}
                            ～ {{ contract.end_date|date:'Y/m/d' }}
                        {% else %}
                            ～ 無期限
                        {% endif %}
                    </td>
                    <td>
                        {% if contract.contract_amount %}
                            {% if contract.pay_unit %}{% my_name 'pay_unit' contract.pay_unit %}&nbsp;{% endif %}{{ contract.contract_amount|floatformat:0|intcomma }}円
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge {{ contract.contract_status|badge_class }}">
                            {% my_name 'contract_status' contract.contract_status %}
                        </span>
                    </td>
                    <td>
                        {% if contract.created_by.last_name or contract.created_by.first_name %}
                            {{ contract.created_by.last_name }} {{ contract.created_by.first_name }}
                        {% else %}
                            {{ contract.created_by.username }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-footer d-flex justify-content-center align-items-center">
        <a href="{% url 'contract:staff_contract_list' %}?staff={{ staff.pk }}">全て表示 (全{{ staff_contracts_count }}件)</a>
    </div>
</div>
{% endif %}

<!-- 変更履歴（共通テンプレート使用） -->
{% url 'staff:staff_change_history_list' staff.pk as staff_history_url %}
{% with change_logs=change_logs change_logs_count=change_logs_count history_url=staff_history_url show_full_content=False %}
    {% include 'common/_change_history_list.html' %}
{% endwith %}

{% endblock %}


