{% extends 'common/_base.html' %}
{% load dropdowns %}
{% load badge_tags %}
{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            {% if is_registration_status_view %}
                <i class="bi bi-card-checklist"></i> スタッフ一覧（社員登録状況一覧）
            {% elif has_request_filter == 'true' %}
                <i class="bi bi-arrow-down-circle"></i> スタッフ一覧（申請一覧）
            {% elif has_international_filter == 'true' %}
                <i class="bi bi-send"></i> スタッフ一覧（外国籍一覧）
            {% elif has_disability_filter == 'true' %}
                <i class="bi bi-heart"></i> スタッフ一覧（障害者一覧）
            {% else %}
                スタッフ一覧
            {% endif %}
        </div>
        <div class="d-flex">
            <ul class="nav nav-pills">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" style="padding-top: 0.25em; padding-bottom: 0.25em;" data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">その他検索</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="{% url 'staff:staff_list' %}?has_request=true">
                            <i class="bi bi-arrow-down-circle"></i>
                            申請一覧
                        </a>
                        <a class="dropdown-item" href="{% url 'staff:staff_list' %}?has_international=true">
                            <i class="bi bi-send"></i>
                            外国籍一覧
                        </a>
                        <a class="dropdown-item" href="{% url 'staff:staff_list' %}?has_disability=true">
                            <i class="bi bi-heart"></i>
                            障害者一覧
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'staff:staff_list' %}?registration_status=true">
                            <i class="bi bi-card-checklist"></i>
                            社員登録状況一覧
                        </a>
                    </div>
                </li>
            </ul>
            {% if perms.staff.add_staff %}
                <a href="{% url 'staff:staff_create' %}" class="btn btn-sm btn-primary">新規作成</a>
            {% endif %}
        </div>
    </div>
    <div class="card-body">

        <form id="staff-filter-form" method="get" action="{% url 'staff:staff_list' %}" class="form-inline d-flex flex-wrap mb-3">
            <div class="input-group me-2 mb-2" style="width: 25em;">
                <span class="input-group-text">
                    <i class="bi bi-search"></i> <!-- Bootstrap Iconsの虫眼鏡アイコン -->
                </span>
                <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm" placeholder="検索キーワード">
                <span class="input-group-text" style="cursor: pointer;" onclick="document.querySelector('input[name=q]').value = '';">
                    <i class="bi bi-x"></i>
                </span>
            </div>
            <div class="input-group me-2 mb-2" style="width: 12em;">
                <select name="regist_status" class="form-select form-select-sm">
                    <option value="">登録区分（全て）</option>
                    {% for option in staff_regist_status_options %}
                        <option value="{{ option.pk }}" {% if option.is_selected %}selected{% endif %}>{{ option.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group me-2 mb-2" style="width: 12em;">
                <select name="employment_type" class="form-select form-select-sm">
                    <option value="">雇用形態（全て）</option>
                    {% for option in employment_type_options %}
                        <option value="{{ option.pk }}" {% if option.is_selected %}selected{% endif %}>{{ option.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group me-2 mb-2" style="width: 15em;">
                <select name="department" class="form-select form-select-sm">
                    <option value="">所属部署（全て）</option>
                    {% for dept in department_options %}
                        <option value="{{ dept.department_code }}" {% if dept.is_selected %}selected{% endif %}>{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="btn-group me-2 mb-2" role="group">
                <button class="btn btn-primary btn-sm" type="submit">検索</button>
                <button type="button" class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportData('csv')"><i class="bi bi-filetype-csv"></i> CSV出力</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportData('excel')"><i class="bi bi-file-earmark-excel"></i> Excel出力</a></li>
                </ul>
            </div>
            <button class="btn btn-secondary btn-sm mb-2" type="button" onclick="resetForm()">リセット</button>
        </form>

        <script>
        function resetForm() {
            var form = document.getElementById('staff-filter-form');
            form.querySelector('input[name=q]').value = '';
            form.querySelector('select[name=regist_status]').value = '';
            form.querySelector('select[name=employment_type]').value = '';
            form.querySelector('select[name=department]').value = '';
            form.submit();
        }

        function exportData(format) {
            const message = format === 'csv' ? 'CSV形式でデータを出力しますか？' : 'Excel形式でデータを出力しますか？';
            if (confirm(message)) {
                const params = new URLSearchParams();
                const form = document.getElementById('staff-filter-form');

                const queryInput = form.querySelector('input[name="q"]');
                if (queryInput && queryInput.value.trim()) {
                    params.append('q', queryInput.value.trim());
                }

                const registFormSelect = form.querySelector('select[name="regist_status"]');
                if (registFormSelect && registFormSelect.value) {
                    params.append('regist_status', registFormSelect.value);
                }

                const employmentTypeSelect = form.querySelector('select[name="employment_type"]');
                if (employmentTypeSelect && employmentTypeSelect.value) {
                    params.append('employment_type', employmentTypeSelect.value);
                }

                const departmentSelect = form.querySelector('select[name="department"]');
                if (departmentSelect && departmentSelect.value) {
                    params.append('department', departmentSelect.value);
                }

                // Add other filters from the page if they exist
                const currentParams = new URLSearchParams(window.location.search);
                if (currentParams.has('has_request')) {
                    params.append('has_request', currentParams.get('has_request'));
                }
                if (currentParams.has('has_international')) {
                    params.append('has_international', currentParams.get('has_international'));
                }
                if (currentParams.has('has_disability')) {
                    params.append('has_disability', currentParams.get('has_disability'));
                }
                if (currentParams.has('registration_status')) {
                    params.append('registration_status', currentParams.get('registration_status'));
                }

                params.append('format', format);

                const exportUrl = "{% url 'staff:staff_export' %}" + '?' + params.toString();
                window.location.href = exportUrl;
            }
        }
        </script>

        <table class="table table-striped table-hover me-2 mt-2" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th><i class="bi bi-person-fill"></i></th>
                    <th>
                        <a href="?sort={% if request.GET.sort == 'employee_no' %}-employee_no{% else %}employee_no{% endif %}&q={{ query }}&regist_status={{ regist_status_filter }}&department={{ department_filter }}&employment_type={{ employment_type_filter }}&has_request={{ has_request_filter }}&has_international={{ has_international_filter }}&has_disability={{ has_disability_filter }}&registration_status={{ is_registration_status_view|yesno:'true,false' }}"
                           class="no-link-style">
                            社員番号
                            {% if request.GET.sort == 'employee_no' %}↓{% elif request.GET.sort == '-employee_no' %}↑{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if request.GET.sort == 'name_last' %}-name_last{% else %}name_last{% endif %}&q={{ query }}&regist_status={{ regist_status_filter }}&department={{ department_filter }}&employment_type={{ employment_type_filter }}&has_request={{ has_request_filter }}&has_international={{ has_international_filter }}&has_disability={{ has_disability_filter }}&registration_status={{ is_registration_status_view|yesno:'true,false' }}"
                           class="no-link-style">
                            氏名
                            {% if request.GET.sort == 'name_last' %}↓{% elif request.GET.sort == '-name_last' %}↑{% endif %}
                        </a>
                    </th>
                    {% if is_registration_status_view %}
                    <th><i class="bi bi-credit-card"></i> マイナンバー</th>
                    <th><i class="bi bi-bank"></i> 銀行情報</th>
                    <th><i class="bi bi-cash-stack"></i> 給与関連</th>
                    {% else %}
                    <th class="d-none d-lg-table-cell">
                        <a href="?sort={% if request.GET.sort == 'address1' %}-address1{% else %}address1{% endif %}&q={{ query }}&regist_status={{ regist_status_filter }}&department={{ department_filter }}&employment_type={{ employment_type_filter }}&has_request={{ has_request_filter }}&has_international={{ has_international_filter }}&has_disability={{ has_disability_filter }}"
                           class="no-link-style">
                            住所
                            {% if request.GET.sort == 'address1' %}↓{% elif request.GET.sort == '-address1' %}↑{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if request.GET.sort == 'age' %}-age{% else %}age{% endif %}&q={{ query }}&regist_status={{ regist_status_filter }}&department={{ department_filter }}&employment_type={{ employment_type_filter }}&has_request={{ has_request_filter }}&has_international={{ has_international_filter }}&has_disability={{ has_disability_filter }}"
                           class="no-link-style">
                            年齢
                            {% if request.GET.sort == 'age' %}↓{% elif request.GET.sort == '-age' %}↑{% endif %}
                        </a>
                    </th>
                    {% endif %}
                    <th>登録区分</th>
            <th>雇用形態</th>
                    <th class="d-none d-md-table-cell">所属部署</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for staff in staffs %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% with photo_class=staff_face_photo_style|default:'round' %}
                                <img src="{% url 'staff:staff_face' staff.pk %}" class="img-fluid {% if staff.has_face_photo %}{% if photo_class == 'round' %}rounded-circle{% elif photo_class == 'rounded-square' %}rounded{% elif photo_class == 'square' %}rounded-0{% endif %}{% else %}rounded-circle{% endif %}" width="40" height="40" style="object-fit: cover;width:40px;height:40px">
                            {% endwith %}
                        </div>
                    </td>
                    <td>
                        {{ staff.employee_no|default:"" }}
                        {% if staff.has_pending_connection_request %}
                            <i class="bi bi-arrow-up-circle" style="color:#17a2b8;" title="接続申請中"></i>
                        {% elif staff.is_connected_approved %}
                            {% if staff.has_pending_profile_request or staff.has_pending_mynumber_request or staff.has_pending_bank_request or staff.has_pending_contact_request or staff.has_pending_international_request or staff.has_pending_disability_request %}
                                <i class="bi bi-arrow-down-circle" style="color:#17a2b8;" title="変更あり"></i>
                            {% else %}
                                <i class="bi bi-link" style="color:#17a2b8;" title="接続承認済み"></i>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        <a href="{% url 'staff:staff_detail' staff.pk %}">
                            {{ staff.name_last }} {{ staff.name_first }}
                        </a>
                        {% if staff.has_international_info %}
                            <i class="bi bi-send" style="color:#17a2b8;" title="外国籍"></i>
                        {% endif %}
                        {% if staff.has_disability_info %}
                            <i class="bi bi-heart" style="color:#17a2b8;" title="障害者"></i>
                        {% endif %}
                    </td>
                    {% if is_registration_status_view %}
                    <td>
                        {% if staff.has_mynumber %}
                            <i class="bi bi-check-circle-fill text-success" title="登録済み"></i>
                        {% else %}
                            <i class="bi bi-dash-circle text-muted" title="未登録"></i>
                        {% endif %}
                    </td>
                    <td>
                        {% if staff.has_bank %}
                            <i class="bi bi-check-circle-fill text-success" title="登録済み"></i>
                        {% else %}
                            <i class="bi bi-dash-circle text-muted" title="未登録"></i>
                        {% endif %}
                    </td>
                    <td>
                        {% if staff.has_payroll %}
                            <i class="bi bi-check-circle-fill text-success" title="登録済み"></i>
                        {% else %}
                            <i class="bi bi-dash-circle text-muted" title="未登録"></i>
                        {% endif %}
                    </td>
                    {% else %}
                    <td class="d-none d-lg-table-cell">{{ staff.address1 }}</td>
                    <td>{{ staff.age }}歳</td>
                    {% endif %}
                    <td>
                        {% if staff.regist_status %}
                            <span class="badge {{ staff.regist_status.display_order|badge_class }}" style="font-size:13px">{{ staff.regist_status.name }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if staff.employment_type %}
                            <span class="badge {{ staff.employment_type.display_order|badge_class }}" style="font-size:13px">{{ staff.employment_type.name }}</span>
                        {% endif %}
                    </td>
                    <td class="d-none d-md-table-cell">
                        {% if staff.department_code %}
                            {{ staff.get_current_department_name|truncatechars:15 }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <!-- メールアイコン -->
                        {% if staff.email %}
                        <a href="{% url 'staff:staff_mail_send' staff.pk %}" class="btn btn-dark btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="メール送信">
                          <i class="bi bi-envelope"></i>
                        </a>
                        {% endif %}
                        <!-- 編集アイコン -->
                        {% if perms.staff.change_staff %}
                        <a href="{% url 'staff:staff_update' staff.pk %}" class="btn btn-dark btn-sm me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="編集">
                          <i class="bi bi-pencil"></i>
                        </a>
                        {% endif %}
                        <!-- 削除アイコン -->
                        {% if perms.staff.delete_staff %}
                        <a href="{% url 'staff:staff_delete' staff.pk %}" class="btn btn-dark btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="削除">
                          <i class="bi bi-x"></i>
                        </a>
                        {% endif %}
                      </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div>
            {% include 'common/_pagination.html' with page_obj=staffs %}
        </div>
    </div>
</div>
{% endblock %}