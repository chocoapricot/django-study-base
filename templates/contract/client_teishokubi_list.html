{% extends 'common/_base.html' %}
{% load static %}
{% load help_tags %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>事業所抵触日一覧</span>
    </div>
    <div class="card-body">
        <form method="get" class="form-inline d-flex flex-wrap mb-3">
            <div class="input-group me-2 mb-2" style="width: 30em;">
                <span class="input-group-text">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" name="q" value="{{ search_query }}" class="form-control form-control-sm" placeholder="事業所名、クライアント名で検索">
                <span class="input-group-text" style="cursor: pointer;" onclick="document.querySelector('input[name=q]').value = '';">
                    <i class="bi bi-x"></i>
                </span>
            </div>
            <div class="input-group me-2 mb-2" style="width: 12em;">
                <select name="dispatch_filter" class="form-select form-select-sm">
                    <option value="all" {% if dispatch_filter == 'all' %}selected{% endif %}>すべて</option>
                    <option value="with_contract" {% if dispatch_filter == 'with_contract' %}selected{% endif %}>派遣契約あり</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm mb-2 me-2" type="submit">検索</button>
            <button class="btn btn-secondary btn-sm mb-2" type="button" onclick="resetForm()">リセット</button>
        </form>

        <!-- 事業所一覧 -->
        {% if departments %}
        <table class="table table-striped table-hover me-2 mt-2" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>クライアント名</th>
                    <th>事業所名</th>
                    <th>事業所抵触日</th>
                    <th>残り日数</th>
                    <th>派遣契約</th>
                </tr>
            </thead>
                    <tbody>
                        {% for department in departments %}
                        <tr>
                            <td>
                                {{ department.client.name }}
                            </td>
                            <td>
                                <a href="{% url 'client:client_department_detail' department.id %}" class="text-decoration-none">
                                    {{ department.name }}
                                </a>
                            </td>
                            <td>
                                <a href="{% url 'client:client_department_detail' department.id %}" class="text-decoration-none">
                                    {{ department.haken_jigyosho_teishokubi|date:"Y/m/d" }}
                                </a>
                                {% if department.is_expired %}
                                    <span class="badge bg-danger ms-1">期限切れ</span>
                                {% elif department.days_remaining <= 30 %}
                                    <span class="badge bg-warning ms-1">要注意</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if department.is_expired %}
                                    <span class="text-danger">{{ department.days_overdue }}日経過</span>
                                {% else %}
                                    <span class="text-success">{{ department.days_remaining }}日</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if department.current_staff_count == 0 %}
                                    -
                                {% else %}
                                    {% if department.current_staff_list %}
                                        <div class="mt-1">
                                            {% for staff in department.current_staff_list %}
                                                <small class="d-block text-muted">
                                                    <a href="{% url 'staff:staff_detail' staff.staff_id %}" class="text-decoration-none">
                                                        {{ staff.staff_name }}
                                                    </a>
                                                    {% if staff.has_international %}
                                                        <i class="bi bi-send" style="color:#17a2b8;" title="外国籍"></i>
                                                    {% endif %}
                                                    {% if staff.has_disability %}
                                                        <i class="bi bi-heart" style="color:#17a2b8;" title="障害者"></i>
                                                    {% endif %}
                                                    ({{ staff.contract_start|date:"Y/m/d" }} ～ {{ staff.contract_end|date:"Y/m/d" }})
                                                </small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
            </tbody>
        </table>

        <div>
            {% include 'common/_pagination.html' with page_obj=departments %}
            </div>
        {% else %}
            <div class="text-center py-4">
                <p class="text-muted mt-2">
                    {% if search_query %}
                        検索条件に一致する事業所抵触日が見つかりませんでした。
                    {% else %}
                        事業所抵触日が設定されている派遣事業所がありません。
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function resetForm() {
    // 「すべて」フィルタを明示的に指定してリダイレクト
    window.location.href = "{% url 'contract:client_teishokubi_list' %}?dispatch_filter=all";
}

document.body.setAttribute('data-has-logic', 'true');

document.addEventListener('DOMContentLoaded', function() {
    const logicContent = document.getElementById('logic-info-content');
    if (logicContent) {
        logicContent.innerHTML = `
            <div class="mb-3">
                <h6><i class="bi bi-info-circle me-2"></i>事業所抵触日一覧の仕組み</h6>
                <ul class="mb-0">
                    <li><strong>事業所抵触日</strong>: 派遣法に基づく同一事業所での派遣可能期間（原則3年）の制限管理</li>
                    <li><strong>派遣事業所</strong>: 「派遣事業所該当」フラグがONで、事業所抵触日が設定されている事業所のみ表示</li>
                    <li><strong>アラート表示</strong>: 抵触日まで30日以内は「要注意」、期限切れは「期限切れ」バッジを表示</li>
                    <li><strong>現在派遣中スタッフ</strong>: 各事業所で現在派遣契約中のスタッフ数と詳細を表示</li>
                </ul>
            </div>
            <div class="mb-3">
                <h6><i class="bi bi-gear me-2"></i>表示ロジック</h6>
                <ul class="mb-0">
                    <li>ClientDepartmentモデルの「派遣事業所該当」かつ「事業所抵触日」が設定されているもの</li>
                    <li>現在派遣中のスタッフは派遣契約で契約期間内のもの</li>
                    <li>事業所抵触日の昇順で表示</li>
                </ul>
            </div>
        `;
        
        // カスタムイベントを発火してアイコンを更新
        document.dispatchEvent(new Event('logicInfoSet'));
    }
});
</script>
{% endblock %}