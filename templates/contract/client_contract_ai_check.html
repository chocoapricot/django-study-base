{% extends 'common/_base.html' %}
{% load static %}

{% block title %}個別契約書(AI確認){% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header">
        個別契約書(AI確認) - {{ contract.contract_name }}
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            生成AIによる契約内容のチェックを行います。<br>
            ※ あくまでAIによる参考意見であり、法的な正確性を保証するものではありません。<br>
            ※ マスタ管理の生成AI設定でAPIキー、URL、プロンプトの設定が必要です。
        </div>

        {% if error_message %}
        <div class="alert alert-danger mb-3">
            <i class="bi bi-exclamation-triangle"></i> エラーが発生しました:<br>
            {{ error_message }}
        </div>
        {% endif %}

        {% if ai_response %}
        <div class="card border-info mb-4">
            <div class="card-header bg-info text-white">
                <i class="bi bi-stars"></i> AIによる確認結果
            </div>
            <div class="card-body bg-white">
                <div class="card-text">{{ ai_response|safe }}</div>
            </div>
        </div>
        <div class="text-center mb-4">
             <form method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-info">
                    <i class="bi bi-arrow-repeat"></i> 再確認する
                </button>
            </form>
        </div>
        {% else %}
            <div class="text-center py-5 mb-4 border rounded bg-white">
                <i class="bi bi-robot text-primary mb-3" style="font-size: 3rem;"></i>
                <p class="lead mb-4">生成AIを使用して、契約内容の法的チェックを行います。</p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-lg px-5">
                        <i class="bi bi-stars me-2"></i>AI確認を実行
                    </button>
                    <div class="form-text mt-2">
                        ※ 実行には数秒～数十秒かかる場合があります。
                    </div>
                </form>
            </div>
        {% endif %}

        <div class="mt-3">
            <a href="{% url 'contract:client_contract_detail' contract.pk %}" class="btn btn-sm btn-secondary">戻る</a>
        </div>

    </div>
</div>

<!-- 確認対象テキスト用の別カード -->
<div class="content-box card bg-light mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-file-text me-2"></i>確認対象の契約テキスト</span>
        <button id="copyButton" onclick="copyToClipboard(event)" class="btn btn-sm btn-primary">
            <i class="bi bi-clipboard"></i> コピー
        </button>
    </div>
    <div class="card-body">
        <pre id="contractText" style="background-color: #f8f9fa; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-size: 0.9em; border: 1px solid #dee2e6;">{% if contract.contract_status == '10' or contract.contract_status == '20' %}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【ドラフト版】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{% endif %}{{ full_contract_text }}</pre>
    </div>
</div>


<script>
function copyToClipboard(event) {
    const text = document.getElementById('contractText').textContent;
    const btn = event.currentTarget;

    navigator.clipboard.writeText(text).then(function() {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> コピー完了';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        setTimeout(function() {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 3000);
    }, function(err) {
        alert('コピーに失敗しました: ' + err);
    });
}

    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) {
                    // ボタンを無効化し、ローディング表示に変更
                    setTimeout(() => {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 確認中...';
                    }, 10);
                }
            });
        });
    });
</script>
{% endblock %}
