{% load static %}

<!-- 契約期間イメージ -->
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header">
        契約期間イメージ
    </div>
    <div class="card-body">
        <!-- ガントチャート コンテナ -->
        <div id="timeline" class="gantt-chart" style="min-height: 300px;"></div>
        
        {% if show_back_button %}
        <div class="row mt-3">
            <div class="col text-left">
                <a href="{{ back_url }}" class="btn btn-sm btn-secondary">戻る</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.gantt-chart {
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
}
.gantt-section {
    background-color: white;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin-bottom: 10px;
    padding: 10px;
}
.gantt-row {
    margin-bottom: 8px;
    padding: 5px;
    display: flex;
    align-items: center;
}
.gantt-label {
    font-size: 16px;
    font-weight: 500;
    color: #495057;
    width: 200px;
    flex-shrink: 0;
    margin-right: 10px;
    text-align: right;
    padding-right: 5px;
}
.gantt-bar-container {
    position: relative;
    height: 40px;
    background-color: #f1f3f4;
    border-radius: 4px;
    overflow: hidden;
    flex: 1;
}
.gantt-bar {
    position: absolute;
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 500;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    z-index: 2;
}
.gantt-bar.client {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: 1px solid #004085;
}
.gantt-bar.staff {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    border: 1px solid #155724;
}
.gantt-bar.staff.selected {
    background: linear-gradient(135deg, #fd7e14, #e55a00);
    border: 1px solid #cc4400;
}
.gantt-bar.staff-new {
    background: linear-gradient(135deg, #fd7e14, #e55a00);
    border: 1px solid #cc4400;
}
.gantt-bar .start-date {
    position: absolute;
    left: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.gantt-bar .end-date {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.gantt-timeline {
    position: relative;
    height: 40px;
    margin-bottom: 8px;
    padding: 0 5px;
    font-size: 14px;
    color: #6c757d;
    border-bottom: 1px solid #ddd;
    white-space: nowrap;
    overflow: hidden;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // タイムゾーンの問題を回避するため、日付文字列をUTCとしてパースする関数
    function parseDateAsUTC(dateString) {
        if (!dateString) return null;
        var parts = dateString.split('-').map(function(part) { return parseInt(part, 10); });
        return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
    }

    // 期間データの準備
    var clientStart = parseDateAsUTC('{{ client_contract.start_date|date:"Y-m-d" }}');
    {% if client_contract.end_date %}
    var clientEnd = parseDateAsUTC('{{ client_contract.end_date|date:"Y-m-d" }}');
    var clientHasEndDate = true;
    {% else %}
    var clientEnd = null;
    var clientHasEndDate = false;
    {% endif %}

    // データが不正な場合は処理を中止
    if (!clientStart) {
        console.error('クライアント契約の開始日が取得できません:', '{{ client_contract.start_date|date:"Y-m-d" }}');
        var container = document.getElementById('timeline');
        if (container) {
            container.innerHTML = '<div class="alert alert-warning">契約期間データの取得に失敗しました。</div>';
        }
        return;
    }

    // 表示期間の決定
    var displayStart = new Date(clientStart.getTime() - 5 * 24 * 60 * 60 * 1000);
    var displayEnd;

    if (clientHasEndDate && clientEnd) {
        displayEnd = new Date(clientEnd.getTime() + 5 * 24 * 60 * 60 * 1000);
    } else {
        displayEnd = new Date(clientStart.getTime() + 365 * 24 * 60 * 60 * 1000);
    }

    
    var displayRange = displayEnd - displayStart;
    
    // 選択機能用の変数（詳細一覧画面でのみ使用）
    var selectedStaffIndex = -1;
    var staffBars = [];
    
    // ガントチャートの作成
    function createGanttChart() {
        var container = document.getElementById('timeline');
        if (!container) return;
        container.innerHTML = '';
        
        createTimeline();
        
        // クライアント契約セクション
        createGanttSection();
        createGanttRow(
            '{{ client_contract.client.name|escapejs }}',
            '{{ client_contract.contract_name|escapejs }}',
            clientStart,
            clientHasEndDate ? clientEnd : null,
            'client',
            -1
        );
        
        // スタッフ契約セクション
        createGanttSection();
        
        {% if chart_type == 'assignment_confirm' %}
        // 新規割当予定のスタッフ契約（オレンジ色）- 一番上に表示
        {% if staff_contract %}
        var staffStart = parseDateAsUTC('{{ staff_contract.start_date|date:"Y-m-d" }}');
        {% if staff_contract.end_date %}
        var staffEnd = parseDateAsUTC('{{ staff_contract.end_date|date:"Y-m-d" }}');
        {% else %}
        var staffEnd = null;
        {% endif %}
        
        createGanttRow(
            '{{ staff_contract.staff.name_last|escapejs }} {{ staff_contract.staff.name_first|escapejs }} (新規)',
            '{{ staff_contract.contract_name|escapejs }}',
            staffStart,
            staffEnd,
            'staff-new',
            -1
        );
        {% endif %}
        
        // 既存の割当済みスタッフ契約があれば表示（スタッフ名＞開始日でソート済み）
        {% if existing_assignments %}
        {% for assignment in existing_assignments %}
        var existingStart = parseDateAsUTC('{{ assignment.staff_contract.start_date|date:"Y-m-d" }}');
        {% if assignment.staff_contract.end_date %}
        var existingEnd = parseDateAsUTC('{{ assignment.staff_contract.end_date|date:"Y-m-d" }}');
        {% else %}
        var existingEnd = null;
        {% endif %}
        
        createGanttRow(
            '{{ assignment.staff_contract.staff.name_last|escapejs }} {{ assignment.staff_contract.staff.name_first|escapejs }}',
            '{{ assignment.staff_contract.contract_name|escapejs }}',
            existingStart,
            existingEnd,
            'staff',
            -1
        );
        {% endfor %}
        {% endif %}
        
        {% elif chart_type == 'detail_list' %}
        // 詳細一覧画面：全てのアサイン済みスタッフ契約を表示
        {% if assignments_with_overlap %}
        {% for item in assignments_with_overlap %}
        var staffStart = parseDateAsUTC('{{ item.staff_contract.start_date|date:"Y-m-d" }}');
        {% if item.staff_contract.end_date %}
        var staffEnd = parseDateAsUTC('{{ item.staff_contract.end_date|date:"Y-m-d" }}');
        {% else %}
        var staffEnd = null;
        {% endif %}
        
        var staffBar = createGanttRow(
            '{{ item.staff_contract.staff.name_last|escapejs }} {{ item.staff_contract.staff.name_first|escapejs }}',
            '{{ item.staff_contract.contract_name|escapejs }}',
            staffStart,
            staffEnd,
            'staff',
            {{ forloop.counter0 }}
        );
        staffBars.push(staffBar);
        {% endfor %}
        {% endif %}
        {% endif %}
    }
    
    function createTimeline() {
        var container = document.getElementById('timeline');
        var timelineDiv = document.createElement('div');
        timelineDiv.className = 'gantt-timeline';
        timelineDiv.style.display = 'flex';
        timelineDiv.style.alignItems = 'center';
        
        var labelSpace = document.createElement('div');
        labelSpace.style.width = '200px';
        labelSpace.style.marginRight = '10px';
        timelineDiv.appendChild(labelSpace);
        
        var timelineContent = document.createElement('div');
        timelineContent.style.flex = '1';
        timelineContent.style.position = 'relative';
        timelineContent.style.height = '35px';
        
        // 期間の長さを計算（年数）
        var periodYears = (displayEnd - displayStart) / (365 * 24 * 60 * 60 * 1000);
        var showYearOnly = periodYears > 2; // 2年以上の場合は年のみ表示
        
        var current = new Date(displayStart.getFullYear(), displayStart.getMonth(), 1);
        var monthPositions = [];
        var previousYear = null;
        
        while (current <= displayEnd) {
            var position = ((current - displayStart) / displayRange) * 100;
            if (position >= 0 && position <= 100) {
                var currentYear = current.getFullYear();
                var isFirstMonth = previousYear === null;
                var isYearChanged = previousYear !== null && previousYear !== currentYear;
                
                // 期間が長い場合は年のみ、短い場合は年月を表示
                var label;
                if (showYearOnly) {
                    // 年のみ表示（年が変わった時のみ）
                    if (isFirstMonth || isYearChanged) {
                        label = current.toLocaleDateString('ja-JP', { year: 'numeric' });
                    } else {
                        label = null; // 月は表示しない
                    }
                } else {
                    // 通常の年月表示
                    if (isFirstMonth || isYearChanged) {
                        label = current.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' });
                    } else {
                        label = current.toLocaleDateString('ja-JP', { month: 'short' });
                    }
                }
                
                if (label) {
                    monthPositions.push({
                        position: position,
                        label: label
                    });
                }
                
                previousYear = currentYear;
            }
            current.setMonth(current.getMonth() + 1);
        }
        
        monthPositions.forEach(function(month) {
            var span = document.createElement('span');
            span.textContent = month.label;
            span.style.position = 'absolute';
            span.style.whiteSpace = 'nowrap';
            
            if (month.position > 90) {
                span.style.right = (100 - month.position) + '%';
                span.style.transform = 'none';
            } else if (month.position < 10) {
                span.style.left = month.position + '%';
                span.style.transform = 'none';
            } else {
                span.style.left = month.position + '%';
                span.style.transform = 'translateX(-50%)';
            }
            
            timelineContent.appendChild(span);
        });
        

        
        timelineDiv.appendChild(timelineContent);
        timelineDiv.style.borderBottom = '1px solid #ddd';
        timelineDiv.style.marginBottom = '10px';
        
        container.appendChild(timelineDiv);
    }
    
    function createGanttSection() {
        var container = document.getElementById('timeline');
        var sectionDiv = document.createElement('div');
        sectionDiv.className = 'gantt-section';
        
        container.appendChild(sectionDiv);
        container.currentSection = sectionDiv;
    }
    
    function createGanttRow(label, content, start, end, type, staffIndex) {
        var container = document.getElementById('timeline');
        var currentSection = container.currentSection;
        
        var rowDiv = document.createElement('div');
        rowDiv.className = 'gantt-row';
        
        var labelDiv = document.createElement('div');
        labelDiv.className = 'gantt-label';
        labelDiv.innerHTML = label;
        rowDiv.appendChild(labelDiv);
        
        var barContainer = document.createElement('div');
        barContainer.className = 'gantt-bar-container';
        
        var adjustedStart = start;
        var adjustedEnd = end;
        
        if (type !== 'client') {
            if (start < displayStart) {
                adjustedStart = displayStart;
            }
            if (end && end > displayEnd) {
                adjustedEnd = displayEnd;
            }
        }
        
        var startPos = ((adjustedStart - displayStart) / displayRange) * 100;
        var width;
        
        if (adjustedEnd) {
            var exclusiveEnd = new Date(adjustedEnd.getTime() + (24 * 60 * 60 * 1000));
            var endPos = ((exclusiveEnd - displayStart) / displayRange) * 100;
            width = endPos - startPos;
        } else {
            width = 100 - startPos;
        }
        
        startPos = Math.max(0, startPos);
        width = Math.min(100 - startPos, Math.max(1, width));
        
        var bar = document.createElement('div');
        bar.className = 'gantt-bar ' + type;
        bar.style.left = startPos + '%';
        bar.style.width = width + '%';
        bar.title = content + ' (' + start.toLocaleDateString('ja-JP') + '～' + (end ? end.toLocaleDateString('ja-JP') : '無期限') + ')';
        
        var startDateSpan = document.createElement('span');
        startDateSpan.className = 'start-date';
        startDateSpan.textContent = start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' });
        bar.appendChild(startDateSpan);
        
        var endDateSpan = document.createElement('span');
        endDateSpan.className = 'end-date';
        if (end) {
            var startYear = start.getFullYear();
            var startMonth = start.getMonth();
            var startDay = start.getDate();
            var endYear = end.getFullYear();
            var endMonth = end.getMonth();
            var endDay = end.getDate();
            
            // 年月日が全て同じ場合は非表示
            if (startYear === endYear && startMonth === endMonth && startDay === endDay) {
                endDateSpan.textContent = '';
            }
            // 年月が同じ場合は日のみ表示
            else if (startYear === endYear && startMonth === endMonth) {
                endDateSpan.textContent = '～ ' + endDay;
            }
            // 年が同じ場合は月日表示
            else if (startYear === endYear) {
                endDateSpan.textContent = '～ ' + end.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
            }
            // 年が異なる場合は年月日表示
            else {
                endDateSpan.textContent = '～ ' + end.toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' });
            }
        } else {
            endDateSpan.textContent = '～ 無期限';
        }
        bar.appendChild(endDateSpan);
        
        barContainer.appendChild(bar);
        rowDiv.appendChild(barContainer);
        currentSection.appendChild(rowDiv);
        
        return bar;
    }
    
    {% if chart_type == 'detail_list' %}
    // スタッフ選択機能（詳細一覧画面でのみ有効）
    function selectStaff(staffIndex) {
        document.querySelectorAll('tbody tr').forEach(function(row) {
            row.classList.remove('table-warning');
        });
        staffBars.forEach(function(bar) {
            if (bar) bar.classList.remove('selected');
        });
        
        if (staffIndex >= 0 && staffIndex < staffBars.length) {
            var selectedRow = document.querySelector('tr[data-staff-index="' + staffIndex + '"]');
            if (selectedRow) {
                selectedRow.classList.add('table-warning');
            }
            
            if (staffBars[staffIndex]) {
                staffBars[staffIndex].classList.add('selected');
            }
            
            selectedStaffIndex = staffIndex;
        } else {
            selectedStaffIndex = -1;
        }
    }
    
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('staff-select-link')) {
            e.preventDefault();
            var staffIndex = parseInt(e.target.getAttribute('data-staff-index'));
            
            if (selectedStaffIndex === staffIndex) {
                selectStaff(-1);
            } else {
                selectStaff(staffIndex);
            }
        }
    });
    {% endif %}
    
    createGanttChart();
});
</script>