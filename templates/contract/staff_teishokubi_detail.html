{% extends 'common/_base.html' %}
{% load static %}
{% load humanize %}
{% load dropdowns %}

{% block title %}個人抵触日詳細{% endblock %}

{% block content %}
<!-- 個人抵触日カード -->
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        個人抵触日
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <table class="table table-sm">
                    <tr>
                        <th>スタッフ</th>
                        <td>
                            {% if staff %}
                                <a href="{% url 'staff:staff_detail' staff.pk %}" class="text-decoration-none">
                                    {{ staff.name }}
                                </a>
                            {% else %}
                                {{ teishokubi.staff_email }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>クライアント</th>
                        <td>
                            {% if client %}
                                <a href="{% url 'client:client_detail' client.pk %}" class="text-decoration-none">
                                    {{ client.name }}
                                </a>
                            {% else %}
                                {{ teishokubi.client_corporate_number }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th class="w-25">組織名</th>
                        <td>{{ teishokubi.organization_name }}</td>
                    </tr>
                    <tr>
                        <th>派遣開始日</th>
                        <td>{{ teishokubi.dispatch_start_date|date:"Y年m月d日" }}</td>
                    </tr>
                    <tr>
                        <th>抵触日</th>
                        <td>{{ teishokubi.conflict_date|date:"Y年m月d日" }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 詳細情報カード -->
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        詳細情報
        <a href="{% url 'contract:staff_contract_teishokubi_detail_create' teishokubi.pk %}" class="btn btn-sm btn-primary">新規作成</a>
    </div>
    <div class="card-body">
        {% if teishokubi_details %}
        <table class="table table-striped table-hover me-2 mt-2" style="border-top: 1px solid #ddd;">
            <thead>
                <tr>
                    <th>開始日</th>
                    <th>終了日</th>
                    <th>算出対象</th>
                    <th>作成方法</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for detail in teishokubi_details %}
                <tr>
                    <td>{{ detail.assignment_start_date|date:"Y/m/d" }}</td>
                    <td>{{ detail.assignment_end_date|date:"Y/m/d" }}</td>
                    <td>
                        {% if detail.is_manual %}
                            <span class="text-muted">-</span>
                        {% else %}
                            {% if detail.is_calculated %}
                                <span class="badge bg-success">対象</span>
                            {% else %}
                                <span class="badge bg-secondary">対象外</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if detail.is_manual %}
                            <span class="badge bg-info">手動</span>
                        {% else %}
                            <span class="badge bg-secondary">自動</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if detail.is_manual %}
                            <button type="button" class="btn btn-dark btn-sm delete-btn" title="削除" data-detail-id="{{ detail.pk }}" data-date-range="{{ detail.assignment_start_date|date:'Y/m/d' }} - {{ detail.assignment_end_date|date:'Y/m/d' }}">
                                <i class="bi bi-x"></i>
                            </button>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-center">詳細情報がありません。</p>
        {% endif %}
        
        <div class="row mt-3">
            <div class="col text-left">
                <a href="{% url 'contract:staff_contract_teishokubi_list' %}" class="btn btn-sm btn-secondary">戻る</a>
            </div>
        </div>
    </div>
</div>

<!-- 変更履歴 -->
{% include 'common/_change_history_list.html' with change_logs=change_logs %}

<!-- 削除確認用の隠しフォーム -->
<form id="deleteForm" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="delete_detail_id" id="deleteDetailId">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 削除ボタンの処理
    document.querySelectorAll('.delete-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const detailId = this.getAttribute('data-detail-id');
            const dateRange = this.getAttribute('data-date-range');
            
            if (confirm('詳細情報「' + dateRange + '」を削除しますか？\nこの操作は取り消せません。')) {
                document.getElementById('deleteDetailId').value = detailId;
                document.getElementById('deleteForm').submit();
            }
        });
    });

    // ページロジック情報を設定
    document.body.setAttribute('data-has-logic', 'true');
    
    const logicContent = document.getElementById('logic-info-content');
    if (logicContent) {
        logicContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>個人抵触日詳細画面のロジック情報</h6>
            </div>
            
            <!-- 算出条件 -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-funnel text-primary me-2"></i>算出条件</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 契約種別: 派遣契約のみ対象</div>
                    <div class="mb-2">• 雇用形態: 有期雇用のスタッフのみ対象</div>
                    <div class="mb-0">• 組織単位: 同一の派遣先組織単位での期間を統合</div>
                </div>
            </div>

            <!-- 3ヶ月ルール -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-calendar-check text-warning me-2"></i>3ヶ月ルール</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 中断期間: 前の期間終了日から3ヶ月と1日以上空いた場合</div>
                    <div class="mb-2">• 派遣開始日リセット: 中断後の期間から新たな派遣開始日として扱う</div>
                    <div class="mb-0">• 算出対象: 派遣開始日以降の期間のみが抵触日計算に含まれる</div>
                </div>
            </div>

            <!-- 手動作成分の扱い -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-pencil-square text-info me-2"></i>手動作成分の扱い</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 算出対象表示: 手動作成分は「-」で表示（3ヶ月ルールで自動決定）</div>
                    <div class="mb-2">• 保持: 再計算時も手動作成分は削除されない</div>
                    <div class="mb-0">• 統合計算: 自動作成分と手動作成分を統合して抵触日を計算</div>
                </div>
            </div>

            <!-- 自動処理 -->
            <div class="card" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-gear text-secondary me-2"></i>自動処理</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• 契約アサイン作成・削除時: 自動で抵触日を再計算</div>
                    <div class="mb-2">• 手動詳細作成・削除時: 抵触日を再計算して更新</div>
                    <div class="mb-2">• 抵触日計算: 派遣開始日の3年後を自動計算</div>
                    <div class="mb-2">• 期間統合: 重複・連続する期間を自動で統合処理</div>
                    <div class="mb-0">• バリデーション: 契約アサイン時に抵触日超過をチェック</div>
                </div>
            </div>
        `;
    }
    
    // ロジック情報設定完了を通知
    document.dispatchEvent(new Event('logicInfoSet'));
});
</script>

{% endblock %}