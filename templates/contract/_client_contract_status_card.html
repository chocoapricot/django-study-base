{% load contract_tags %}
{% load dropdowns %}
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        状況
    </div>
    <div class="card-body">
        {# 承認スイッチ #}
        <form method="post" id="approve-form" action="{% url 'contract:client_contract_approve' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="approvalSwitch" name="is_approved"
                       onchange="if(this.checked){ if(confirm('契約を承認しますか？')){ this.form.submit(); } else { this.checked = false; } } else { if(confirm('承認を取り消しますか？')){ this.form.submit(); } else { this.checked = true; } }"
                       {% if contract.is_approved_or_later %}checked{% endif %}
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.DRAFT %}disabled{% endif %}>
                <label class="form-check-label" for="approvalSwitch">
                    <i class="bi bi-check-circle" style="font-size: 20px; color: #17a2b8;"></i>
                    契約承認
                    {% if contract.approved_at %}
                        <span class="text-muted small">（{{ contract.approved_at|date:"Y/m/d H:i:s" }}　{{ contract.approved_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>

        {# 見積書発行スイッチ #}
        <form method="post" id="issue-quotation-form" action="{% url 'contract:issue_quotation' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="issueQuotationSwitch" name="is_issued"
              onchange="if(this.checked){ if(confirm('見積書を発行しますか？')){ this.form.submit(); } else { this.checked = false; } } else { this.form.submit(); }"
              {% if contract.quotation_issued_at %}checked{% endif %}
              {% if not contract.is_approved_or_later %}disabled{% endif %}>
                <label class="form-check-label" for="issueQuotationSwitch">
                    <i class="bi bi-file-text" style="font-size: 20px; color: #17a2b8;"></i>
                    見積書発行
                    {% if contract.quotation_issued_at %}
                        <span class="text-muted small">（{{ contract.quotation_issued_at|date:"Y/m/d H:i:s" }}　{{ contract.quotation_issued_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>

        {# 抵触日通知書発行スイッチ #}
        {% if contract.client_contract_type_code == Constants.CLIENT_CONTRACT_TYPE.DISPATCH %}
        <form method="post" id="issue-clash-day-notification-form" action="{% url 'contract:issue_teishokubi_notification' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="issueClashDayNotificationSwitch" name="is_issued"
                       onchange="if(confirm('抵触日通知書を共有します。よろしいですか？')) { this.form.submit(); }"
                       {% if contract.teishokubi_notification_issued_at %}checked{% endif %}
                       {% if not contract.is_approved_or_later %}disabled{% endif %}>
                <label class="form-check-label" for="issueClashDayNotificationSwitch">
                    <i class="bi bi-file-earmark-check" style="font-size: 20px; color: #17a2b8;"></i>
                    抵触日通知書共有
                    {% if contract.teishokubi_notification_issued_at %}
                        <span class="text-muted small">（{{ contract.teishokubi_notification_issued_at|date:"Y/m/d H:i:s" }}　{{ contract.teishokubi_notification_issued_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>
        {% endif %}

        {# 派遣先管理台帳発行スイッチ #}
        {% if contract.client_contract_type_code == Constants.CLIENT_CONTRACT_TYPE.DISPATCH %}
        <form method="post" id="issue-dispatch-ledger-form" action="{% url 'contract:issue_dispatch_ledger' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="issueDispatchLedgerSwitch" name="is_issued"
                       onchange="if(this.checked){ if(confirm('派遣先管理台帳を発行しますか？')){ this.form.submit(); } else { this.checked = false; } } else { this.form.submit(); }"
                       {% if contract.dispatch_ledger_issued_at %}checked{% endif %}
                       {% if not contract.is_approved_or_later %}disabled{% endif %}>
                <label class="form-check-label" for="issueDispatchLedgerSwitch">
                    <i class="bi bi-file-earmark-spreadsheet" style="font-size: 20px; color: #17a2b8;"></i>
                    派遣先管理台帳発行
                    {% if contract.dispatch_ledger_issued_at %}
                        <span class="text-muted small">（{{ contract.dispatch_ledger_issued_at|date:"Y/m/d H:i:s" }}　{{ contract.dispatch_ledger_issued_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>
        {% endif %}

        {# 発行スイッチ #}
        <form method="post" id="issue-form" action="{% url 'contract:client_contract_issue' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="issueSwitch" name="is_issued"
                       onchange="if(this.checked){ if(confirm('契約書を発行しますか？')){ this.form.submit(); } else { this.checked = false; } } else { this.form.submit(); }"
                       {% if contract.is_issued_or_later %}checked disabled{% endif %}
                       {% if contract.contract_status != Constants.CONTRACT_STATUS.APPROVED %}disabled{% endif %}>
                <label class="form-check-label" for="issueSwitch">
                    <i class="bi bi-filetype-pdf" style="font-size: 20px; color: #17a2b8;"></i>
                    契約書発行
                    {% if contract.issued_at %}
                        <span class="text-muted small">（{{ contract.issued_at|date:"Y/m/d H:i:s" }}　{{ contract.issued_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>

        {# 確認スイッチ #}
        <form method="post" id="confirm-form" action="{% url 'contract:client_contract_confirm' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="confirmSwitch" name="is_confirmed"
                       disabled
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.CONFIRMED %}checked{% endif %}>
                <label class="form-check-label" for="confirmSwitch">
                    <i class="bi bi-link" style="font-size: 20px; color: #17a2b8;"></i>
                    クライアント確認
                    {% if contract.confirmed_at %}
                        <span class="text-muted small">（{{ contract.confirmed_at|date:"Y/m/d H:i:s" }}　{{ contract.confirmed_by.name|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>
    </div>
</div>
