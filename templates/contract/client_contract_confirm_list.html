{% extends 'common/_base.html' %}
{% load static %}
{% load humanize %}
{% load dropdowns %}
{% load badge_tags %}

{% block title %}クライアント契約確認{% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        クライアント契約確認
    </div>
    <div class="card-body">
        <!-- 契約一覧テーブル -->
        {% if contracts_with_status %}
        <table class="table table-striped table-hover me-2 mt-2" style="border-top: 1px solid #ddd;">
            <thead class="table-light">
                <tr>
                    <th>契約名</th>
                    <th>クライアント名</th>
                    <th>契約種別</th>
                    <th>契約期間</th>
                    <th>関連書類</th>
                    <th>契約ステータス</th>
                    <th>確認日時</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for item in contracts_with_status %}
                <tr>
                    <td>{{ item.contract.contract_name }}</td>
                    <td>{{ item.contract.client.name }}</td>
                    <td>{{ item.contract.get_client_contract_type_code_display }}</td>
                    <td>
                        {{ item.contract.start_date|date:"Y/m/d" }}
                        {% if item.contract.end_date %}
                            ～ {{ item.contract.end_date|date:"Y/m/d" }}
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            {% if item.latest_contract_pdf %}
                                <a href="{% url 'contract:download_client_contract_pdf' item.latest_contract_pdf.pk %}" target="_blank" class="btn btn-sm btn-info mb-1 text-start">契約書</a>
                            {% endif %}
                            {% if item.quotation_pdf %}
                                <a href="{% url 'contract:download_client_contract_pdf' item.quotation_pdf.pk %}" target="_blank" class="btn btn-sm btn-secondary mb-1 text-start">見積書</a>
                            {% endif %}
                            {% if item.clash_day_notification_pdf %}
                                <a href="{% url 'contract:download_client_contract_pdf' item.clash_day_notification_pdf.pk %}" target="_blank" class="btn btn-sm btn-secondary mb-1 text-start">抵触日通知書</a>
                            {% endif %}
                            {% if item.dispatch_notification_pdf %}
                                <a href="{% url 'contract:download_client_contract_pdf' item.dispatch_notification_pdf.pk %}" target="_blank" class="btn btn-sm btn-secondary mb-1 text-start">派遣通知書</a>
                            {% endif %}
                            {% if not item.latest_contract_pdf and not item.quotation_pdf and not item.clash_day_notification_pdf and not item.dispatch_notification_pdf %}
                                -
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <span class="badge {{ item.contract.contract_status|badge_class }}">{{ item.contract.get_contract_status_display }}</span>
                    </td>
                    <td>
                        {{ item.contract.confirmed_at|date:"Y/m/d H:i"|default:"-" }}
                    </td>
                    <td>
                        {% if item.contract.contract_status == '20' and item.latest_contract_pdf %} {# ISSUED and contract exists #}
                            <form method="post" action="{% url 'contract:client_contract_confirm_list' %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="contract_id" value="{{ item.contract.pk }}">
                                <input type="hidden" name="action" value="confirm">
                                <button type="submit" class="btn btn-sm btn-primary">確認</button>
                            </form>
                        {% elif item.contract.contract_status == '30' %} {# CONFIRMED #}
                            <form method="post" action="{% url 'contract:client_contract_confirm_list' %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="contract_id" value="{{ item.contract.pk }}">
                                <input type="hidden" name="action" value="unconfirm">
                                <button type="submit" class="btn btn-sm btn-secondary">未確認に戻す</button>
                            </form>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% include 'common/_pagination.html' %}
        {% else %}
        <div class="text-center py-4">
            <p class="text-muted">確認対象の契約が見つかりませんでした。</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}