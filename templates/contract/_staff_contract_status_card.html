{% load dropdowns %}
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        状況
    </div>
    <div class="card-body">
        {# 承認スイッチ #}
        <form method="post" id="approve-form" action="{% url 'contract:staff_contract_approve' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="approvalSwitch" name="is_approved"
                       onchange="this.form.submit()"
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.APPROVED or contract.contract_status == Constants.CONTRACT_STATUS.ISSUED or contract.contract_status == Constants.CONTRACT_STATUS.CONFIRMED %}checked{% endif %}
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.DRAFT %}disabled{% endif %}>
                <label class="form-check-label" for="approvalSwitch">
                    <i class="bi bi-check-circle" style="font-size: 20px; color: #17a2b8;"></i>
                    契約承認
                    {% if contract.approved_at %}
                        <span class="text-muted small">（{{ contract.approved_at|date:"Y/m/d H:i:s" }}　{{ contract.approved_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>

        {# 発行スイッチ #}
        <form method="post" id="issue-form" action="{% url 'contract:staff_contract_issue' contract.pk %}" class="mb-3">
            {% csrf_token %}
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="issueSwitch" name="is_issued"
                       onchange="this.form.submit()"
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.ISSUED or contract.contract_status == Constants.CONTRACT_STATUS.CONFIRMED %}checked{% endif %}
                       {% if contract.contract_status != Constants.CONTRACT_STATUS.APPROVED %}disabled{% endif %}
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.ISSUED %}disabled{% endif %}>
                <label class="form-check-label" for="issueSwitch">
                    <i class="bi bi-filetype-pdf" style="font-size: 20px; color: #17a2b8;"></i>
                    契約書発行
                    {% if contract.issued_at %}
                        <span class="text-muted small">（{{ contract.issued_at|date:"Y/m/d H:i:s" }}　{{ contract.issued_by.get_full_name_japanese|default:'' }}）</span>
                    {% endif %}
                </label>
            </div>
        </form>

        {# 確認スイッチ（契約書） #}
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="confirmSwitch" name="is_confirmed"
                       disabled
                       {% if contract.contract_status == Constants.CONTRACT_STATUS.CONFIRMED %}checked{% endif %}>
                <label class="form-check-label" for="confirmSwitch">
                    <i class="bi bi-link" style="font-size: 20px; color: #17a2b8;"></i>
                    スタッフ確認（契約書）
                    {% if contract.confirmed_at %}
                        <span class="text-muted small">（{{ contract.confirmed_at|date:"Y/m/d H:i:s" }}）</span>
                    {% endif %}
                </label>
            </div>
        </div>

        {# 就業条件明示書発行（有期雇用かつ派遣アサインがある場合のみ表示） #}
        {% if contract.employment_type and contract.employment_type.is_fixed_term %}
            {% for assignment in contract.assigned_assignments %}
                {% if assignment.client_contract.client_contract_type_code == Constants.CLIENT_CONTRACT_TYPE.DISPATCH %}
                    <form method="get" id="employment-conditions-form-{{ assignment.pk }}" action="{% url 'contract:staff_contract_assignment_employment_conditions_issue' contract.pk assignment.pk %}" class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="employmentConditionsSwitch{{ assignment.pk }}" name="is_issued"
                                   onchange="if(this.checked && confirm('就業条件明示書を発行しますか？')) { this.form.submit(); } else { this.checked = false; }"
                                   {% if assignment.employment_conditions_issued %}checked{% endif %}
                                   {% if contract.contract_status != Constants.CONTRACT_STATUS.ISSUED %}disabled{% endif %}
                                   {% if assignment.employment_conditions_issued %}disabled{% endif %}>
                            <label class="form-check-label" for="employmentConditionsSwitch{{ assignment.pk }}">
                                <i class="bi bi-file-earmark-text" style="font-size: 20px; color: #17a2b8;"></i>
                                就業条件明示書発行
                                <span class="text-muted small">{{ assignment.client_contract.client.name }}</span>
                                {% if assignment.employment_conditions_issued_at %}
                                    <span class="text-muted small">（{{ assignment.employment_conditions_issued_at|date:"Y/m/d H:i:s" }}　{{ assignment.employment_conditions_issued_by.get_full_name_japanese|default:'' }}）</span>
                                {% endif %}
                            </label>
                        </div>
                    </form>

                    {# スタッフ確認スイッチ（就業条件明示書） #}
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="staffConfirmSwitch{{ assignment.pk }}" name="is_staff_confirmed"
                                   {% if assignment.employment_conditions_confirmed %}checked{% endif %}
                                   disabled>
                            <label class="form-check-label" for="staffConfirmSwitch{{ assignment.pk }}">
                                <i class="bi bi-link" style="font-size: 20px; color: #17a2b8;"></i>
                                スタッフ確認（就業条件明示書）
                                <span class="text-muted small">{{ assignment.client_contract.client.name }}</span>
                                {% if assignment.employment_conditions_confirmed_at %}
                                    <span class="text-muted small">（{{ assignment.employment_conditions_confirmed_at|date:"Y/m/d H:i:s" }}）</span>
                                {% endif %}
                            </label>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>
</div>
