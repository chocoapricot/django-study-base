{% extends 'common/_base.html' %}
{% load static %}
{% load humanize %}
{% load dropdowns %}
{% load badge_tags %}

{% block title %}クライアント割当確認{% endblock %}

{% block content %}
<!-- スタッフ契約詳細カード -->
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>スタッフ契約詳細</span>
    </div>
    <div class="card-body">
        {% include 'contract/_staff_contract_header.html' with contract=staff_contract %}
    </div>
</div>

<!-- クライアント割当確認 -->
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header">
        クライアント割当確認
    </div>
    <div class="card-body">
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            以下の内容で契約を割り当てます。内容を確認してください。
        </div>

        {% if show_daily_dispatch_warning %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            日雇派遣（30日以内または週20時間未満の派遣）となり、就業するスタッフの条件に制約があります。
        </div>
        {% endif %}

        <!-- 粗利率表示 -->
        {% if profit_margin_info.can_calculate %}
        <div class="alert {% if profit_margin_info.show_warning %}alert-warning{% else %}alert-success{% endif %}" role="alert">
            <i class="bi {% if profit_margin_info.show_warning %}bi-exclamation-triangle-fill{% else %}bi-calculator{% endif %}"></i>
            <strong>粗利率: {{ profit_margin_info.profit_margin }}%</strong>
            {% if profit_margin_info.show_warning %}
                <br><small>粗利率が0%以下です。契約金額を確認してください。</small>
            {% endif %}
            <br><small>
                クライアント: {{ profit_margin_info.client_amount|floatformat:0|intcomma }}円 / 
                スタッフ: {{ profit_margin_info.staff_amount|floatformat:0|intcomma }}円
            </small>
        </div>
        {% endif %}

                <h6 class="text-muted mb-3">割当対象クライアント契約</h6>
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">{{ client_contract.contract_name }}</h6>
                        <table class="table table-sm">
                            <tr>
                                <th class="w-25">クライアント</th>
                                <td>
                                    <a href="{% url 'contract:client_contract_detail' client_contract.pk %}" class="text-decoration-none">
                                        {{ client_contract.client.name }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>契約種別</th>
                                <td>
                                    {% if client_contract.contract_type_display_name %}
                                        <span class="badge {{ client_contract.client_contract_type_code|badge_class }}">{{ client_contract.contract_type_display_name }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>契約期間</th>
                                <td>{{ client_contract.start_date|date:"Y/m/d" }}～{% if client_contract.end_date %}{{ client_contract.end_date|date:"Y/m/d" }}{% else %}無期限{% endif %}</td>
                            </tr>
                            <tr>
                                <th>契約金額</th>
                                <td>
                                    {% if client_contract.contract_amount %}
                                        {% if client_contract.bill_unit %}{% my_name 'bill_unit' client_contract.bill_unit %}&nbsp;{% endif %}{{ client_contract.contract_amount|floatformat:0|intcomma }}円
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

        <div class="row mt-3">
            <div class="col text-left">
                <form action="{% url 'contract:create_contract_assignment' %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="client_contract_id" value="{{ client_contract.pk }}">
                    <input type="hidden" name="staff_contract_id" value="{{ staff_contract.pk }}">
                    <input type="hidden" name="from" value="{{ from_view }}">
                    <button type="submit" class="btn btn-sm btn-primary">割当</button>
                </form>
                <a href="{% url 'contract:staff_contract_assignment' staff_contract.pk %}" class="btn btn-sm btn-secondary me-2">戻る</a>
            </div>
        </div>
    </div>
</div>

<!-- 契約期間イメージ -->
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header">
        契約期間イメージ
    </div>
    <div class="card-body">
        <!-- ガントチャート コンテナ -->
        <div id="timeline" class="gantt-chart" style="min-height: 300px;"></div>
    </div>
</div>
{% endblock %}

<script>
// ページロジック情報を設定
document.addEventListener('DOMContentLoaded', function() {
    // このページにロジック情報があることを通知
    document.body.setAttribute('data-has-logic', 'true');
    
    const logicContent = document.getElementById('logic-info-content');
    if (logicContent) {
        logicContent.innerHTML = `
            <div class="alert alert-info mb-3">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>契約アサインのバリデーションロジック</h6>
            </div>
            
            <!-- 派遣契約の年齢・雇用形態チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-shield-check text-warning me-2"></i>派遣契約の年齢・雇用形態チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• <strong>60歳限定契約の場合</strong>: クライアント契約が派遣で「無期雇用派遣労働者又は60歳以上の者に限定」されている場合</div>
                    <div class="mb-2">• <strong>エラー条件</strong>: スタッフが契約開始日時点で60歳未満 <strong>または</strong> 有期雇用の場合</div>
                    <div class="mb-0">• <strong>適用条件</strong>: 無期雇用 <strong>または</strong> 60歳以上のスタッフのみ割当可能</div>
                </div>
            </div>
            
            <!-- 外国籍情報チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-globe text-info me-2"></i>外国籍情報チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• <strong>対象</strong>: 外国籍情報が登録されているスタッフの契約アサイン</div>
                    <div class="mb-2">• <strong>在留期限チェック</strong>: 割当終了日が在留期限を超えている場合はエラー</div>
                    <div class="mb-2">• <strong>職種チェック</strong>: スタッフ契約の職種が特定技能外国人受入該当でない場合はエラー</div>
                    <div class="mb-0">• <strong>派遣職種チェック</strong>: クライアント契約が派遣の場合、職種が農業漁業派遣該当でない場合はエラー</div>
                </div>
            </div>

            <!-- 抵触日チェック -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-calendar-check text-danger me-2"></i>抵触日チェック</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• <strong>対象</strong>: 派遣契約かつ派遣社員（有期雇用）かつ60歳未満の場合</div>
                    <div class="mb-2">• <strong>スキップ条件</strong>: 派遣抵触日制限外情報が登録されており、詳細が入力されている場合はチェックをスキップ</div>
                    <div class="mb-2">• <strong>事業所抵触日チェック</strong>: 割当終了日が事業所抵触日を超えていないかを確認</div>
                    <div class="mb-2">• <strong>組織単位抵触日チェック</strong>: 割当終了日が組織単位抵触日（3年ルール）を超えていないかを確認</div>
                    <div class="mb-2">• <strong>割当終了日</strong>: クライアント契約終了日とスタッフ契約終了日の早い方</div>
                    <div class="mb-0">• <strong>必要条件</strong>: 派遣先事業所と組織単位が設定されていること</div>
                </div>
            </div>
            
            <!-- 基本的な前提条件 -->
            <div class="card mb-3" style="box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);">
                <div class="card-header py-2">
                    <h6 class="mb-0"><i class="bi bi-check-circle text-success me-2"></i>基本的な前提条件</h6>
                </div>
                <div class="card-body py-2">
                    <div class="mb-2">• <strong>重複チェック</strong>: 同じクライアント契約とスタッフ契約の組み合わせは1つまで</div>
                    <div class="mb-0">• <strong>契約状態</strong>: 両方の契約が有効な状態であること</div>
                </div>
            </div>
        `;
    }
});
</script>

{% block extra_css %}
<style>
.gantt-chart {
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
}
.gantt-section {
    background-color: white;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin-bottom: 10px;
    padding: 10px;
}
.gantt-row {
    margin-bottom: 8px;
    padding: 5px;
    display: flex;
    align-items: center;
}
.gantt-label {
    font-size: 16px;
    font-weight: 500;
    color: #495057;
    width: 200px;
    flex-shrink: 0;
    margin-right: 10px;
    text-align: right;
    padding-right: 5px;
}
.gantt-bar-container {
    position: relative;
    height: 40px;
    background-color: #f1f3f4;
    border-radius: 4px;
    overflow: hidden;
    flex: 1;
}
.gantt-bar {
    position: absolute;
    height: 100%;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 500;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    z-index: 2;
}
.gantt-bar.client {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: 1px solid #004085;
}
.gantt-bar.staff {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    border: 1px solid #155724;
}
.gantt-bar.staff-new {
    background: linear-gradient(135deg, #fd7e14, #e55a00);
    border: 1px solid #cc4400;
}
.gantt-bar .start-date {
    position: absolute;
    left: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.gantt-bar .end-date {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}
.gantt-timeline {
    position: relative;
    height: 40px;
    margin-bottom: 8px;
    padding: 0 5px;
    font-size: 14px;
    color: #6c757d;
    border-bottom: 1px solid #ddd;
    white-space: nowrap;
    overflow: hidden;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // タイムゾーンの問題を回避するため、日付文字列をUTCとしてパースする関数
    function parseDateAsUTC(dateString) {
        if (!dateString) return null;
        var parts = dateString.split('-').map(function(part) { return parseInt(part, 10); });
        return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
    }

    // 期間データの準備
    var clientStart = parseDateAsUTC('{{ client_contract.start_date|date:"Y-m-d" }}');
    {% if client_contract.end_date %}
    var clientEnd = parseDateAsUTC('{{ client_contract.end_date|date:"Y-m-d" }}');
    var clientHasEndDate = true;
    {% else %}
    var clientEnd = null;
    var clientHasEndDate = false;
    {% endif %}
    
    var staffStart = parseDateAsUTC('{{ staff_contract.start_date|date:"Y-m-d" }}');
    {% if staff_contract.end_date %}
    var staffEnd = parseDateAsUTC('{{ staff_contract.end_date|date:"Y-m-d" }}');
    {% else %}
    var staffEnd = null;
    {% endif %}

    // 表示期間の決定
    var displayStart = new Date(clientStart.getTime() - 5 * 24 * 60 * 60 * 1000);
    var displayEnd;

    if (clientHasEndDate) {
        displayEnd = new Date(clientEnd.getTime() + 5 * 24 * 60 * 60 * 1000);
    } else {
        displayEnd = new Date(clientStart.getTime() + 365 * 24 * 60 * 60 * 1000);
    }
    
    var displayRange = displayEnd - displayStart;
    
    // ガントチャートの作成
    function createGanttChart() {
        var container = document.getElementById('timeline');
        if (!container) return;
        container.innerHTML = '';
        
        createTimeline();
        
        // クライアント契約セクション
        createGanttSection();
        createGanttRow(
            '{{ client_contract.client.name|escapejs }}',
            '{{ client_contract.contract_name|escapejs }}',
            clientStart,
            clientHasEndDate ? clientEnd : null,
            'client'
        );
        
        // スタッフ契約セクション
        createGanttSection();
        
        // 新規割当予定のスタッフ契約（オレンジ色）- 一番上に表示
        createGanttRow(
            '{{ staff_contract.staff.name_last|escapejs }} {{ staff_contract.staff.name_first|escapejs }} (新規)',
            '{{ staff_contract.contract_name|escapejs }}',
            staffStart,
            staffEnd,
            'staff-new'
        );
        
        // 既存の割当済みスタッフ契約があれば表示（スタッフ名＞開始日でソート済み）
        {% if existing_assignments %}
        {% for assignment in existing_assignments %}
        var existingStart = parseDateAsUTC('{{ assignment.staff_contract.start_date|date:"Y-m-d" }}');
        {% if assignment.staff_contract.end_date %}
        var existingEnd = parseDateAsUTC('{{ assignment.staff_contract.end_date|date:"Y-m-d" }}');
        {% else %}
        var existingEnd = null;
        {% endif %}
        
        createGanttRow(
            '{{ assignment.staff_contract.staff.name_last|escapejs }} {{ assignment.staff_contract.staff.name_first|escapejs }}',
            '{{ assignment.staff_contract.contract_name|escapejs }}',
            existingStart,
            existingEnd,
            'staff'
        );
        {% endfor %}
        {% endif %}
    }
    
    function createTimeline() {
        var container = document.getElementById('timeline');
        var timelineDiv = document.createElement('div');
        timelineDiv.className = 'gantt-timeline';
        timelineDiv.style.display = 'flex';
        timelineDiv.style.alignItems = 'center';
        
        var labelSpace = document.createElement('div');
        labelSpace.style.width = '200px';
        labelSpace.style.marginRight = '10px';
        timelineDiv.appendChild(labelSpace);
        
        var timelineContent = document.createElement('div');
        timelineContent.style.flex = '1';
        timelineContent.style.position = 'relative';
        timelineContent.style.height = '35px';
        
        var current = new Date(displayStart.getFullYear(), displayStart.getMonth(), 1);
        var monthPositions = [];
        var previousYear = null;
        
        while (current <= displayEnd) {
            var position = ((current - displayStart) / displayRange) * 100;
            if (position >= 0 && position <= 100) {
                var currentYear = current.getFullYear();
                var isFirstMonth = previousYear === null;
                var isYearChanged = previousYear !== null && previousYear !== currentYear;
                
                var label;
                if (isFirstMonth || isYearChanged) {
                    label = current.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short' });
                } else {
                    label = current.toLocaleDateString('ja-JP', { month: 'short' });
                }
                
                monthPositions.push({
                    position: position,
                    label: label
                });
                
                previousYear = currentYear;
            }
            current.setMonth(current.getMonth() + 1);
        }
        
        monthPositions.forEach(function(month) {
            var span = document.createElement('span');
            span.textContent = month.label;
            span.style.position = 'absolute';
            span.style.whiteSpace = 'nowrap';
            
            if (month.position > 90) {
                span.style.right = (100 - month.position) + '%';
                span.style.transform = 'none';
            } else if (month.position < 10) {
                span.style.left = month.position + '%';
                span.style.transform = 'none';
            } else {
                span.style.left = month.position + '%';
                span.style.transform = 'translateX(-50%)';
            }
            
            timelineContent.appendChild(span);
        });
        
        timelineDiv.appendChild(timelineContent);
        timelineDiv.style.borderBottom = '1px solid #ddd';
        timelineDiv.style.marginBottom = '10px';
        
        container.appendChild(timelineDiv);
    }
    
    function createGanttSection() {
        var container = document.getElementById('timeline');
        var sectionDiv = document.createElement('div');
        sectionDiv.className = 'gantt-section';
        
        container.appendChild(sectionDiv);
        container.currentSection = sectionDiv;
    }
    
    function createGanttRow(label, content, start, end, type) {
        var container = document.getElementById('timeline');
        var currentSection = container.currentSection;
        
        var rowDiv = document.createElement('div');
        rowDiv.className = 'gantt-row';
        
        var labelDiv = document.createElement('div');
        labelDiv.className = 'gantt-label';
        labelDiv.innerHTML = label;
        rowDiv.appendChild(labelDiv);
        
        var barContainer = document.createElement('div');
        barContainer.className = 'gantt-bar-container';
        
        var adjustedStart = start;
        var adjustedEnd = end;
        
        if (type !== 'client') {
            if (start < displayStart) {
                adjustedStart = displayStart;
            }
            if (end && end > displayEnd) {
                adjustedEnd = displayEnd;
            }
        }
        
        var startPos = ((adjustedStart - displayStart) / displayRange) * 100;
        var width;
        
        if (adjustedEnd) {
            var exclusiveEnd = new Date(adjustedEnd.getTime() + (24 * 60 * 60 * 1000));
            var endPos = ((exclusiveEnd - displayStart) / displayRange) * 100;
            width = endPos - startPos;
        } else {
            width = 100 - startPos;
        }
        
        startPos = Math.max(0, startPos);
        width = Math.min(100 - startPos, Math.max(1, width));
        
        var bar = document.createElement('div');
        bar.className = 'gantt-bar ' + type;
        bar.style.left = startPos + '%';
        bar.style.width = width + '%';
        bar.title = content + ' (' + start.toLocaleDateString('ja-JP') + '～' + (end ? end.toLocaleDateString('ja-JP') : '無期限') + ')';
        
        var startDateSpan = document.createElement('span');
        startDateSpan.className = 'start-date';
        startDateSpan.textContent = adjustedStart.toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' });
        bar.appendChild(startDateSpan);
        
        var endDateSpan = document.createElement('span');
        endDateSpan.className = 'end-date';
        if (adjustedEnd) {
            var startYear = adjustedStart.getFullYear();
            var endYear = adjustedEnd.getFullYear();
            
            if (startYear === endYear) {
                endDateSpan.textContent = adjustedEnd.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });
            } else {
                endDateSpan.textContent = adjustedEnd.toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' });
            }
        } else {
            endDateSpan.textContent = '無期限';
        }
        bar.appendChild(endDateSpan);
        
        barContainer.appendChild(bar);
        rowDiv.appendChild(barContainer);
        currentSection.appendChild(rowDiv);
    }
    
    createGanttChart();
});
</script>
{% endblock %}
