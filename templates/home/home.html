{% extends 'common/_base.html' %}
{% load humanize %}
{% load user_parameters %}

{% block content %}

    {% if information_list %}
    <div class="content-box card bg-light mt-2 mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>お知らせ</span>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush">
                {% for info in information_list %}
                <li class="list-group-item bg-light d-flex justify-content-between align-items-start">
                    <div class="ms-2 me-auto">
                        <div class="fw-bold">
                            <a href="{% url 'home:information_detail' info.pk %}" class="text-decoration-none">{{ info.subject }}</a>
                        </div>
                        <small class="text-muted">
                            {% if info.start_date %}
                                {{ info.start_date|date:"Y/m/d" }}
                            {% else %}
                                {{ info.updated_at|date:"Y/m/d" }}
                            {% endif %}
                        </small>
                    </div>
                    {% if info.company_name %}
                    <span class="badge bg-secondary rounded-pill">{{ info.company_name }}</span>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
        {% if information_count > 5 %}
        <div class="card-footer text-center">
            <a href="{% url 'home:information_list' %}" class="text-decoration-none">全て表示 (全{{ information_count }}件)</a>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <style>
        .stats-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .stats-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: #ffffff;
        }
        .stats-card.has-count {
            cursor: pointer;
        }
        .stats-card.has-count:hover {
            transform: translateY(-4px);
        }
        .stats-card.has-count.bg-success-light {
            background: #ffe8e0;
        }
        .stats-card.has-count.bg-success-light:hover {
            background: #ffd4c4;
        }
        .stats-card.has-count.bg-primary-light {
            background: #e8f5e9;
        }
        .stats-card.has-count.bg-primary-light:hover {
            background: #d4edda;
        }
        .stats-card.has-count.bg-warning-light {
            background: #fff9e6;
        }
        .stats-card.has-count.bg-warning-light:hover {
            background: #fff3cd;
        }
        .stats-card.has-count.bg-info-light {
            background: #e7f6f8;
        }
        .stats-card.has-count.bg-info-light:hover {
            background: #d1ecf1;
        }
        .stats-icon {
            font-size: 3rem;
        }
        .stats-icon.text-muted-light {
            color: #adb5bd !important;
        }
        .icon-badge.text-muted-light {
            color: #adb5bd !important;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }
        .stats-number.text-muted-light {
            color: #adb5bd !important;
        }
        .stats-unit {
            font-size: 1.2rem;
            font-weight: 500;
            margin-left: 0.25rem;
        }
        .stats-label {
            font-size: 0.875rem;
            color: #495057;
            margin: 0;
            font-weight: 600;
        }
        .stats-description {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
            margin-bottom: 0;
        }
        .stats-card-body {
            padding: 1.25rem;
        }
        .icon-wrapper {
            position: relative;
            display: inline-block;
        }
        .icon-badge {
            position: absolute;
            top: -6px;
            right: -10px;
            font-size: 1.5rem;
            color: #ffc107;
        }
        .stats-content-with-alarm {
            margin-left: 0.5rem;
        }
    </style>

    {% if has_staff_perm or has_client_perm or staff_request_count > 0 or pending_connect_staff_count > 0 or total_flag_count > 0 %}
    <div class="content-box card bg-light mt-2 mb-4">
        <div class="card-header">業務サマリ</div>
        <div class="card-body">
            <div class="row g-3">

                {% if has_staff_perm %}
                    {% with total=staff_schedules_yesterday|add:staff_schedules_today %}
                        {% url 'home:contact_schedule_summary' as schedule_url %}
                        {% include 'home/_stats_card.html' with count=total url=schedule_url label='スタッフ連絡予定' description='昨日と今日の連絡予定件数です。' bg_class='bg-success-light' icon='bi-person-fill' badge_icon='bi-alarm' icon_color='#ff5722' %}
                    {% endwith %}
                {% endif %}

                {% if perms.staff.view_staff %}{% url 'connect:staff_list' as connect_staff_url %}{% endif %}
                {% include 'home/_stats_card.html' with count=pending_connect_staff_count url=connect_staff_url label='スタッフ申請未承認' description='承認待ちの新規接続申請があるスタッフの数です。' bg_class='bg-success-light' icon='bi-person-fill' badge_icon='bi-link' icon_color='#ff5722' unit='名' %}

                {% if perms.staff.view_staff %}{% url 'staff:staff_list' as staff_request_base_url %}{% with staff_request_url=staff_request_base_url|add:"?has_request=true" %}
                    {% include 'home/_stats_card.html' with count=staff_request_count url=staff_request_url label='スタッフプロフィール申請未承認' description='承認待ちの変更申請があるスタッフの数です。' bg_class='bg-success-light' icon='bi-person-circle' badge_icon='bi-arrow-down-circle' icon_color='#ff5722' unit='名' %}
                {% endwith %}{% else %}
                    {% include 'home/_stats_card.html' with count=staff_request_count label='スタッフプロフィール申請未承認' description='承認待ちの変更申請があるスタッフの数です。' bg_class='bg-success-light' icon='bi-person-circle' badge_icon='bi-arrow-down-circle' icon_color='#ff5722' unit='名' %}
                {% endif %}

                {% if has_inquiry_perm %}
                    {% url 'staff:staff_inquiry_list' as inquiry_base_url %}{% with inquiry_url=inquiry_base_url|add:"?status=unanswered" %}
                        {% include 'home/_stats_card.html' with count=unanswered_inquiry_count url=inquiry_url label='スタッフ問い合わせ未回答' description='スタッフからの問い合わせ・ご連絡に未回答の件数です。' bg_class='bg-warning-light' icon='bi-person-fill' badge_icon='bi-chat-left-text' icon_color='#ffc107' %}
                    {% endwith %}
                {% endif %}

                {% if perms.staff.view_staff %}
                    {% url 'staff:staff_list' as payroll_base_url %}{% with payroll_url=payroll_base_url|add:"?registration_status=true" %}
                        {% include 'home/_stats_card.html' with count=staff_payroll_info_unregistered_count url=payroll_url label='スタッフ給与情報未登録' description='マイナンバー・銀行情報・給与情報 のいずれかが未登録のスタッフ' bg_class='bg-success-light' icon='bi-person-fill' badge_icon='bi-cash-stack' icon_color='#ff5722' unit='名' %}
                    {% endwith %}
                {% endif %}

                {% if perms.staff.view_staffinternational %}
                    {% url 'staff:staff_list' as international_base_url %}{% with international_url=international_base_url|add:"?has_international=true" %}
                        {% user_parameter 'RESIDENCE_PERIOD_WARNING_DAYS' '30' as days %}
                        {% with desc="在留資格の有効期間が今日から"|add:days|add:"日以内、または過ぎているスタッフです。" %}
                            {% include 'home/_stats_card.html' with count=expiring_staff_international_count url=international_url label='外国籍スタッフ在留資格期限' description=desc bg_class='bg-warning-light' icon='bi-person-fill' badge_icon='bi-send' icon_color='#ffc107' unit='名' %}
                        {% endwith %}
                    {% endwith %}
                {% endif %}

                {% url 'system_flags:flag_list' as flag_list_url %}
                {% include 'home/_stats_card.html' with count=total_flag_count url=flag_list_url label='フラッグ対応残' description='対応が必要なフラッグの総数です。' bg_class='bg-warning-light' icon='bi-flag-fill' icon_color='#ffc107' %}

                {% if has_contract_assignment_perm %}
                    {% url 'contract:staff_contract_expire_list' as expire_url %}
                    {% include 'home/_stats_card.html' with count=unconfirmed_staff_contract_extension_count url=expire_url label='スタッフ契約延長未確認' description='延長または終了が未確認のスタッフ契約の件数です。' bg_class='bg-info-light' icon='bi-file-earmark-person-fill' badge_icon='bi-question-circle' icon_color='#17a2b8' %}
                {% endif %}

                {% if has_view_client_contract_perm %}
                    {% user_parameter 'PERSONAL_TEISHOKUBI_WARNING_DAYS' '60' as days %}
                    {% with desc="個人抵触日が"|add:days|add:"日以内の派遣契約数です。" %}
                        {% url 'contract:staff_contract_teishokubi_list' as personal_teishokubi_url %}
                        {% include 'home/_stats_card.html' with count=personal_teishokubi_deadline_count url=personal_teishokubi_url label='個人抵触日期限' description=desc bg_class='bg-warning-light' icon='bi-person-fill' badge_icon='bi-calendar-x' icon_color='#ffc107' %}
                    {% endwith %}
                {% endif %}

                {% if has_view_client_contract_perm %}
                    {% user_parameter 'OFFICE_TEISHOKUBI_WARNING_DAYS' '60' as days %}
                    {% with desc="事業所抵触日が"|add:days|add:"日以内の派遣契約数です。" %}
                        {% url 'contract:client_teishokubi_list' as office_teishokubi_url %}
                        {% include 'home/_stats_card.html' with count=teishokubi_deadline_count url=office_teishokubi_url label='事業所抵触日期限' description=desc bg_class='bg-warning-light' icon='bi-building-fill' badge_icon='bi-calendar-x' icon_color='#ffc107' %}
                    {% endwith %}
                {% endif %}
                
                {% if has_client_perm %}
                    {% with total=client_schedules_yesterday|add:client_schedules_today %}
                        {% url 'home:contact_schedule_summary' as client_schedule_url %}
                        {% include 'home/_stats_card.html' with count=total url=client_schedule_url label='クライアント連絡予定' description='昨日と今日の連絡予定件数です。' bg_class='bg-primary-light' icon='bi-building-fill' badge_icon='bi-alarm' icon_color='#28a745' %}
                    {% endwith %}
                {% endif %}

                {% if perms.client.view_client %}{% url 'connect:client_list' as connect_client_url %}{% endif %}
                {% include 'home/_stats_card.html' with count=pending_connect_client_count url=connect_client_url label='クライアント申請未承認' description='承認待ちの新規接続申請があるクライアントの数です。' bg_class='bg-primary-light' icon='bi-building-fill' badge_icon='bi-link' icon_color='#28a745' unit='社' %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="content-box card bg-light mt-2 mb-4">
        <div class="card-header">登録状況</div>
        <div class="card-body">
            <div class="row g-3">
                {% url 'staff:staff_list' as staff_list_url %}
                {% include 'home/_stats_card.html' with count=staff_count url=staff_list_url label='スタッフ登録数' description='システムに登録されているスタッフの総数です。' icon='bi-people-fill' icon_color='#ff5722' col_class='col-md-6 col-lg-4' unit='名' %}

                {% include 'home/_stats_card.html' with count=approved_staff_count url=staff_list_url label='スタッフ接続承認済み' description='接続申請が承認されたスタッフの数です。' icon='bi-person-check-fill' icon_color='#ff5722' col_class='col-md-6 col-lg-4' unit='名' %}

                {% url 'contract:staff_contract_list' as staff_contract_list_url %}
                {% include 'home/_stats_card.html' with count=staff_contract_count url=staff_contract_list_url label='スタッフ契約登録数' description='本日以降に有効な契約の総数です。' icon='bi-file-earmark-person-fill' icon_color='#ff5722' col_class='col-md-6 col-lg-4' %}

                {% url 'client:client_list' as client_list_url %}
                {% include 'home/_stats_card.html' with count=client_count url=client_list_url label='クライアント登録数' description='システムに登録されているクライアントの総数です。' icon='bi-building-fill' icon_color='#28a745' col_class='col-md-6 col-lg-4' unit='社' %}

                {% include 'home/_stats_card.html' with count=approved_client_count url=client_list_url label='クライアント接続承認済み' description='接続申請が承認されたクライアント担当者の数です。' icon='bi-building-fill-check' icon_color='#28a745' col_class='col-md-6 col-lg-4' unit='名' %}

                {% url 'contract:client_contract_list' as client_contract_list_url %}
                {% include 'home/_stats_card.html' with count=client_contract_count url=client_contract_list_url label='クライアント契約登録数' description='本日以降に有効な契約の総数です。' icon='bi-file-earmark-text-fill' icon_color='#28a745' col_class='col-md-6 col-lg-4' %}
            </div>
        </div>
    </div>

    <div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
        <div class="card-header">利用技術</div>
        <div class="card-body" style="overflow-wrap: break-word;">
            <div class="row g-4">
                <div class="col-12 col-xl-3">
                    <h4 class="card-title">Base</h4>
                    <p class="card-text">
                        <ul>
                            <li>Django 5.2 (BSD 3-Clause License)</li>
                            <li>Python 3.12</li>
                            <li>Bootstrap 5.3 (MIT License)</li>
                            <li>Bootstrap Icon (MIT License)</li>
                            <li>Bootswatch for 5.3 (MIT License)</li>
                            <li>SQLite3 (Public Domain)</li>
                            
                        </ul>
                    </p>
                    <h4 class="card-title">Coding</h4>
                    <p class="card-text">
                        <ul>
                            <li>Amazon kiro (with Claude Sonnet 4.0, Auto)</li>
                            <li>Google Jules (with Gemini 2.5 pro)</li>
                            <li>VSCode (with Github Copilot Agent)</li>
                            <li>VSCode (with Gemini CLI 2.5)</li>
                            <li>Antigravity (with Gemini 3 pro)</li>
                            <li>Antigravity (with Claude Sonnet 4.5)</li>
                        </ul>
                    </p>
                </div>
                <div class="col-12 col-xl-5">
                    <h4 class="card-title">Middleware</h4>
                    <p class="card-text">
                        <ul>
                            <li>django-allauth：認証機能 (MIT License)</li>
                            <li>django-import-export：管理画面のインポートエクスポート (MIT License)</li>
                            <li>django-currentuser：最終更新ユーザ (MIT License)</li>
                            <li>django-concurrency：楽観ロック (Apache License 2.0)</li>
                            <li>pillow：画像処理ライブラリ (MIT License)</li>
                            <li>requests：HTTP通信ライブラリ (Apache License 2.0)</li>
                            <li>python-dateutil：日付処理ライブラリ (Apache License 2.0)</li>
                            <li>jpholiday：祝日ライブラリ (MIT License)</li>
                            <li>python-stdnum：各種標準番号の検証 (LGPL-3.0 License)</li>
                            <li>openpyxl：Excelファイル操作ライブラリ (MIT License)</li>
                            <!-- <li>pdfrw：PDFファイル操作ライブラリ (MIT License)</li> -->
                            <li>reportlab：PDFファイル生成 (BSD like)</li>
                            <li>pypdfium2：PDFドキュメント操作ライブラリ (Apache License 2.0)</li>
                            <!-- <li>PyMuPDF：PDF/XPS/EPUB/CB2/CBRドキュメント操作ライブラリ (GNU Affero General Public License v3.0)</li> -->
                            <li>django-storages：ファイルストレージ抽象化ライブラリ (BSD 3-Clause License)</li>
                            <li>tablib：表形式データのエクスポート/インポートライブラリ (MIT License)</li>
                            <li>Cropper.js：画像切り抜きライブラリ (MIT License)</li>
                        </ul>
                    </p>
                    <h4 class="card-title">API</h4>
                    <p class="card-text">
                        <ul>
                            <li>gBizINFO：法人番号から企業情報取得：https://info.gbiz.go.jp/ (著作権は経済産業省に帰属します。)</li>
                            <li>zipcloud：郵便番号から住所取得：https://zipcloud.ibsnet.co.jp/ (MIT License)</li>
                            <li>銀行情報検索：DBの銀行情報から検索：/api/search_banks/ (自作API)</li>
                            <li>銀行支店検索：DBの支店情報から検索：/api/search_bank_branchs/ (自作API)</li>
                            <li>Gemini：生成AIによるテキスト解析・生成：https://ai.google.dev/ (Google AI Studio)</li>
                            <li>OpenAI：生成AIによるテキスト解析・生成：https://platform.openai.com/ (OpenAI)</li>
                        </ul>
                    </p>
                </div>

                <div class="col-12 col-xl-4">
                    <h4 class="card-title">Custom Tags</h4>
                    <p class="card-text">
                        <ul>
                            <li>Tooltip：{% templatetag openblock %} load help_tags {% templatetag closeblock %}<br>
                                例:{% templatetag openblock %} my_help_preset "corporate_number" %}<br/>
                                例:{% templatetag openblock %} my_help_icon "help message" %}<br/>
                                例:{% templatetag openblock %} my_note_preset "teishokubi" %}<br/>
                                例:{% templatetag openblock %} my_note_icon "note message" %}
                            </li>
                            <li>Parameter：{% templatetag openblock %} load parameters {% templatetag closeblock %}<br>
                                例:{% templatetag openblock %} parameter 'SYSTEM_NAME' %}
                            </li>
                            <li>Badge color：{% templatetag openblock %} load badge_tags {% templatetag closeblock %}<br>
                                例:&ltspan class="badge {% templatetag openvariable %} client.client_regist_status|badge_class {% templatetag closevariable %}"
                            </li>
                            <li>Dropdown selected：{% templatetag openblock %} load dropdowns {% templatetag closeblock %}<br>
                                例:{% templatetag openblock %} my_name 'sex' staff.sex %}
                            </li>
                        </ul>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
        <div class="card-header">規定・書式</div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-12 col-md-6">
                    <h4 class="card-title">Staff</h4>
                    <p class="card-text">
                        <ul>
                            <li><i class="bi bi-file-earmark-excel"></i> 履歴書
                                <a href="https://doda.jp/guide/rireki/template/" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    厚生労働省の履歴書テンプレート Excel A4 <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                            <li><i class="bi bi-file-earmark-excel"></i> 求職申込書
                                <a href="https://jsite.mhlw.go.jp/tokyo-roudoukyoku/riyousha_mokuteki_menu/mokuteki_naiyou/haken_part/syokai-youshikirei.html" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    東京労働局　求職申込書【Excel形式】 <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                            <!-- <li><i class="bi bi-file-earmark-pdf"></i> 給与所得者の扶養控除等(異動)申告書
                                <a href="https://www.nta.go.jp/taxes/tetsuzuki/shinsei/annai/gensen/annai/1648_01.htm" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    国税庁(令和7年分) <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li> -->
                        </ul>
                    </p>
                </div>

                <div class="col-12 col-md-6">
                    <h4 class="card-title">Master</h4>
                    <p class="card-text">
                        <ul>
                            <li><i class="bi bi-database"></i> 総務省職業分類
                                <a href="https://www.soumu.go.jp/toukei_toukatsu/index/seido/shokgyou/21index.htm" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    日本標準職業分類（平成21年12月告示） <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                            <li><i class="bi bi-database"></i> 厚労省職業分類
                                <a href="https://www.hellowork.mhlw.go.jp/info/mhlw_job_dictionary.html" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    厚生労働省編職業分類（令和４年改定） <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                            <li><i class="bi bi-database"></i> 最低賃金
                                <a href="https://saiteichingin.mhlw.go.jp/table/page_list_nationallist.html" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    地域別最低賃金全国一覧（2025.9） <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                            <li><i class="bi bi-database"></i> 都道府県
                                <a href="https://nlftp.mlit.go.jp/ksj/gml/codelist/PrefCd.html" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;">
                                    全国地方公共団体コード（JIS X 0401） <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </li>
                        </ul>
                    </p>
                </div>
            </div>
        </div>
    </div>
    

{% endblock %}
