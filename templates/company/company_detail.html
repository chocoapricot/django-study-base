{% extends 'common/_base.html' %}
{% load static %}
{% load help_tags %}
{% load parameters %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .seal-container {
        position: relative;
        width: 100px;
        height: 100px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .seal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: flex-end; /* 下部に配置 */
        padding-bottom: 5px;
        gap: 5px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .seal-container:hover .seal-overlay {
        opacity: 1;
    }
    .cropper-container-wrapper {
        width: 100%;
        max-height: 400px;
        min-height: 200px;
        background-color: #f7f7f7;
        margin-top: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}

{% if companies %}
<!-- 管理者用会社一覧 -->
<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-buildings me-2"></i>会社一覧（管理者用）</span>
        <a href="{% url 'company:company_create' %}" class="btn btn-sm btn-primary">新規作成</a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm mb-0" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>会社名</th>
                        <th>法人番号</th>
                        <th>ID / Tenant ID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in companies %}
                    <tr class="{% if c.pk == company.pk %}table-primary{% endif %}">
                        <td>
                            {% if c.pk == company.pk %}
                                <strong>{{ c.name }}</strong>
                            {% else %}
                                {{ c.name }}
                            {% endif %}
                        </td>
                        <td>{{ c.corporate_number|default:"-" }}</td>
                        <td>
                            <small class="text-muted">
                                ID: {{ c.pk }} / Tenant: {{ c.tenant_id }}
                            </small>
                        </td>
                        <td>
                            {% if c.pk == company.pk %}
                                -
                            {% else %}
                                <a href="?company_id={{ c.pk }}" class="btn btn-sm btn-primary">選択</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header">会社基本情報</div>
    <div class="card-body">
        <div class="row mb-3 align-items-center">
            <div class="col-sm-12">
                <h4>{{ company.name }}</h4>
            </div>
        </div>

        <div class="row">
            <!-- 左カラム: 基本・連絡先情報 -->
            <div class="col-lg-6">
                {% if company.corporate_number %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>法人番号</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="copy-target">{{ company.corporate_number }}</span>
                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                        <span class="copy-message">コピーしました!</span>
                    </div>
                </div>
                {% endif %}

                <div class="row mb-3 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>代表者</strong>
                    </div>
                    <div class="col-sm-8">
                        {{ company.representative }}
                    </div>
                </div>

                {% if company.postal_code or company.address %}
                <div class="row mb-3 align-items-start">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>住所</strong>
                    </div>
                    <div class="col-sm-8">
                        {% if company.postal_code %}〒 {{ company.postal_code }}<br/>{% endif %}
                        {{ company.address }}
                        {% if company.address %}
                        <a href="{% parameter 'GOOGLE_MAPS_URL_BASE' %}{{ company.address|urlencode }}" target="_blank" class="text-decoration-none" style="color:green;margin-left: 5px;" aria-label="Googleマップで開く">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if company.phone_number %}
                <div class="row mb-3 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>電話番号</strong>
                    </div>
                    <div class="col-sm-8">
                        <span class="copy-target">{{ company.phone_number }}</span>
                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                        <span class="copy-message">コピーしました!</span>
                    </div>
                </div>
                {% endif %}

                <div class="row mb-1 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>許可番号(派遣)</strong>
                        {% my_help_icon "労働者派遣事業 厚生労働大臣許可番号" %}
                    </div>
                    <div class="col-sm-8">
                        <span class="copy-target">{{ company.haken_permit_number }}</span>
                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                        <span class="copy-message">コピーしました!</span>
                    </div>
                </div>

                <div class="row mb-1 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>待遇決定方式</strong>
                        {% my_help_icon "派遣労働者の待遇決定方式を選択してください。派遣先通知書に反映されます。" %}
                    </div>
                    <div class="col-sm-8">
                        {{ company.get_dispatch_treatment_method_display }}
                    </div>
                </div>

                <div class="row mb-1 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>許可番号(紹介)</strong>
                        {% my_help_icon "有料職業紹介事業許可証 許可番号" %}
                    </div>
                    <div class="col-sm-8">
                        <span class="copy-target">{{ company.shokai_permit_number }}</span>
                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                        <span class="copy-message">コピーしました!</span>
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>登録番号(特技)</strong>
                        {% my_help_icon "特定技能外国人受入れに関する登録支援機関 登録番号" %}
                    </div>
                    <div class="col-sm-8">
                        <span class="copy-target">{{ company.foreign_regist_number }}</span>
                        <i class="bi bi-copy copy-icon" onclick="copyToClipboard(this)"></i>
                        <span class="copy-message">コピーしました!</span>
                    </div>
                </div>
            </div>

            <!-- 右カラム: 印影・許可証情報 -->
            <div class="col-lg-6">
                <div class="row mb-3 align-items-start">
                    <div class="col-sm-4 text-start text-sm-end">
                        <strong>会社印</strong>
                    </div>
                    <div class="col-sm-8 d-flex gap-4">
                        <div class="text-center">
                            <div class="seal-container mb-1" {% if company.round_seal %}onclick="viewSeal('round')" style="cursor: pointer;"{% endif %}>
                                {% if company.round_seal %}
                                <img src="{% url 'company:serve_company_seal' 'round' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}&{% else %}?{% endif %}v={% now "U" %}" style="max-width: 100%; max-height: 100%;">
                                {% else %}
                                <div class="text-muted d-flex align-items-center justify-content-center small" style="height: 100%;">未登録</div>
                                {% endif %}
                                <div class="seal-overlay">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openSealUpload('round')" title="登録/変更"><i class="bi bi-upload"></i></button>
                                    {% if company.round_seal %}
                                    <button type="button" class="btn btn-sm btn-dark" onclick="event.stopPropagation(); deleteSeal('round')" title="削除"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="small">丸印</span>
                        </div>
                        <div class="text-center">
                            <div class="seal-container mb-1" {% if company.square_seal %}onclick="viewSeal('square')" style="cursor: pointer;"{% endif %}>
                                {% if company.square_seal %}
                                <img src="{% url 'company:serve_company_seal' 'square' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}&{% else %}?{% endif %}v={% now "U" %}" style="max-width: 100%; max-height: 100%;">
                                {% else %}
                                <div class="text-muted d-flex align-items-center justify-content-center small" style="height: 100%;">未登録</div>
                                {% endif %}
                                <div class="seal-overlay">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openSealUpload('square')" title="登録/変更"><i class="bi bi-upload"></i></button>
                                    {% if company.square_seal %}
                                    <button type="button" class="btn btn-sm btn-dark" onclick="event.stopPropagation(); deleteSeal('square')" title="削除"><i class="bi bi-trash"></i></button>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="small">角印</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="d-flex justify-content-start mt-3">
            <a href="{% url 'company:company_edit_with_pk' pk=company.pk %}" class="btn btn-sm btn-primary me-2">編集</a>
        </div>
    </div>
</div>

<!-- 組織一覧と担当者一覧を左右に配置 -->
<div class="row mt-2 mb-4">
    <!-- 組織一覧（左側） -->
    <div class="col-md-4">
        <div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
            <div class="card-header d-flex justify-content-between align-items-center">
                部署一覧
                <a href="{% url 'company:department_create' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}" class="btn btn-sm btn-primary">部署追加</a>
            </div>
            <div class="card-body mb-0" style="margin-bottom: 2rem;">
                <table class="table table-hover me-2 mt-2 mb-0" style="border-top: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th>部署コード</th>
                            <th>部署名</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for department in departments %}
                        <tr{% if current_department and department.pk == current_department.pk %} class="table-warning"{% endif %}{% if not department.is_valid_on_date %} style="opacity: 0.6;"{% endif %}>
                            <td>{{ department.department_code }}</td>
                            <td><a href="{% url 'company:department_detail' department.pk %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}">{{ department.name }}</a></td>
                            <td>
                                <a href="{% url 'company:department_edit' department.pk %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}" class="btn btn-dark btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="編集">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'company:department_delete' department.pk %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}" class="btn btn-dark btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="削除">
                                    <i class="bi bi-x"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6">部署が登録されていません</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 担当者一覧（右側） -->
    <div class="col-md-8">
{% include 'company/_user_list_table.html' %}
    </div>
</div>

<!-- 変更履歴（共通テンプレート使用） -->
{% url 'company:change_history_list' as company_history_url_base %}
{% if request.user.is_superuser %}
    {% with company_history_url=company_history_url_base|add:"?company_id="|add:company.pk|stringformat:"s" %}
        {% url 'company:change_history_list' as ignored %} {# reset? no #}
    {% endwith %}
    {# Template tag 'add' doesn't work well for this. I'll just use a simple approach in the include #}
{% endif %}
{% url 'company:change_history_list' as company_history_url %}
{% with change_logs=change_logs change_logs_count=change_logs_count history_url=company_history_url show_full_content=False %}
    {% include 'common/_change_history_list.html' %}
{% endwith %}



<!-- Seal Upload Modal -->
<div class="modal fade" id="uploadSealModal" tabindex="-1" aria-labelledby="uploadSealModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadSealModalLabel">会社印の登録/変更</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'company:company_seal_upload' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="seal_type" id="id_seal_type">
                    <div class="mb-3">
                        <label for="id_seal_image" class="form-label">画像ファイル</label>
                        <input type="file" name="seal_image" class="form-control" id="id_seal_image" accept="image/jpeg,image/png" required>
                        <div class="form-text">2MB以下のJPEGまたはPNG画像を選択してください。</div>
                    </div>
                    <div id="cropperWrapper" class="cropper-container-wrapper" style="display: none;">
                        <img id="imagePreview" src="#" alt="プレビュー" style="max-width: 100%; display: block;">
                    </div>
                    <!-- クロップ座標保持用 -->
                    <input type="hidden" name="crop_x" id="id_crop_x">
                    <input type="hidden" name="crop_y" id="id_crop_y">
                    <input type="hidden" name="crop_width" id="id_crop_width">
                    <input type="hidden" name="crop_height" id="id_crop_height">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="uploadSubmitButton" disabled>アップロード</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Seal Delete Form (hidden) -->
<form id="deleteSealForm" action="{% url 'company:company_seal_delete' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}{% endif %}" method="post" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="seal_type" id="id_delete_seal_type">
</form>

<!-- Round Seal View Modal -->
{% if company.round_seal %}
<div class="modal fade" id="viewRoundSealModal" tabindex="-1" aria-labelledby="viewRoundSealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewRoundSealModalLabel">丸印表示</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0 overflow-hidden">
                <img src="{% url 'company:serve_company_seal' 'round' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}&{% else %}?{% endif %}v={% now "U" %}" class="img-fluid w-100">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Square Seal View Modal -->
{% if company.square_seal %}
<div class="modal fade" id="viewSquareSealModal" tabindex="-1" aria-labelledby="viewSquareSealModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewSquareSealModalLabel">角印表示</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0 overflow-hidden">
                <img src="{% url 'company:serve_company_seal' 'square' %}{% if request.user.is_superuser %}?company_id={{ company.pk }}&{% else %}?{% endif %}v={% now "U" %}" class="img-fluid w-100">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
    const imageInput = document.getElementById('id_seal_image');
    const imagePreview = document.getElementById('imagePreview');
    const cropperWrapper = document.getElementById('cropperWrapper');
    const uploadSubmitButton = document.getElementById('uploadSubmitButton');
    const sealTypeInput = document.getElementById('id_seal_type');
    
    // クロップ座標用
    const cropX = document.getElementById('id_crop_x');
    const cropY = document.getElementById('id_crop_y');
    const cropWidth = document.getElementById('id_crop_width');
    const cropHeight = document.getElementById('id_crop_height');

    let cropper = null;

    function openSealUpload(type) {
        sealTypeInput.value = type;
        const title = type === 'round' ? '丸印の登録/変更' : '角印の登録/変更';
        document.getElementById('uploadSealModalLabel').textContent = title;
        const modal = new bootstrap.Modal(document.getElementById('uploadSealModal'));
        modal.show();
    }

    function deleteSeal(type) {
        if (confirm(`${type === 'round' ? '丸印' : '角印'}を削除しますか？`)) {
            document.getElementById('id_delete_seal_type').value = type;
            document.getElementById('deleteSealForm').submit();
        }
    }

    function viewSeal(type) {
        const modalId = type === 'round' ? 'viewRoundSealModal' : 'viewSquareSealModal';
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    }

    imageInput.addEventListener('change', function(event) {
        if (event.target.files && event.target.files[0]) {
            const file = event.target.files[0];
            if (file.type !== 'image/jpeg' && file.type !== 'image/png') {
                alert('JPEGまたはPNG形式の画像を選択してください。');
                resetPreview();
                return;
            }
            if (file.size > 2 * 1024 * 1024) {
                alert('ファイルサイズは2MB以下にしてください。');
                resetPreview();
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }

                imagePreview.src = e.target.result;
                cropperWrapper.style.display = 'block';
                
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 1,
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 1,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    crop(event) {
                        const data = event.detail;
                        cropX.value = data.x;
                        cropY.value = data.y;
                        cropWidth.value = data.width;
                        cropHeight.value = data.height;
                    },
                });

                uploadSubmitButton.disabled = false;
            };
            reader.readAsDataURL(file);
        } else {
            resetPreview();
        }
    });

    function resetPreview() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        imageInput.value = '';
        imagePreview.src = '#';
        cropperWrapper.style.display = 'none';
        uploadSubmitButton.disabled = true;
        cropX.value = '';
        cropY.value = '';
        cropWidth.value = '';
        cropHeight.value = '';
    }

    document.getElementById('uploadSealModal').addEventListener('hidden.bs.modal', function () {
        resetPreview();
    });
</script>
{% endblock %}