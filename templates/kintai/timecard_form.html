{% extends 'common/_base.html' %}
{% load help_tags %}
{% block content %}
{% include 'kintai/_timesheet_summary_card.html' with timesheet=timesheet %}

<div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
    <div class="card-header">
        {% if timecard %}日次勤怠編集{% else %}日次勤怠作成{% endif %}
        <span class="text-muted">- {{ timesheet.staff }} ({{ timesheet.year }}年{{ timesheet.month }}月)</span>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <div class="row mb-3 align-items-center">
                <label for="{{ form.work_date.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">勤務日 <span class="text-danger">*</span></label>
                <div class="col-sm-2">
                    {{ form.work_date }}
                    {% if form.work_date.errors %}
                        <div class="text-danger">{{ form.work_date.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.work_type.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">勤務区分 <span class="text-danger">*</span></label>
                <div class="col-sm-2">
                    {{ form.work_type }}
                    {% if form.work_type.errors %}
                        <div class="text-danger">{{ form.work_type.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center" id="work-time-pattern-row">
                <label for="{{ form.work_time_pattern_work.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">就業時間パターン</label>
                <div class="col-sm-4">
                    {{ form.work_time_pattern_work }}
                    {% if form.work_time_pattern_work.errors %}
                        <div class="text-danger">{{ form.work_time_pattern_work.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">選択すると出勤時刻・退勤時刻・休憩時間が自動入力されます</small>
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.start_time.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">出勤時刻</label>
                <div class="col-sm-2">
                    {{ form.start_time }}
                    {% if form.start_time.errors %}
                        <div class="text-danger">{{ form.start_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-sm-1">
                    <div class="form-check">
                        {{ form.start_time_next_day }}
                        <label class="form-check-label" for="{{ form.start_time_next_day.id_for_label }}">翌日</label>
                    </div>
                    {% if form.start_time_next_day.errors %}
                        <div class="text-danger">{{ form.start_time_next_day.errors }}</div>
                    {% endif %}
                </div>
                <label for="{{ form.end_time.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">退勤時刻</label>
                <div class="col-sm-2">
                    {{ form.end_time }}
                    {% if form.end_time.errors %}
                        <div class="text-danger">{{ form.end_time.errors }}</div>
                    {% endif %}
                </div>
                <div class="col-sm-1">
                    <div class="form-check">
                        {{ form.end_time_next_day }}
                        <label class="form-check-label" for="{{ form.end_time_next_day.id_for_label }}">翌日</label>
                    </div>
                    {% if form.end_time_next_day.errors %}
                        <div class="text-danger">{{ form.end_time_next_day.errors }}</div>
                    {% endif %}
                </div>

            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.break_minutes.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">休憩（分）</label>
                <div class="col-sm-2">
                    {{ form.break_minutes }}
                    {% if form.break_minutes.errors %}
                        <div class="text-danger">{{ form.break_minutes.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-sm-1">
                </div>

                <label for="{{ form.late_night_break_minutes.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">深夜休憩（分）</label>
                <div class="col-sm-2">
                    {{ form.late_night_break_minutes }}
                    {% if form.late_night_break_minutes.errors %}
                        <div class="text-danger">{{ form.late_night_break_minutes.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.paid_leave_days.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">有給休暇日数</label>
                <div class="col-sm-3">
                    {{ form.paid_leave_days }}
                    {% if form.paid_leave_days.errors %}
                        <div class="text-danger">{{ form.paid_leave_days.errors }}</div>
                    {% endif %}
                    <small class="form-text text-muted">0.5（半休）または1.0（全休）</small>
                </div>
            </div>

            <div class="row mb-3 align-items-center">
                <label for="{{ form.memo.id_for_label }}" class="col-sm-2 col-form-label" style="text-align:right">メモ</label>
                <div class="col-sm-8">
                    {{ form.memo }}
                    {% if form.memo.errors %}
                        <div class="text-danger">{{ form.memo.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 text-start">
                    <button type="submit" class="btn btn-sm btn-primary me-2">{% if timecard %}更新{% else %}作成{% endif %}</button>
                    {% if timesheet.pk %}
                        <a href="{% url 'kintai:timesheet_detail' timesheet.pk %}" class="btn btn-sm btn-secondary">戻る</a>
                    {% else %}
                        <a href="{% url 'kintai:timesheet_preview' timesheet.staff_contract.pk timesheet.target_month|date:'Y-m' %}" class="btn btn-sm btn-secondary">戻る</a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 就業時間パターンデータをJavaScriptで利用可能にする
    const workTimesData = {{ work_times_data_json|safe }};
    
    // 勤務区分の変更に応じて入力欄の表示/非表示を切り替え
    const workTypeSelect = document.getElementById('{{ form.work_type.id_for_label }}');
    const workTimePatternRow = document.getElementById('work-time-pattern-row');
    const workTimePatternSelect = document.getElementById('{{ form.work_time_pattern_work.id_for_label }}');
    const startTimeRow = document.querySelector('label[for="{{ form.start_time.id_for_label }}"]').closest('.row');
    const breakMinutesRow = document.querySelector('label[for="{{ form.break_minutes.id_for_label }}"]').closest('.row');
    const paidLeaveDaysRow = document.querySelector('label[for="{{ form.paid_leave_days.id_for_label }}"]').closest('.row');
    
    const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
    const startTimeNextDayCheckbox = document.getElementById('{{ form.start_time_next_day.id_for_label }}');
    const endTimeInput = document.getElementById('{{ form.end_time.id_for_label }}');
    const endTimeNextDayCheckbox = document.getElementById('{{ form.end_time_next_day.id_for_label }}');
    const breakMinutesInput = document.getElementById('{{ form.break_minutes.id_for_label }}');
    
    function toggleFields() {
        const workType = workTypeSelect.value;
        
        if (workType === '10') {  // 出勤
            workTimePatternRow.style.display = '';
            startTimeRow.style.display = '';
            breakMinutesRow.style.display = '';
            paidLeaveDaysRow.style.display = 'none';
        } else if (workType === '40') {  // 有給休暇
            workTimePatternRow.style.display = 'none';
            startTimeRow.style.display = 'none';
            breakMinutesRow.style.display = 'none';
            paidLeaveDaysRow.style.display = '';
        } else {  // その他
            workTimePatternRow.style.display = 'none';
            startTimeRow.style.display = 'none';
            breakMinutesRow.style.display = 'none';
            paidLeaveDaysRow.style.display = 'none';
        }
    }
    
    // 就業時間パターン選択時の処理
    function applyWorkTimePattern() {
        const selectedId = workTimePatternSelect.value;
        if (!selectedId) return;
        
        const workTime = workTimesData.find(wt => wt.id == selectedId);
        if (!workTime) return;
        
        // 時刻と休憩時間を自動入力
        startTimeInput.value = workTime.start_time;
        endTimeInput.value = workTime.end_time;
        breakMinutesInput.value = workTime.break_minutes;
        
        // 翌日フラグを設定
        startTimeNextDayCheckbox.checked = workTime.start_time_next_day;
        endTimeNextDayCheckbox.checked = workTime.end_time_next_day;
    }
    
    workTypeSelect.addEventListener('change', toggleFields);
    workTimePatternSelect.addEventListener('change', applyWorkTimePattern);
    toggleFields();  // 初期表示
});
</script>
{% endblock %}
