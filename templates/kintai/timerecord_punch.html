{% extends 'common/_base.html' %}
{% load static %}
{% load parameters %}

{% block extra_css %}
<style>
    .punch-container {
        width: 100%;
        margin-top: 1rem;
    }
    .clock-display {
        font-family: 'Roboto Mono', monospace;
        font-size: 4rem;
        font-weight: 700;
        color: #333;
        margin: 0.5rem 0;
    }
    .clock-date {
        font-size: 1.2rem;
        color: #666;
    }
    .status-area {
        margin-bottom: 2rem;
    }
    .status-badge-lg {
        padding: 0.75rem 2.5rem;
        border-radius: 2rem;
        font-weight: 700;
        font-size: 1.25rem;
        display: inline-block;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .action-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    .punch-form {
        display: contents;
    }
    @media (max-width: 576px) {
        .action-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
    }
    .punch-btn {
        height: 140px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        border-radius: 1rem;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .punch-btn i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
    }
    .punch-btn:hover:not(:disabled) {
        transform: translateY(-6px);
        box-shadow: 0 12px 20px rgba(0,0,0,0.15);
    }
    .punch-btn:active:not(:disabled) {
        transform: translateY(0);
    }
    .btn-start { background-color: #28a745; color: white; }
    .btn-start:hover { background-color: #28a745; color: white; outline: 3px solid #1e7e34; outline-offset: -3px; }
    
    .btn-end { background-color: #dc3545; color: white; }
    .btn-end:hover { background-color: #dc3545; color: white; outline: 3px solid #bd2130; outline-offset: -3px; }
    
    .btn-break { background-color: #ffc107; color: #333; }
    .btn-break:hover { background-color: #ffc107; color: #333; outline: 3px solid #d39e00; outline-offset: -3px; }
    
    .btn-resume { background-color: #17a2b8; color: white; }
    .btn-resume:hover { background-color: #17a2b8; color: white; outline: 3px solid #117a8b; outline-offset: -3px; }
    
    .punch-btn:disabled {
        background-color: #e9ecef !important;
        color: #adb5bd !important;
        box-shadow: none !important;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .history-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-top: 2rem;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    .history-table-mini {
        width: 100%;
    }
    .history-table-mini td {
        padding: 1rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .history-table-mini tr:last-child td {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="punch-container">
    <div class="content-box card bg-light mt-2 mb-4" style="max-width: 100%;">
        <div class="card-header d-flex justify-content-between align-items-center">
            勤怠打刻
            <div class="d-flex">
                <a href="{% url 'kintai:timerecord_list' %}" class="btn btn-sm btn-outline-dark">
                    <i class="bi bi-list-ul me-1"></i>打刻履歴
                </a>
            </div>
        </div>
        <div class="card-body text-center p-5">
            <div class="clock-date mb-1">{{ today|date:"Y年m月d日" }} ({{ today|date:"D" }})</div>
            <div class="clock-display" id="current-time">00:00:00</div>

            <div class="status-area">
                <span class="status-badge-lg 
                    {% if status == 'not_started' %}bg-light text-dark border
                    {% elif status == 'working' %}bg-success text-white
                    {% elif status == 'on_break' %}bg-warning text-dark
                    {% elif status == 'finished' %}bg-dark text-white
                    {% endif %}">
                    <i class="bi {% if status == 'not_started' %}bi-dash-circle{% elif status == 'working' %}bi-play-circle{% elif status == 'on_break' %}bi-pause-circle{% elif status == 'finished' %}bi-check-circle{% endif %} me-2"></i>
                    {% if status == 'not_started' %}未出勤
                    {% elif status == 'working' %}勤務中
                    {% elif status == 'on_break' %}休憩中
                    {% elif status == 'finished' %}退勤済み
                    {% endif %}
                </span>
            </div>

            <!-- 契約情報表示 -->
            <div class="contract-info mb-3">
                {% if available_contracts.count == 1 %}
                    <!-- 単一契約の場合 -->
                    <div class="alert alert-info mb-2" style="max-width: 600px; margin: 0 auto;">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <strong>契約情報:</strong> {{ current_contract.contract_name }} 
                        ({{ current_contract.start_date|date:"Y/m/d" }}〜{% if current_contract.end_date %}{{ current_contract.end_date|date:"Y/m/d" }}{% else %}継続中{% endif %})
                    </div>
                {% elif available_contracts.count > 1 %}
                    <!-- 複数契約の場合 -->
                    <div class="alert alert-success mb-2" style="max-width: 600px; margin: 0 auto;">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <strong>契約選択:</strong> {{ available_contracts.count }}件の有効で確認済みの契約があります。出勤時に選択してください。
                    </div>
                    <!-- 契約選択UI -->
                    <div class="contract-selection mb-3" id="contract-selection" style="display: none; max-width: 600px; margin: 0 auto;">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">契約を選択してください</h6>
                            </div>
                            <div class="card-body">
                                {% for contract in available_contracts %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="contract_selection" id="contract_{{ contract.id }}" value="{{ contract.id }}">
                                    <label class="form-check-label" for="contract_{{ contract.id }}">
                                        <strong>{{ contract.contract_name }}</strong><br>
                                        <small class="text-muted">{{ contract.start_date|date:"Y/m/d" }}〜{% if contract.end_date %}{{ contract.end_date|date:"Y/m/d" }}{% else %}継続中{% endif %}</small>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <!-- 契約なしの場合 -->
                    <div class="alert alert-warning mb-2" style="max-width: 600px; margin: 0 auto;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>注意:</strong> {{ today|date:"Y/m/d" }} に有効で確認済みのスタッフ契約がありません。打刻できません。
                    </div>
                {% endif %}
            </div>

            <div class="action-grid">
                {% if available_contracts.count > 0 %}
                    <form action="{% url 'kintai:timerecord_action' %}" method="POST" id="punch-form" class="punch-form">
                        {% csrf_token %}
                        <input type="hidden" name="latitude" id="latitude">
                        <input type="hidden" name="longitude" id="longitude">
                        <input type="hidden" name="contract_id" id="contract_id">
                        
                        <button type="submit" name="action" value="start" class="btn punch-btn btn-start" id="start-btn"
                            {% if status != 'not_started' %}disabled{% endif %}>
                            <i class="bi bi-box-arrow-in-right"></i>
                            出勤
                        </button>
                        
                        <button type="submit" name="action" value="end" class="btn punch-btn btn-end" 
                            {% if status != 'working' %}disabled{% endif %}>
                            <i class="bi bi-box-arrow-left"></i>
                            退勤
                        </button>
                        
                        <button type="submit" name="action" value="break_start" class="btn punch-btn btn-break" 
                            {% if status != 'working' %}disabled{% endif %}>
                            <i class="bi bi-pause-circle"></i>
                            休憩開始
                        </button>
                        
                        <button type="submit" name="action" value="break_end" class="btn punch-btn btn-resume" 
                            {% if status != 'on_break' %}disabled{% endif %}>
                            <i class="bi bi-play-circle"></i>
                            休憩終了
                        </button>
                    </form>
                {% else %}
                    <!-- 契約がない場合はボタンを非表示 -->
                {% endif %}
            </div>

            {% if can_cancel and available_contracts.count > 0 %}
            <div class="mt-2 mb-3">
                <form action="{% url 'kintai:timerecord_action' %}" method="POST" onsubmit="return confirm('直近の打刻を取り消しますか？');">
                    {% csrf_token %}
                    <button type="submit" name="action" value="cancel" class="btn btn-link text-danger text-decoration-none">
                        <i class="bi bi-arrow-counterclockwise"></i> 直近の打刻を取り消す (5分以内)
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    {% if timerecord %}
    <div class="content-box card bg-light mb-4" style="max-width: 100%;">
        <div class="card-header">
            <i class="bi bi-journal-text me-2"></i>本日の記録
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover mt-4" style="border-top: 1px solid #ddd;">
                    <thead>
                        <tr>
                            <th style="width: 20%;">項目</th>
                            <th style="width: 30%;">時刻</th>
                            <th style="width: 30%;">位置 / 詳細</th>
                            <th style="width: 20%;">備考</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 出勤 -->
                        <tr>
                            <td><span class="badge bg-success">出勤</span></td>
                            <td class="fw-bold">{{ timerecord.start_time|date:"H:i:s" }}</td>
                            <td class="small">
                                {% if timerecord.start_latitude %}
                                    {% if timerecord.start_address %}
                                        {{ timerecord.start_address }}
                                    {% else %}
                                        <i class="bi bi-geo-alt"></i> 
                                        {{ timerecord.start_latitude|floatformat:4 }}, {{ timerecord.start_longitude|floatformat:4 }}
                                    {% endif %}
                                    <a href="{% parameter 'GOOGLE_MAPS_URL_BASE' %}{{ timerecord.start_latitude }},{{ timerecord.start_longitude }}" target="_blank" class="ms-1" style="color:green;" title="Google Mapで開く">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>-</td>
                        </tr>

                        <!-- 休憩（時系列順） -->
                        {% for break in timerecord.breaks.all|dictsort:"break_start" %}
                        <tr>
                            <td><span class="badge bg-warning text-dark">休憩 {{ forloop.counter }}</span></td>
                            <td>
                                {{ break.break_start|date:"H:i:s" }} 〜 
                                {% if break.break_end %}
                                    {{ break.break_end|date:"H:i:s" }}
                                {% else %}
                                    <span class="text-danger small">休憩中</span>
                                {% endif %}
                            </td>
                            <td class="small">
                                <div class="mb-1">
                                    {% if break.start_latitude %}
                                        <span class="badge bg-secondary me-1">開始</span>
                                        {% if break.start_address %}
                                            {{ break.start_address }}
                                        {% else %}
                                            <i class="bi bi-geo-alt"></i> 
                                            {{ break.start_latitude|floatformat:4 }}, {{ break.start_longitude|floatformat:4 }}
                                        {% endif %}
                                        <a href="{% parameter 'GOOGLE_MAPS_URL_BASE' %}{{ break.start_latitude }},{{ break.start_longitude }}" target="_blank" class="ms-1" style="color:green;" title="Google Mapで開く">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    {% endif %}
                                </div>
                                {% if break.break_end %}
                                    <div>
                                        {% if break.end_latitude %}
                                            <span class="badge bg-secondary me-1">終了</span>
                                            {% if break.end_address %}
                                                {{ break.end_address }}
                                            {% else %}
                                                <i class="bi bi-geo-alt"></i> 
                                                {{ break.end_latitude|floatformat:4 }}, {{ break.end_longitude|floatformat:4 }}
                                            {% endif %}
                                            <a href="{% parameter 'GOOGLE_MAPS_URL_BASE' %}{{ break.end_latitude }},{{ break.end_longitude }}" target="_blank" class="ms-1" style="color:green;" title="Google Mapで開く">
                                                <i class="bi bi-box-arrow-up-right"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </td>
                            <td class="small">
                                {% if break.break_end %}
                                    {{ break.break_minutes }}分
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        <!-- 退勤 -->
                        {% if timerecord.end_time %}
                        <tr>
                            <td><span class="badge bg-danger">退勤</span></td>
                            <td class="fw-bold">{{ timerecord.end_time|date:"H:i:s" }}</td>
                            <td class="small">
                                {% if timerecord.end_latitude %}
                                    {% if timerecord.end_address %}
                                        {{ timerecord.end_address }}
                                    {% else %}
                                        <i class="bi bi-geo-alt"></i> 
                                        {{ timerecord.end_latitude|floatformat:4 }}, {{ timerecord.end_longitude|floatformat:4 }}
                                    {% endif %}
                                    <a href="{% parameter 'GOOGLE_MAPS_URL_BASE' %}{{ timerecord.end_latitude }},{{ timerecord.end_longitude }}" target="_blank" class="ms-1" style="color:green;" title="Google Mapで開く">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="fw-bold text-primary">実働 {{ timerecord.work_hours_display }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% if not timerecord.end_time and status == 'working' or status == 'on_break' %}
                <div class="text-end px-2">
                    <span class="small text-muted">※退勤打刻をすると、ここに退勤記録が表示されます。</span>
                </div>
            {% endif %}
        </div>
    </div>
{% endif %}
</div>

<script>
    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('current-time').textContent = `${hours}:${minutes}:${seconds}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 打刻ボタン押下時の処理（このタイミングでのみ位置情報を取得）
    const punchForm = document.getElementById('punch-form');
    {% if available_contracts.count > 0 %}
    if (punchForm) {
        punchForm.addEventListener('submit', function(e) {
            const action = e.submitter ? e.submitter.value : null;
            // 取り消し時は位置情報不要
            if (!action || action === 'cancel') return;

            e.preventDefault();
            const btn = e.submitter;

            // 出勤時の契約選択処理
            if (action === 'start') {
                const availableContracts = {{ available_contracts.count }};
                if (availableContracts > 1) {
                    // 複数契約がある場合は選択UIを表示
                    const contractSelection = document.getElementById('contract-selection');
                    if (contractSelection.style.display === 'none') {
                        contractSelection.style.display = 'block';
                        // ボタンを再度有効化
                        document.querySelectorAll('.punch-btn').forEach(b => b.disabled = false);
                        return;
                    }
                    
                    // 契約が選択されているかチェック
                    const selectedContract = document.querySelector('input[name="contract_selection"]:checked');
                    if (!selectedContract) {
                        alert('契約を選択してください。');
                        document.querySelectorAll('.punch-btn').forEach(b => b.disabled = false);
                        return;
                    }
                    
                    // 選択された契約IDをhiddenフィールドに設定
                    document.getElementById('contract_id').value = selectedContract.value;
                }
            }

            // 二重送信防止（ボタンを無効化）
            document.querySelectorAll('.punch-btn').forEach(b => b.disabled = true);

            const finalizeSubmission = () => {
                const hiddenAction = document.createElement('input');
                hiddenAction.type = 'hidden';
                hiddenAction.name = 'action';
                hiddenAction.value = action;
                punchForm.appendChild(hiddenAction);
                punchForm.submit();
            };

            if (navigator.geolocation) {
                // ボタンを押した瞬間に位置情報を取得
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                        finalizeSubmission();
                    },
                    function(error) {
                        let errorMsg = "不明なエラー";
                        switch(error.code) {
                            case 1: errorMsg = "位置情報の利用が許可されていません"; break;
                            case 2: errorMsg = "位置情報を特定できませんでした"; break;
                            case 3: errorMsg = "位置情報の取得がタイムアウトしました"; break;
                        }
                        // ユーザーに確認する
                        if (confirm(`位置情報の取得に失敗しました。\n理由: ${errorMsg}\n\nこのまま位置情報なしで打刻しますか？`)) {
                            finalizeSubmission();
                        } else {
                            // キャンセルした場合はボタンを再度有効化して戻る
                            document.querySelectorAll('.punch-btn').forEach(b => b.disabled = false);
                            btn.innerHTML = originalHtml; // ボタンの表示を元に戻す処理が必要だが、submitterからは取れないので...
                            // 簡易的にリロードを促すか、ボタンの状態のみ戻す
                            // btn自体は直前の処理で書き換えていない（disabledにしただけ）のでOKのはずだが、
                            // もしローディング表示を入れている場合はここで戻す必要がある。
                            // 今回のコードでは btn.innerHTML書き換えはしていないのでdisabled解除だけでOK。
                        }
                    },
                    { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert("お使いのブラウザは位置情報をサポートしていません。");
                finalizeSubmission();
            }
        });
    }
    {% endif %}
</script>
{% endblock %}
