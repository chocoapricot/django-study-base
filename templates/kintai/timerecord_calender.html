{% extends 'common/_base.html' %}
{% load favorite_tags %}

{% block extra_css %}
<style>
    .table-saturday,
    .table-saturday > td {
        background-color: #e6f2ff !important;
    }
    .table-sunday,
    .table-sunday > td {
        background-color: #ffe6e6 !important;
    }
    .text-saturday {
        color: #0066cc !important;
    }
    .text-sunday {
        color: #cc0000 !important;
    }
    /* ホバー時のスタイル */
    .table-hover > .table-saturday:hover,
    .table-hover > .table-saturday:hover > td {
        background-color: #d0e8ff !important;
    }
    .table-hover > .table-sunday:hover,
    .table-hover > .table-sunday:hover > td {
        background-color: #ffdde0 !important;
    }

    /* 通常時はコロンを非表示 */
    .work-hours-cell .work-minutes-separator {
        display: none;
    }

    @media (max-width: 575.98px) { /* Bootstrap XS breakpoint */
        .work-hours-cell .work-hours-unit-hour,
        .work-hours-cell .work-hours-unit-minute {
            display: none; /* 時間と分を非表示 */
        }
        .work-hours-cell .work-minutes-separator {
            display: inline; /* コロンを表示 */
        }
    }

    /* 通常時はコロンを非表示 */
    .break-hours-cell .break-minutes-separator {
        display: none;
    }

    @media (max-width: 575.98px) { /* Bootstrap XS breakpoint */
        .break-hours-cell .break-hours-unit-hour,
        .break-hours-cell .break-hours-unit-minute {
            display: none; /* 時間と分を非表示 */
        }
        .break-hours-cell .break-minutes-separator {
            display: inline; /* コロンを表示 */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-box card bg-light mt-2 mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            勤怠打刻カレンダー
            <span class="text-muted">- {{ staff }}{% favorite_star staff %}</span>
        </div>
    </div>
    <div class="card-body">
        <!-- フィルタ -->
        <form method="get" class="row g-3 mb-4 align-items-end">
            <div class="col-auto">
                <label for="target_month" class="form-label small">対象年月</label>
                <input type="month" name="target_month" id="target_month" class="form-control form-control-sm" value="{{ target_month|date:'Y-m' }}">
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-primary">表示</button>
                <a href="{% url 'kintai:timerecord_calender' %}" class="btn btn-sm btn-secondary">今月</a>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-bordered table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 15%;">日付</th>
                        <th style="width: 15%;" class="text-center">開始時刻</th>
                        <th style="width: 15%;" class="text-center">終了時刻</th>
                        <th style="width: 15%;" class="text-center">休憩合計</th>
                        <th style="width: 15%;" class="text-center">勤務時間</th>
                        <th style="width: 25%;" class="text-center">処理</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in calendar_data %}
                    <tr class="{% if data.weekday == 5 %}table-saturday{% elif data.weekday == 6 or data.is_holiday %}table-sunday{% endif %}">
                        <td class="align-middle {% if data.weekday == 5 %}text-saturday{% elif data.weekday == 6 or data.is_holiday %}text-sunday{% endif %} fw-bold">
                            {{ data.date|date:"m/d" }} ({{ data.date|date:"D" }})
                        </td>
                        <td class="align-middle text-center">
                            {% if data.timerecord and data.timerecord.rounded_start_time %}
                                {{ data.timerecord.rounded_start_time|date:"H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="align-middle text-center">
                            {% if data.timerecord and data.timerecord.rounded_end_time %}
                                {{ data.timerecord.rounded_end_time|date:"H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="align-middle text-center break-hours-cell">
                            {% if data.timerecord and data.timerecord.total_break_minutes > 0 %}
                                <span class="break-hours-value">{{ data.timerecord.break_hours_int }}</span><span class="break-hours-unit-hour">時間</span><span class="break-minutes-separator">:</span><span class="break-minutes-value">{{ data.timerecord.break_minutes_int|stringformat:"02d" }}</span><span class="break-hours-unit-minute">分</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="align-middle text-center work-hours-cell">
                            {% if data.timerecord and data.timerecord.total_work_minutes > 0 %}
                                <span class="work-hours-value">{{ data.timerecord.work_hours_int }}</span><span class="work-hours-unit-hour">時間</span><span class="work-minutes-separator">:</span><span class="work-minutes-value">{{ data.timerecord.work_minutes_int|stringformat:"02d" }}</span><span class="work-hours-unit-minute">分</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>

                        <td class="align-middle text-center">
                            {% if data.timerecord %}
                                <a href="{% url 'kintai:timerecord_update' data.timerecord.pk %}" class="btn btn-sm btn-outline-primary" title="編集">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'kintai:timerecord_detail' data.timerecord.pk %}" class="btn btn-sm btn-outline-secondary ms-1" title="詳細">
                                    <i class="bi bi-eye"></i>
                                </a>
                            {% else %}
                                <a href="{% url 'kintai:timerecord_create' %}?work_date={{ data.date|date:'Y-m-d' }}&staff_contract={{ data.contract.pk }}" class="btn btn-sm btn-outline-success" title="新規登録">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
