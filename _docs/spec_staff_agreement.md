# スタッフ同意機能 仕様書

本文書は、スタッフの同意取得に関する機能の仕様を、アクター（操作主体）の観点から記述したものである。

## 1. 概要

本機能は、スタッフの接続を承認する前に、会社が定めた規約への同意を必須とするための仕組みである。同意プロセスは接続承認フローに組み込まれており、管理者（社内担当者）がスタッフに代わって同意操作を行うことを想定している。

## 2. アクターの定義

-   **社内担当者（管理者）**:
    -   システムのマスターデータを管理する権限を持つ従業員。
    -   同意文言の作成や編集を行う。
-   **社内担当者（承認者）**:
    -   スタッフからの接続申請を承認する権限を持つ従業員。（管理者と同一人物の場合もある）
    -   接続承認プロセスの一環として、同意操作を行う。
-   **スタッフ**:
    -   同意の対象となる従業員。このフローでは、スタッフ自身が直接システム上で同意操作を行うことはない。

---

## 3. ユースケース

### 3.1. 管理者による同意文言の管理

-   **目的**: スタッフに同意を求める規約やポリシーのマスターデータを作成・管理する。
-   **アクター**: 社内担当者（管理者）
-   **フロー**:
    1.  管理者は `マスター管理` 画面 (`master:master_index_list`) にアクセスし、「スタッフ同意文言管理」を選択する。
    2.  `同意文言一覧` 画面 (`master:staff_agreement_list`) で、既存の同意文言を確認したり、「新規作成」ボタンから新しい文言を作成したりする。
    3.  作成画面 (`master:staff_agreement_create`) では、以下の主要な情報を入力する。
        -   **名称**: 同意文言のタイトル（例: 「個人情報保護方針」）。
        -   **文言**: 同意を求める規約の全文。
        -   **法人番号**: この規約が適用される会社の法人番号。システムが自動的に設定する。これにより、企業ごとに異なる同意を求めることが可能になる。
    4.  保存すると、新しい同意文言がマスターデータとして登録される。

### 3.2. 承認者による接続承認時の同意プロセス

-   **目的**: スタッフの接続を承認する前提条件として、未同意の規約への同意を完了させる。
-   **アクター**: 社内担当者（承認者）
-   **トリガー**: 承認者が、まだ必要な同意を完了していないスタッフの接続申請を承認しようとすること。
-   **フロー**:
    1.  承認者が `接続管理` 画面 (`connect:index`) で、あるスタッフの接続申請を「承認」する。
    2.  **システムによるチェック**: システムは、そのスタッフの会社に紐づく有効な同意文言のうち、スタッフがまだ同意していないものがないかを確認する。
    3.  **同意画面への遷移**: 未同意の項目が1つでも存在する場合、システムは承認者を自動的に `同意確認` 画面 (`connect:staff_agree`) にリダイレクトする。承認プロセスはここで一時中断される。
    4.  **代理同意の実行**:
        -   `同意確認` 画面には、未同意の規約の名称と全文が表示される。
        -   承認者は内容を確認し、各項目の横にある「上記の内容に同意します」のチェックボックスをオンにする。
        -   「同意して接続を承認する」ボタンを押下する。
    5.  **同意の記録と承認の再開**:
        -   システムは、チェックされた項目について `apps.connect.models.ConnectStaffAgree` レコードを作成・保存し、誰が（どのメールアドレスのスタッフが）どの規約に同意したかを記録する。
        -   全ての必須同意が完了すると、システムは中断していた接続承認プロセスを自動的に再開し、承認を完了させる。

---

## 4. 関連モデル

-   **`apps.master.models.StaffAgreement`**:
    -   同意文言のマスターデータを保持するモデル。
    -   `name`, `agreement_text`, `corporation_number` などのフィールドを持つ。
-   **`apps.connect.models.ConnectStaffAgree`**:
    -   スタッフの同意状況を記録する中間テーブル。
    -   `email`, `corporation_number`, `staff_agreement` (外部キー), `is_agreed` (ブール値) のフィールドを持つ。
    -   どのスタッフが、どの会社のどの規約に同意したかを管理する。
