# 接続機能 仕様書

本文書は、スタッフおよびクライアント担当者の接続申請と、それに対する承認プロセスに関する機能の仕様を記述したものである。

## 1. アクターの定義

本仕様書で言及されるアクター（操作主体）は以下の通りです。

-   **社内担当者**:
    -   システムの管理・運営を担当する従業員。
    -   スタッフ情報やクライアント情報の管理、接続申請の起票などを行う。
    -   `is_staff` 属性が `True` のユーザー。
-   **スタッフ**:
    -   社内に所属する従業員。システムに接続し、自身のプロフィール情報などを管理する。
-   **クライアント担当者**:
    -   取引先企業の担当者。システムに接続し、限定された情報を閲覧・操作する。
-   **管理者**:
    -   `is_staff` 属性を持ち、より広範な権限を持つ社内担当者。本仕様書では「社内担当者」に含めて記述する。

---

## 2. スタッフ接続フロー

### 2.1. 正常系フロー

#### Step 1: 接続申請の開始（社内担当者）

-   **操作**: 社内担当者が `スタッフ詳細` 画面 (`staff:staff_detail`) を開き、「接続依頼」ボタンを押下する。
-   **システム処理**:
    1.  `apps.staff.views.staff_detail` 内のロジックが実行される。
    2.  対象スタッフのメールアドレスと会社の法人番号をキーに `apps.connect.models.ConnectStaff` モデルのレコードを作成する。ステータスは `pending` (未承認) となる。
    3.  **アカウント有無による分岐**:
        -   **スタッフのユーザーアカウントが既に存在する場合**: 対象アカウントに接続申請の承認に必要な権限 (`connect.view_connectstaff`, `connect.change_connectstaff`) を付与する。
        -   **スタッフのユーザーアカウントが存在しない場合**: 新規登録を促す案内メールを送信する。
    4.  処理が完了すると、社内担当者に「接続申請を送信しました」というメッセージが表示される。

#### Step 2: 接続状態の確認（社内担当者）

-   **操作**: 社内担当者は `スタッフ一覧` および `スタッフ詳細` 画面で、対象スタッフの接続状態を確認できる。
-   **表示**:
    -   `未承認`: 黄色のバッジで「未承認の接続申請あり」と表示される。
    -   `承認済み`: 緑色のバッジで「接続承認済み」と表示される。

#### Step 3: 接続の承認（スタッフ）

-   **操作**: 接続依頼を受けたスタッフは、システムにログインし、`接続管理` 画面 (`connect:index`) から自分宛ての接続申請を「承認」する。
-   **システム処理**:
    1.  `apps.connect.views.connect_staff_approve` が実行される。
    2.  対象の `ConnectStaff` レコードのステータスが `approved` (承認済み) に更新される。
    3.  **プロフィール差分確認**:
        -   承認と同時に、`connect.models.ConnectStaff.approve` メソッドが実行される。
        -   スタッフが事前に `プロフィール` (`apps.profile`) で編集した情報と、マスターデータである `スタッフ` (`apps.staff`) の情報が比較される。
        -   差異が検出された場合、情報の種類（基本プロフィール、マイナンバー、銀行口座など）に応じて、`ProfileRequest`, `MynumberRequest` などの「変更申請レコード」が自動的に作成される。

#### Step 4: プロフィール変更の申請（スタッフ）

-   **操作**: 接続が承認されたスタッフは、`プロフィール` 画面 (`profile:profile_index`) から自身の情報を編集・更新する。
-   **システム処理**:
    -   この時点では、`プロフィール` (`apps.profile`) 内の各モデル (`StaffProfile`, `StaffProfileBank`など) が更新されるだけで、マスターデータ (`apps.staff`) には**まだ反映されない**。
    -   *補足: 変更申請レコード (`ProfileRequest`等) の生成トリガーは、Step 3 の接続承認時です。ユーザーの直感的なフローとしては「プロフィールを更新すると申請が作られる」ように見えますが、正確には「プロフィール更新後に接続が承認されると、その差分が申請になる」という順序です。*

#### Step 5: 変更内容の承認と反映（社内担当者）

-   **操作**:
    1.  社内担当者は `スタッフ一覧` 画面で、プロフィール変更などの申請があるスタッフを確認する（「申請あり」バッジで示される）。
    2.  `スタッフ詳細` 画面に遷移し、保留中の申請（例: 「プロフィール変更申請」）を確認し、「詳細」ボタンを押下する。
    3.  申請内容（変更前と変更後の差分）を確認し、「承認」ボタンを押下する。
-   **システム処理**:
    1.  `apps.staff.views.staff_profile_request_detail` などのビューが実行される。
    2.  `ProfileRequest` などの申請レコードのステータスが `approved` になる。
    3.  申請されていた内容が、マスターデータである `スタッフ` (`apps.staff`) のレコードに反映・上書きされる。

### 2.2. 例外フロー

-   **社内担当者による接続申請の解除**:
    -   社内担当者が `スタッフ詳細` 画面で、申請済みのスタッフに対して再度「接続依頼」ボタン（この時点では解除ボタンとして機能）を押下すると、`ConnectStaff` レコードが削除される。
    -   これにより、スタッフは接続承認ができなくなる。対象スタッフには接続が解除された旨の通知メールが送信される。

-   **スタッフまたは社内担当者による接続承認の解除**:
    -   `接続管理` 画面で、承認済みの接続に対して「未承認に戻す」操作を行うと、`connect.views.connect_staff_unapprove` が実行される。
    -   `ConnectStaff` のステータスが `pending` に戻る。
    -   同時に、その接続承認によって生成された、未処理の変更申請レコード (`ProfileRequest`など) もすべて削除される。

---

## 3. クライアント担当者接続フロー

### 3.1. 正常系フロー

1.  **接続申請の開始（社内担当者）**:
    -   **操作**: 社内担当者が `クライアント担当者詳細` 画面 (`client:client_user_detail`) を開き、「接続依頼」ボタンを押下する。
    -   **システム処理**: 対象担当者のメールアドレスと法人番号をキーに `apps.connect.models.ConnectClient` レコードを作成する (`status='pending'`)。アカウント有無に応じて、担当者に必要な権限が付与される。メール通知は行われない。

2.  **接続の承認（クライアント担当者 or 社内担当者）**:
    -   **操作**: 接続依頼を受けたクライアント担当者、または操作を代行する社内担当者が、`接続管理` 画面から対象の申請を「承認」する。
    -   **システム処理**: `connect.views.connect_client_approve` が実行され、`ConnectClient` のステータスが `approved` に更新される。
    -   *補足: スタッフフローとは異なり、プロフィール情報の差分確認や追加の変更申請プロセスは存在しない。*

### 3.2. 例外フロー

-   **社内担当者による接続申請の解除**:
    -   `クライアント担当者詳細` 画面で再度「接続依頼」ボタンを押下すると、`ConnectClient` レコードが削除され、申請が取り消される。

-   **社内担当者による接続承認の解除**:
    -   `接続管理` 画面で「未承認に戻す」操作を行うと、`ConnectClient` のステータスが `pending` に戻る。
