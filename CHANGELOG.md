# 変更履歴

## 2025-08-04
- **テスト構造の改善**:
    - `apps/system/logs/tests.py`, `apps/system/settings/tests.py`, `apps/system/useradmin/tests.py` を削除し、各アプリケーションの `tests/` ディレクトリにテストファイルを再配置。
- **UI/UX改善**:
    - クライアント詳細画面の編集ボタンのスタイルを統一。
    - ホーム画面のカード背景色を調整。

## 2025-08-04
- **データ管理**:
    - クライアントの部署と担当者のサンプルデータを追加し、`load_sample_data.py` および関連スクリプトを更新。

## 2025-08-04
- **クライアント管理機能の強化**:
    - クライアントモデルに部署（`ClientDepartment`）と担当者（`ClientUser`）モデルを追加。
    - 各モデルのCRUD機能と関連するビュー、フォーム、URL、テンプレートを実装。
    - 部署に有効期間と重複チェック機能を追加。
    - クライアント詳細画面に部署と担当者の一覧を表示。
    - 変更履歴に部署と担当者の操作ログも表示されるように拡張。

## 2025-08-04
- **データ管理**:
    - サンプルデータに会社情報と部署情報を追加し、`load_sample_data.py` および関連スクリプトを更新。
    - `_sample_data/settings.json` を削除。
- **UI/UX改善**:
    - スタッフ一覧画面で、部署コードが設定されていない場合の表示を「-」に変更。

## 2025-08-04
- **スタッフ管理機能の強化**:
    - スタッフモデルに社員番号、入社日、退職日、所属部署コードのフィールドを追加。
    - 入社日と退職日の期間バリデーションを追加。
    - 所属部署を会社情報から取得し、選択肢として表示。
    - スタッフ詳細画面に雇用状況と所属部署名を表示。
    - スタッフ一覧画面に所属部署によるフィルタリング機能を追加。
- **UI/UX改善**:
    - 部署新規作成画面で部署一覧が表示されるように修正。

## 2025-08-04
- **UI/UX改善**:
    - 会社情報関連ページで部署一覧の表示を共通テンプレート `_department_list_table.html` に統一。

## 2025-08-04
- **バリデーション強化**:
    - 会社情報の法人番号に`stdnum`ライブラリを利用したバリデーションチェックを追加。
- **テストの追加**:
    - 法人番号のバリデーションに関するフォームテストを追加。

## 2025-08-04
- **セキュリティ強化**:
    - 会社情報および部署管理機能の各ビューに、Djangoの標準権限（`view_company`, `change_company`など）を適用。
    - 権限を持たないユーザーからのアクセスを制限し、403エラーを返すように設定。
- **テストの追加**:
    - 会社情報および部署管理機能に関する権限テストを追加し、権限を持つユーザーと持たないユーザーのアクセス制御が正しく機能することを確認。

## 2025-08-04 (作業中)
- **認証機能のリファクタリング (django-allauth)**:
    - `django-allauth` を全面的に採用し、メールアドレスベースの認証フロー（ユーザー登録、ログイン、パスワードリセット）を再構築。
    - サインアップ時に氏名の入力を必須とし、利用規約への同意を求めるように変更。
    - パスワードリセットの有効期限を24時間に延長。
    - 認証関連のメール送信時に、送信ログを記録するように`CustomAccountAdapter`を拡張。
    - 関連する設定、URL、テンプレート、テストを全面的に見直し・修正。

## 2025-08-04
- **会社・部署管理機能の改善**:
    - 部署モデルに部署コード、会計コード、表示順のフィールドを追加。
    - 部署一覧を会社詳細ページに統合し、独立した部署一覧ページを削除。
    - 部署の登録・編集・詳細画面に部署一覧を表示し、画面遷移を改善。
- **UI/UXの改善**:
    - 削除確認画面に警告アラートを追加し、誤操作を防止。
    - 各画面のボタンやフォームのレイアウトを調整し、一貫性を向上。
- **ドキュメントの更新**:
    - `README.md`、`product.md`、`structure.md`などの関連ドキュメントを更新。

## 2025-08-04
- **会社情報機能の強化**:
    - 会社詳細画面に部署一覧と変更履歴を表示。
    - 会社情報および部署情報の登録・編集・削除時にログを記録するように変更。
    - 外部API（gBizINFO, zipcloud）と連携し、法人番号からの情報取得および郵便番号からの住所検索機能を追加。
- **UI/UXの改善**:
    - 全体的なレイアウトを調整し、視認性を向上。
    - ボタンのスタイルを統一し、`btn-sm`を適用。
    - フォームのラベルと入力欄の配置を調整。
    - Tooltipを追加し、入力項目の説明を補足。
    - 削除ボタンのスタイルを`btn-dark`に統一。
- **その他**:
    - 部署モデルに住所、電話番号などのフィールドを追加。
    - 変更がない場合は更新しないように修正。

## 2025-08-04
- **部署管理機能の追加**: 会社情報に部署管理機能（CRUD）を追加しました。
- **関連ファイルの追加**: 部署管理機能に関するフォーム、URL、ビュー、テスト、テンプレートを追加・更新しました。

## 2025-08-03
- **テストの修正**: ModuleNotFoundErrorとAssertionErrorを修正し、プロジェクト全体のテストがすべてパスすることを確認。

## 2025-08-03
- **法人番号バリデーションの追加**: クライアントの法人番号フィールドにstdnumライブラリを使用したバリデーションを追加。
- **法人番号バリデーション用ユーティリティとテストの追加**: 法人番号バリデーション用のユーティリティ関数と単体テストを追加。
- **ドキュメント更新**: アプリケーションの主要ドキュメント（README.md, .gemini/GEMINI.md, .kiro/steering/structure.md, .kiro/steering/tech.md）を更新し、システムアプリケーションのリファクタリングと法人番号バリデーションの変更を反映。
- **依存関係の更新**: requirements.txtにpython-stdnumのバージョン指定を追加。

## 2025-08-03
- **システムアプリケーションのリファクタリング**: dropdowns、menu、parametersアプリをsettingsアプリに統合。
- **関連コードの更新**: 統合に伴い、関連するすべてのimport文と参照を更新。
- **ドキュメント更新**: 新しいアプリケーション構造を反映するようにドキュメントを更新。
- **旧アプリケーションの削除**: 古いdropdowns、menu、parametersアプリケーションを削除。

## 2025-08-03
- **データベースリセットスクリプトの最適化**: scriptsフォルダを_scriptsに変更、マイグレーション処理を簡潔化
- **commonアプリマイグレーション問題の根本解決**: 複雑なマイグレーション履歴をクリーンアップ、--fakeオプションを削除。
- **サンプルデータインポートスクリプトの改善**: 不親切な注意メッセージを削除、ユーザー体験を向上。
- **対話型コマンド問題の解決**: createsuperuserを適切に分離、スクリプトの責務を明確化。

## 2025-08-03
- **クライアント連絡履歴サンプルデータ追加**: 30件のサンプルデータを作成。
- **サンプルデータ管理ガイド作成**: データインポート/エクスポート手順を文書化。

## 2025-08-03
- **Django 5.2.4アップデート**: 5.2.1から5.2.4に更新。
- **requirements.txt更新**: pytestを追加、実際の環境と整合。
- **マイグレーション修正**: common_applogテーブル削除の問題を解決。
- **変更管理文書作成**: CHANGELOG.mdとDEPLOYMENT.mdを新規作成。